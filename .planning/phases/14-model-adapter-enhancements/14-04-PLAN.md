---
phase: 14-model-adapter-enhancements
plan: 04
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - backend/mlx_manager/mlx_server/services/structured_output.py
  - backend/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "JSON output is validated against provided JSON Schema"
    - "Invalid JSON returns appropriate error with details"
    - "Schema validation errors include path to failed element"
    - "jsonschema library is added to dependencies"
  artifacts:
    - path: "backend/mlx_manager/mlx_server/services/structured_output.py"
      provides: "StructuredOutputValidator service"
      contains: "class StructuredOutputValidator"
    - path: "backend/pyproject.toml"
      provides: "jsonschema dependency"
      contains: "jsonschema"
  key_links:
    - from: "services/structured_output.py"
      to: "jsonschema"
      via: "validate import"
      pattern: "from jsonschema import"
---

<objective>
Implement structured output validation to ensure model responses conform to user-provided JSON schemas.

Purpose: When users specify response_format with json_schema, the model output must be validated against that schema. Invalid output should return helpful error messages.

Output: StructuredOutputValidator service and jsonschema dependency.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-model-adapter-enhancements/14-RESEARCH.md
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add jsonschema Dependency</name>
  <files>backend/pyproject.toml</files>
  <action>
Add jsonschema to the project dependencies in pyproject.toml.

Add under [project.dependencies]:
- "jsonschema>=4.0.0"

Run uv sync to install the dependency.

Note: jsonschema is the standard library for JSON Schema validation in Python, used by major projects. Version 4.x is stable and well-maintained.
  </action>
  <verify>
```bash
cd /Users/atomasini/Development/mlx-manager/backend
uv sync && python -c "import jsonschema; print(f'jsonschema version: {jsonschema.__version__}')"
```
  </verify>
  <done>
jsonschema>=4.0.0 added to dependencies and successfully installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StructuredOutputValidator Service</name>
  <files>backend/mlx_manager/mlx_server/services/structured_output.py</files>
  <action>
Create StructuredOutputValidator service for JSON Schema validation.

Implement:

1. ValidationResult dataclass:
   - success: bool
   - data: dict | None (parsed JSON if valid)
   - error: str | None (error message if invalid)
   - error_path: str | None (JSON path to failed element)

2. StructuredOutputValidator class:

   a. validate(output: str, schema: dict) -> ValidationResult
      - Parse output as JSON (handle JSONDecodeError)
      - Validate against schema using jsonschema.validate()
      - Return ValidationResult with success=True and data if valid
      - Return ValidationResult with error details if invalid
      - Include error_path from ValidationError.json_path

   b. extract_json(text: str) -> str | None
      - Try to extract JSON from text that may have surrounding content
      - Look for content between { } or [ ]
      - Useful for models that output explanatory text with JSON

   c. validate_and_coerce(output: str, schema: dict) -> ValidationResult
      - Similar to validate() but attempts type coercion first
      - Convert "5" -> 5 for integer fields
      - Convert "true" -> True for boolean fields
      - Use schema types to guide coercion

Reference: 14-RESEARCH.md Pattern 4 and Pitfall 3
  </action>
  <verify>
```bash
cd /Users/atomasini/Development/mlx-manager/backend
python -c "
from mlx_manager.mlx_server.services.structured_output import StructuredOutputValidator, ValidationResult

validator = StructuredOutputValidator()

# Define a simple schema
schema = {
    'type': 'object',
    'properties': {
        'name': {'type': 'string'},
        'age': {'type': 'integer'}
    },
    'required': ['name', 'age']
}

# Test valid JSON
result = validator.validate('{\"name\": \"Alice\", \"age\": 30}', schema)
assert result.success == True
assert result.data == {'name': 'Alice', 'age': 30}

# Test invalid JSON (missing required field)
result2 = validator.validate('{\"name\": \"Bob\"}', schema)
assert result2.success == False
assert 'age' in result2.error

# Test invalid JSON syntax
result3 = validator.validate('not json', schema)
assert result3.success == False
assert 'JSON' in result3.error

print('StructuredOutputValidator works correctly')
"
```
  </verify>
  <done>
StructuredOutputValidator validates JSON against schemas, handles parse errors, and provides detailed error messages with paths.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run Quality Checks</name>
  <files>
backend/mlx_manager/mlx_server/services/structured_output.py
backend/pyproject.toml
  </files>
  <action>
Run quality checks on the new code:

1. ruff check with auto-fix
2. ruff format
3. mypy on the new service file

Fix any issues that arise.
  </action>
  <verify>
```bash
cd /Users/atomasini/Development/mlx-manager/backend
ruff check mlx_manager/mlx_server/services/structured_output.py --fix && \
ruff format mlx_manager/mlx_server/services/structured_output.py && \
mypy mlx_manager/mlx_server/services/structured_output.py
```
  </verify>
  <done>
All quality checks pass for structured_output.py.
  </done>
</task>

</tasks>

<verification>
- [ ] jsonschema>=4.0.0 in pyproject.toml dependencies
- [ ] jsonschema importable after uv sync
- [ ] StructuredOutputValidator.validate() returns ValidationResult
- [ ] Valid JSON passes validation
- [ ] Invalid JSON returns error with path
- [ ] Malformed JSON returns parse error
- [ ] extract_json() finds JSON in mixed content
- [ ] Quality gates pass (ruff, mypy)
</verification>

<success_criteria>
1. jsonschema dependency installed
2. StructuredOutputValidator validates against JSON Schema
3. Validation errors include path to failed element
4. Type coercion available for common type mismatches
5. All quality checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-model-adapter-enhancements/14-04-SUMMARY.md`
</output>
