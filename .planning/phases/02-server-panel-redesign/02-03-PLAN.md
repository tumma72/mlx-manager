---
phase: 02-server-panel-redesign
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - frontend/src/lib/components/servers/MetricGauge.svelte
  - frontend/src/lib/components/servers/ServerTile.svelte
  - frontend/src/lib/components/servers/index.ts
  - frontend/src/routes/servers/+page.svelte
autonomous: false

must_haves:
  truths:
    - "Running server shows memory usage as graphical gauge"
    - "Running server shows CPU usage as graphical gauge"
    - "Running server shows uptime in human-readable format"
    - "Running server has Stop and Restart buttons"
    - "Running server shows profile name and model path"
  artifacts:
    - path: "frontend/src/lib/components/servers/MetricGauge.svelte"
      provides: "Reusable SVG circular gauge"
      min_lines: 40
      contains: "stroke-dasharray"
    - path: "frontend/src/lib/components/servers/ServerTile.svelte"
      provides: "Rich server tile with metrics"
      min_lines: 80
      contains: "MetricGauge"
  key_links:
    - from: "ServerTile.svelte"
      to: "serverStore"
      via: "stop/restart handlers"
      pattern: "serverStore\\.(stop|restart)"
    - from: "ServerTile.svelte"
      to: "MetricGauge.svelte"
      via: "memory_percent and cpu_percent props"
      pattern: "memory_percent|cpu_percent"
---

<objective>
Create rich server tiles with graphical metrics display for running servers.

Purpose: Running servers should be the visual focus of the dashboard, showing real-time performance data (memory, CPU, uptime) in an information-dense, scannable format.

Output: `MetricGauge.svelte` (reusable SVG gauge) and `ServerTile.svelte` (complete server card with metrics and controls).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-panel-redesign/02-RESEARCH.md
@.planning/phases/02-server-panel-redesign/02-01-SUMMARY.md

@frontend/src/lib/api/types.ts
@frontend/src/lib/stores/servers.svelte.ts
@frontend/src/lib/utils/format.ts
@frontend/src/routes/servers/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MetricGauge component</name>
  <files>frontend/src/lib/components/servers/MetricGauge.svelte</files>
  <action>
    Create a reusable SVG circular progress gauge:

    ```svelte
    <script lang="ts">
      interface Props {
        value: number;      // Current value
        max?: number;       // Maximum value (default 100 for percentage)
        label: string;      // Label below value (e.g., "Memory", "CPU")
        unit?: string;      // Unit suffix (e.g., "%", "MB")
        size?: 'sm' | 'md'; // Size variant
        thresholds?: { warning: number; danger: number };
      }

      let {
        value,
        max = 100,
        label,
        unit = '%',
        size = 'md',
        thresholds = { warning: 75, danger: 90 }
      }: Props = $props();

      const percentage = $derived(Math.min(100, Math.max(0, (value / max) * 100)));
      const circumference = 2 * Math.PI * 40; // r=40
      const offset = $derived(circumference - (percentage / 100) * circumference);

      const sizes = { sm: 56, md: 72 };
      const strokeWidths = { sm: 5, md: 6 };

      const colorClass = $derived(
        percentage >= thresholds.danger ? 'text-red-500' :
        percentage >= thresholds.warning ? 'text-yellow-500' :
        'text-green-500'
      );
    </script>

    <div class="relative flex items-center justify-center" style="width: {sizes[size]}px; height: {sizes[size]}px;">
      <svg
        width={sizes[size]}
        height={sizes[size]}
        viewBox="0 0 100 100"
        class="transform -rotate-90"
      >
        <!-- Background circle -->
        <circle
          cx="50" cy="50" r="40"
          stroke="currentColor"
          stroke-width={strokeWidths[size]}
          fill="none"
          class="text-gray-200 dark:text-gray-700"
        />
        <!-- Progress circle -->
        <circle
          cx="50" cy="50" r="40"
          stroke="currentColor"
          stroke-width={strokeWidths[size]}
          fill="none"
          stroke-dasharray={circumference}
          stroke-dashoffset={offset}
          stroke-linecap="round"
          class="{colorClass} transition-all duration-300"
        />
      </svg>
      <div class="absolute text-center">
        <span class="text-sm font-semibold">{value.toFixed(0)}{unit}</span>
        <span class="text-[10px] text-muted-foreground block">{label}</span>
      </div>
    </div>
    ```

    Key behaviors:
    - Green when below warning threshold
    - Yellow when at/above warning threshold
    - Red when at/above danger threshold
    - Smooth transition on value changes
    - Responsive sizes (sm for compact, md for normal)
  </action>
  <verify>cd frontend && npm run check</verify>
  <done>MetricGauge component renders SVG circular progress with color thresholds</done>
</task>

<task type="auto">
  <name>Task 2: Create ServerTile component</name>
  <files>frontend/src/lib/components/servers/ServerTile.svelte</files>
  <action>
    Create a rich server tile showing metrics and controls:

    ```svelte
    <script lang="ts">
      import type { RunningServer } from '$api';
      import { serverStore } from '$stores';
      import { goto } from '$app/navigation';
      import { resolve } from '$app/paths';
      import { formatDuration } from '$lib/utils/format';
      import { Card, Button, Badge } from '$components/ui';
      import { MetricGauge } from '$components/servers';
      import { Square, RotateCw, MessageSquare, Loader2, Clock, Activity } from 'lucide-svelte';

      interface Props {
        server: RunningServer;
      }

      let { server }: Props = $props();

      let stopping = $state(false);
      let restarting = $state(false);

      async function handleStop() {
        stopping = true;
        try {
          await serverStore.stop(server.profile_id);
        } finally {
          stopping = false;
        }
      }

      async function handleRestart() {
        restarting = true;
        try {
          await serverStore.restart(server.profile_id);
        } finally {
          restarting = false;
        }
      }

      async function handleChat() {
        await goto(`${resolve('/chat')}?profile=${server.profile_id}`);
      }
    </script>
    ```

    Template layout (compact card):
    ```
    ┌─────────────────────────────────────────────────────────┐
    │ [Badge: Running]  Profile Name                   [Chat] │
    │ model-path/truncated...                    [Stop][Restart]│
    │                                                         │
    │  ┌──────┐  ┌──────┐                                    │
    │  │ 45%  │  │ 12%  │   Port: 10240                      │
    │  │Memory│  │ CPU  │   Uptime: 2h 15m                   │
    │  └──────┘  └──────┘   PID: 12345                       │
    └─────────────────────────────────────────────────────────┘
    ```

    Styling:
    - Use existing Card component with padding
    - Gauges side by side on left
    - Text stats on right (port, uptime, PID)
    - Action buttons in header row
    - Compact but readable
  </action>
  <verify>cd frontend && npm run check</verify>
  <done>ServerTile component displays running server with gauges and controls</done>
</task>

<task type="auto">
  <name>Task 3: Export components from servers index</name>
  <files>frontend/src/lib/components/servers/index.ts</files>
  <action>
    Update the barrel file to export all server components:

    ```typescript
    export { default as ProfileSelector } from './ProfileSelector.svelte';
    export { default as MetricGauge } from './MetricGauge.svelte';
    export { default as ServerTile } from './ServerTile.svelte';
    ```
  </action>
  <verify>cd frontend && npm run check</verify>
  <done>All server components exported from barrel file</done>
</task>

<task type="auto">
  <name>Task 4: Integrate ServerTile into server page</name>
  <files>frontend/src/routes/servers/+page.svelte</files>
  <action>
    Update the server page to use ServerTile instead of ProfileCard for running servers:

    1. Import ServerTile:
       ```typescript
       import { ProfileSelector, ServerTile } from '$components/servers';
       ```

    2. Remove ProfileCard import if no longer needed

    3. Replace the running profiles loop:
       ```svelte
       {:else}
         <div class="grid gap-4">
           {#each serverStore.servers as server (server.profile_id)}
             <ServerTile {server} />
           {/each}
         </div>
       {/if}
       ```

    4. Update the "Running Servers" section to use serverStore.servers directly
       (ServerTile receives RunningServer, not profile)

    5. Remove runningProfiles derived - use serverStore.servers directly

    Note: ProfileCard may still be needed for error states or starting states.
    Keep it available but use ServerTile for healthy running servers.
  </action>
  <verify>cd frontend && npm run check && npm run lint</verify>
  <done>Server page displays running servers as rich tiles with metrics</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Rich server tiles with graphical memory/CPU gauges and controls</what-built>
  <how-to-verify>
    1. Run: npm run dev (frontend)
    2. Start a server from the dropdown
    3. Wait for server to become healthy
    4. Check the running server tile shows:
       - Profile name and model path
       - Memory gauge (circular, with percentage)
       - CPU gauge (circular, with percentage)
       - Uptime in human format
       - Port and PID
       - Stop and Restart buttons work
       - Chat button navigates to chat
    5. Verify gauges update on polling (every 5s)
    6. Verify color thresholds work (if memory >75%, yellow; >90%, red)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd frontend && npm run check` passes
- [ ] `cd frontend && npm run lint` passes
- [ ] Visual verification approved by user
- [ ] MetricGauge shows correct colors at thresholds
- [ ] ServerTile displays all required information
- [ ] Stop/Restart/Chat buttons work
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- User approved visual layout
- Running servers display as rich tiles with graphical metrics
- All controls (Stop, Restart, Chat) functional
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-panel-redesign/02-03-SUMMARY.md`
</output>
