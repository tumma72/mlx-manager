---
phase: 02-server-panel-redesign
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/stores/servers.svelte.ts
  - frontend/src/lib/components/servers/ServerTile.svelte
  - frontend/src/routes/servers/+page.svelte
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "ServerTile remains mounted during restart operation"
    - "ServerTile shows 'Restarting...' badge when profile is restarting"
    - "After restart completes, tile transitions smoothly back to 'Running' state"
  artifacts:
    - path: "frontend/src/lib/stores/servers.svelte.ts"
      provides: "restartingProfiles SvelteSet and isRestarting() method"
      contains: "restartingProfiles"
    - path: "frontend/src/lib/components/servers/ServerTile.svelte"
      provides: "Restarting badge display when isRestarting is true"
      contains: "Restarting"
    - path: "frontend/src/routes/servers/+page.svelte"
      provides: "Filter that keeps restarting servers in runningServers list"
      contains: "isRestarting"
  key_links:
    - from: "frontend/src/lib/components/servers/ServerTile.svelte"
      to: "serverStore.isRestarting"
      via: "reactive check for restarting state"
      pattern: "serverStore\\.isRestarting"
    - from: "frontend/src/routes/servers/+page.svelte"
      to: "serverStore.isRestarting"
      via: "filter condition excluding restarting from startingOrFailedProfiles"
      pattern: "isRestarting"
---

<objective>
Fix server tile disappearing during restart by keeping ServerTile mounted throughout the restart operation.

Purpose: Addresses UAT gap where tile briefly disappears during restart due to mutually exclusive filter conditions between runningServers and startingOrFailedProfiles lists.

Output: Smooth restart experience where ServerTile shows "Restarting..." badge instead of unmounting.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-server-panel-redesign/02-UAT.md
@frontend/src/lib/stores/servers.svelte.ts
@frontend/src/lib/components/servers/ServerTile.svelte
@frontend/src/routes/servers/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add restartingProfiles state to server store</name>
  <files>frontend/src/lib/stores/servers.svelte.ts</files>
  <action>
Add a new SvelteSet to track profiles currently being restarted:

1. In the HmrState interface (line ~44), add:
   - `restartingProfiles: SvelteSet<number>;`

2. In getOrCreateHmrState() (line ~54), initialize:
   - `restartingProfiles: new SvelteSet<number>(),`

3. In SSR fallback (line ~69), add:
   - `restartingProfiles: new SvelteSet<number>(),`

4. In ServerStore class, add property (after line ~90):
   - `restartingProfiles = hmrState.restartingProfiles;`

5. Modify the restart() method (lines 193-199):
   - Add `this.restartingProfiles.add(profileId);` at the start
   - Do NOT add to startingProfiles during restart (remove line 195)
   - After `await serversApi.restart(profileId);` completes:
     - Remove from restartingProfiles: `this.restartingProfiles.delete(profileId);`
     - Then add to startingProfiles: `this.startingProfiles.add(profileId);`
   - This ensures the tile stays mounted as ServerTile until backend confirms stop

6. Add isRestarting() method (after isStarting method, line ~300):
```typescript
/**
 * Check if a profile is currently restarting.
 */
isRestarting(profileId: number): boolean {
  return this.restartingProfiles.has(profileId);
}
```

7. Update markStartupSuccess() (line ~204) to also clear restartingProfiles:
   - Add `this.restartingProfiles.delete(profileId);`

8. Update markStartupFailed() to also clear restartingProfiles:
   - Add `this.restartingProfiles.delete(profileId);`
  </action>
  <verify>
Run `cd frontend && npm run check` - no TypeScript errors related to new restartingProfiles state.
  </verify>
  <done>
restartingProfiles SvelteSet exists in store, isRestarting() method available, restart() uses restartingProfiles before transitioning to startingProfiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ServerTile to show Restarting badge</name>
  <files>frontend/src/lib/components/servers/ServerTile.svelte</files>
  <action>
Modify ServerTile to display "Restarting..." badge when profile is being restarted:

1. Add a derived state to check if this server is restarting (after line ~17):
```typescript
const isRestarting = $derived(serverStore.isRestarting(server.profile_id));
```

2. Update the Badge in the header section (line ~55) to show appropriate status:
   - Replace `<Badge variant="success" class="shrink-0">Running</Badge>` with conditional rendering:
```svelte
{#if isRestarting}
  <Badge variant="warning" class="shrink-0">Restarting...</Badge>
{:else}
  <Badge variant="success" class="shrink-0">Running</Badge>
{/if}
```

3. Disable the restart button when already restarting (update line ~69):
   - Change `disabled={restarting || stopping}` to `disabled={restarting || stopping || isRestarting}`

4. Optionally disable stop button during restart for cleaner UX:
   - Change `disabled={stopping || restarting}` to `disabled={stopping || restarting || isRestarting}`
  </action>
  <verify>
Run `cd frontend && npm run check` - no TypeScript errors. Visually inspect that Badge import is used (already imported at line 7).
  </verify>
  <done>
ServerTile displays "Restarting..." badge with warning variant when profile is in restartingProfiles set. Buttons disabled during restart.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update server page filters to keep restarting servers in runningServers</name>
  <files>frontend/src/routes/servers/+page.svelte</files>
  <action>
Modify filter logic so restarting profiles stay in runningServers list (shown as ServerTile) rather than moving to startingOrFailedProfiles:

1. Update startingOrFailedProfiles filter (lines 49-53) to exclude restarting profiles:
```typescript
const startingOrFailedProfiles = $derived(
  profileStore.profiles.filter(
    (p) =>
      (serverStore.isStarting(p.id) || serverStore.isFailed(p.id)) &&
      !serverStore.isRestarting(p.id)
  )
);
```

2. Update runningServers filter (lines 56-60) to include restarting servers:
```typescript
const runningServers = $derived(
  serverStore.servers.filter(
    (s) =>
      (!serverStore.isStarting(s.profile_id) && !serverStore.isFailed(s.profile_id)) ||
      serverStore.isRestarting(s.profile_id)
  )
);
```

The logic:
- A restarting profile is EXCLUDED from startingOrFailedProfiles
- A restarting profile is INCLUDED in runningServers (even if isStarting is true)
- This keeps the ServerTile mounted throughout the restart process
- Once restart completes and transitions to startingProfiles, the normal flow takes over
  </action>
  <verify>
Run `cd frontend && npm run check` - no TypeScript errors. Run `cd frontend && npm run lint` - no linting errors.
  </verify>
  <done>
Filter logic updated so restarting servers remain in runningServers list, preventing tile unmount during restart operation.
  </done>
</task>

</tasks>

<verification>
1. Type check: `cd frontend && npm run check` passes
2. Lint check: `cd frontend && npm run lint` passes
3. Unit tests: `cd frontend && npm run test` passes
4. Manual verification (via UAT):
   - Start a server
   - Click restart button on the running server tile
   - Observe: tile should show "Restarting..." badge (yellow/warning)
   - Observe: tile should NOT disappear
   - After restart completes, tile shows "Starting..." then "Running"
</verification>

<success_criteria>
- restartingProfiles SvelteSet tracks restart operations
- ServerTile shows "Restarting..." badge during restart
- Server tile remains visible throughout entire restart cycle
- No TypeScript or lint errors
- Existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-panel-redesign/02-05-SUMMARY.md` documenting the gap closure.
</output>
