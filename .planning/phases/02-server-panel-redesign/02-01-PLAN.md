---
phase: 02-server-panel-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/mlx_manager/types.py
  - backend/mlx_manager/models.py
  - backend/mlx_manager/services/server_manager.py
  - backend/mlx_manager/routers/servers.py
  - frontend/src/lib/api/types.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/servers returns cpu_percent for running servers"
    - "GET /api/servers returns memory_percent for running servers"
    - "GET /api/servers returns uptime_seconds for running servers"
  artifacts:
    - path: "backend/mlx_manager/types.py"
      provides: "Extended ServerStats and RunningServerInfo types"
      contains: "memory_percent"
    - path: "backend/mlx_manager/models.py"
      provides: "Extended RunningServerResponse model"
      contains: "cpu_percent"
    - path: "frontend/src/lib/api/types.ts"
      provides: "Extended RunningServer type"
      contains: "cpu_percent"
  key_links:
    - from: "server_manager.get_server_stats"
      to: "psutil.Process"
      via: "memory_percent and cpu_percent extraction"
      pattern: "cpu_percent|memory_percent"
    - from: "routers/servers.py"
      to: "RunningServerResponse"
      via: "response model with new fields"
      pattern: "cpu_percent.*memory_percent"
---

<objective>
Extend backend API to return additional server metrics for dashboard display.

Purpose: The frontend needs memory percentage, CPU percentage, and accurate uptime for each running server to display graphical gauges in the redesigned server tiles.

Output: Extended `/api/servers` response with `cpu_percent`, `memory_percent`, and improved `uptime_seconds` accuracy.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@backend/mlx_manager/types.py
@backend/mlx_manager/models.py
@backend/mlx_manager/services/server_manager.py
@backend/mlx_manager/routers/servers.py
@frontend/src/lib/api/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend backend types and models</name>
  <files>backend/mlx_manager/types.py, backend/mlx_manager/models.py</files>
  <action>
    1. In `types.py`, add `memory_percent: float` to `ServerStats` TypedDict
    2. In `types.py`, add `memory_percent: float` to `RunningServerInfo` TypedDict
    3. In `models.py`, add to `RunningServerResponse`:
       - `cpu_percent: float = 0.0`
       - `memory_percent: float = 0.0`

    Note: `uptime_seconds` already exists in the response model.
  </action>
  <verify>mypy backend/mlx_manager passes with no new errors</verify>
  <done>Types extended with memory_percent and cpu_percent fields</done>
</task>

<task type="auto">
  <name>Task 2: Update server_manager to calculate extended stats</name>
  <files>backend/mlx_manager/services/server_manager.py</files>
  <action>
    1. In `get_server_stats()`, add `memory_percent` calculation:
       ```python
       memory_info = p.memory_info()
       return ServerStats(
           pid=proc.pid,
           memory_mb=round(memory_info.rss / 1024 / 1024, 2),
           memory_percent=p.memory_percent(),  # NEW
           cpu_percent=p.cpu_percent(),
           status=p.status(),
           create_time=p.create_time(),
       )
       ```

    2. In `get_all_running()`, include memory_percent in the RunningServerInfo:
       ```python
       running.append(
           RunningServerInfo(
               profile_id=profile_id,
               pid=stats["pid"],
               memory_mb=stats["memory_mb"],
               memory_percent=stats["memory_percent"],  # NEW
               cpu_percent=stats["cpu_percent"],
               status=stats["status"],
               create_time=stats["create_time"],
           )
       )
       ```

    Note: psutil's `memory_percent()` returns percentage of total system RAM.
  </action>
  <verify>cd backend && python -c "from mlx_manager.services.server_manager import server_manager; print('OK')"</verify>
  <done>server_manager calculates memory_percent alongside existing stats</done>
</task>

<task type="auto">
  <name>Task 3: Update servers router to include new fields in response</name>
  <files>backend/mlx_manager/routers/servers.py</files>
  <action>
    In `list_running_servers()`, add cpu_percent and memory_percent to the response:

    ```python
    servers.append(
        RunningServerResponse(
            profile_id=profile.id,
            profile_name=profile.name,
            pid=r["pid"],
            port=profile.port,
            health_status=r.get("status", "unknown"),
            uptime_seconds=uptime,
            memory_mb=r.get("memory_mb", 0),
            memory_percent=r.get("memory_percent", 0),  # NEW
            cpu_percent=r.get("cpu_percent", 0),  # NEW
        )
    )
    ```

    The `r` dict comes from `server_manager.get_all_running()` which now includes these fields.
  </action>
  <verify>cd backend && pytest tests/test_servers.py -v</verify>
  <done>API response includes cpu_percent and memory_percent</done>
</task>

<task type="auto">
  <name>Task 4: Update frontend TypeScript types</name>
  <files>frontend/src/lib/api/types.ts</files>
  <action>
    Update the `RunningServer` interface to include the new fields:

    ```typescript
    export interface RunningServer {
      profile_id: number;
      profile_name: string;
      pid: number;
      port: number;
      health_status: string;
      uptime_seconds: number;
      memory_mb: number;
      memory_percent: number;  // NEW
      cpu_percent: number;     // NEW
    }
    ```

    Note: These are already returned by the API, just not typed in frontend.
  </action>
  <verify>cd frontend && npm run check</verify>
  <done>Frontend types match extended API response</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd backend && ruff check . && mypy mlx_manager` passes
- [ ] `cd backend && pytest tests/test_servers.py -v` passes
- [ ] `cd frontend && npm run check` passes
- [ ] Manual: Start a server, hit GET /api/servers, verify response contains cpu_percent and memory_percent
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript or Python type errors
- API response includes cpu_percent, memory_percent, uptime_seconds for running servers
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-panel-redesign/02-01-SUMMARY.md`
</output>
