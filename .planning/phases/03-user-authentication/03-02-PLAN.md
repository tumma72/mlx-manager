---
phase: 03-user-authentication
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/mlx_manager/routers/__init__.py
  - backend/mlx_manager/routers/auth.py
  - backend/mlx_manager/main.py
  - backend/mlx_manager/database.py
autonomous: true

must_haves:
  truths:
    - "First user to register becomes admin and is auto-approved"
    - "Subsequent users register with pending status"
    - "Login returns JWT token for approved users"
    - "Login rejects pending or disabled users with appropriate error"
    - "GET /api/auth/me returns current user info"
    - "Admin can list all users"
    - "Admin can approve, disable, or delete users"
    - "Admin can get count of pending users"
  artifacts:
    - path: "backend/mlx_manager/routers/auth.py"
      provides: "Auth API endpoints"
      exports: ["router"]
    - path: "backend/mlx_manager/main.py"
      provides: "Auth router registration"
      contains: "auth_router"
  key_links:
    - from: "backend/mlx_manager/routers/auth.py"
      to: "backend/mlx_manager/services/auth_service.py"
      via: "hash_password, verify_password, create_access_token imports"
      pattern: "from mlx_manager.services.auth_service import"
    - from: "backend/mlx_manager/routers/auth.py"
      to: "backend/mlx_manager/dependencies.py"
      via: "get_current_user, get_admin_user imports"
      pattern: "from mlx_manager.dependencies import"
---

<objective>
Create the authentication API endpoints: registration, login, current user info, and admin user management.

Purpose: Provide the backend API that frontend will use for all authentication flows.
Output: Complete /api/auth/* endpoints for registration, login, user management.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-user-authentication/03-RESEARCH.md

@backend/mlx_manager/routers/profiles.py (for existing router patterns)
@backend/mlx_manager/main.py
@backend/mlx_manager/database.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth router with registration and login</name>
  <files>backend/mlx_manager/routers/auth.py</files>
  <action>
    Create new file backend/mlx_manager/routers/auth.py:

    1. Imports:
       - from typing import Annotated
       - from datetime import UTC, datetime
       - from fastapi import APIRouter, Depends, HTTPException, status
       - from fastapi.security import OAuth2PasswordRequestForm
       - from sqlmodel import select, func
       - from sqlmodel.ext.asyncio.session import AsyncSession
       - from mlx_manager.database import get_db
       - from mlx_manager.models import User, UserCreate, UserPublic, UserStatus, Token, UserUpdate
       - from mlx_manager.services.auth_service import hash_password, verify_password, create_access_token
       - from mlx_manager.dependencies import get_current_user, get_admin_user

    2. Create router:
       router = APIRouter(prefix="/api/auth", tags=["auth"])

    3. POST /register endpoint (response_model=UserPublic, status_code=201):
       - Accept UserCreate body
       - Check if email already exists -> 409 Conflict "Email already registered"
       - Check if this is first user: SELECT COUNT(*) FROM users
       - If first user: is_admin=True, status=APPROVED
       - Else: is_admin=False, status=PENDING
       - Hash password with hash_password()
       - Create User, add to session, commit, refresh
       - Return user (will serialize as UserPublic)

    4. POST /login endpoint (response_model=Token):
       - Accept OAuth2PasswordRequestForm (form_data.username is email, form_data.password is password)
       - Query user by email
       - If not found or password doesn't verify -> 401 "Incorrect email or password"
       - If user.status == PENDING -> 403 "Account pending approval"
       - If user.status == DISABLED -> 403 "Account disabled"
       - Create access token with {"sub": user.email}
       - Return Token(access_token=token)

    5. GET /me endpoint (response_model=UserPublic):
       - Depends on get_current_user
       - Return current_user (serializes as UserPublic)

    Follow patterns from 03-RESEARCH.md code examples.
  </action>
  <verify>
    cd backend && source .venv/bin/activate
    ruff check mlx_manager/routers/auth.py
    mypy mlx_manager/routers/auth.py
  </verify>
  <done>Auth router has register, login, and me endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Add admin user management endpoints</name>
  <files>backend/mlx_manager/routers/auth.py</files>
  <action>
    Add to existing auth.py:

    1. GET /users endpoint (response_model=list[UserPublic]):
       - Depends on get_admin_user
       - Query all users ordered by created_at desc
       - Return list of users

    2. GET /users/pending/count endpoint:
       - Depends on get_admin_user
       - Query COUNT(*) WHERE status = PENDING
       - Return {"count": N}

    3. PUT /users/{user_id} endpoint (response_model=UserPublic):
       - Depends on get_admin_user
       - Accept UserUpdate body (email, is_admin, status - all optional)
       - Get user by ID or 404
       - Prevent admin from demoting self if they're the only admin:
         If updating is_admin to False and user_id == admin.id:
           Count admins, if count == 1 -> 400 "Cannot remove last admin"
       - Update provided fields
       - If status changed to APPROVED: set approved_at=now, approved_by=admin.id
       - Commit and return updated user

    4. DELETE /users/{user_id} endpoint:
       - Depends on get_admin_user
       - Get user by ID or 404
       - Prevent admin from deleting self if only admin:
         If user_id == admin.id: Count admins, if count == 1 -> 400 "Cannot delete last admin"
       - Delete user, commit
       - Return 204 No Content

    5. POST /users/{user_id}/reset-password endpoint:
       - Depends on get_admin_user
       - Accept body: {"password": str}
       - Get user by ID or 404
       - Hash new password and update user.hashed_password
       - Commit
       - Return {"message": "Password reset successfully"}
  </action>
  <verify>
    cd backend && source .venv/bin/activate
    ruff check mlx_manager/routers/auth.py
    mypy mlx_manager/routers/auth.py
  </verify>
  <done>Admin endpoints for listing users, approving, updating, deleting, and password reset</done>
</task>

<task type="auto">
  <name>Task 3: Register auth router and update database init</name>
  <files>
    backend/mlx_manager/routers/__init__.py
    backend/mlx_manager/main.py
    backend/mlx_manager/database.py
  </files>
  <action>
    1. Update routers/__init__.py:
       - Add: from mlx_manager.routers.auth import router as auth_router
       - Add auth_router to __all__ list

    2. Update main.py:
       - Add auth_router to imports from mlx_manager.routers
       - Add: app.include_router(auth_router) after other router includes

    3. Update database.py init_db():
       - Ensure User table is created (SQLModel.metadata.create_all should handle this automatically since User is imported via models)
       - Import User in database.py if needed to ensure it's registered with SQLModel metadata

    4. Run database migration manually for existing databases:
       The User table will be created automatically on first run via init_db.
       For existing installations, the table will be created on next app start.
  </action>
  <verify>
    cd backend && source .venv/bin/activate
    ruff check mlx_manager/routers/__init__.py mlx_manager/main.py mlx_manager/database.py
    mypy mlx_manager/routers/__init__.py mlx_manager/main.py mlx_manager/database.py
    python -c "from mlx_manager.routers import auth_router; print('Auth router imported OK')"
  </verify>
  <done>Auth router registered in app, database will create users table on startup</done>
</task>

</tasks>

<verification>
All checks pass:
- ruff check passes for all modified files
- mypy passes for all modified files
- Auth router can be imported
- Server starts without errors: cd backend && uvicorn mlx_manager.main:app --port 10242 (then Ctrl+C)
</verification>

<success_criteria>
1. POST /api/auth/register creates users (first is admin, rest pending)
2. POST /api/auth/login returns JWT for approved users
3. GET /api/auth/me returns current user info
4. GET /api/auth/users lists all users (admin only)
5. GET /api/auth/users/pending/count returns pending count (admin only)
6. PUT /api/auth/users/{id} updates user (admin only)
7. DELETE /api/auth/users/{id} deletes user (admin only)
8. POST /api/auth/users/{id}/reset-password resets password (admin only)
9. All lint and type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-authentication/03-02-SUMMARY.md`
</output>
