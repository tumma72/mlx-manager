---
phase: 03-user-authentication
plan: 05
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - frontend/src/routes/(protected)/users/+page.svelte
  - frontend/src/lib/components/layout/Navbar.svelte
autonomous: true

must_haves:
  truths:
    - "Admin can see /users page in navigation"
    - "Non-admin users do not see /users nav link"
    - "Admin sees badge with pending user count (if > 0)"
    - "Admin can view list of all users on /users page"
    - "Admin can approve pending users"
    - "Admin can disable/enable users"
    - "Admin can delete users (with protection for last admin)"
    - "Admin can reset user passwords"
    - "Admin can promote users to admin"
  artifacts:
    - path: "frontend/src/routes/(protected)/users/+page.svelte"
      provides: "Admin user management UI"
      min_lines: 100
    - path: "frontend/src/lib/components/layout/Navbar.svelte"
      provides: "Admin-only Users link with badge"
      contains: "users"
  key_links:
    - from: "frontend/src/lib/components/layout/Navbar.svelte"
      to: "frontend/src/lib/stores/auth.svelte.ts"
      via: "authStore.isAdmin check"
      pattern: "authStore\\.isAdmin"
    - from: "frontend/src/routes/(protected)/users/+page.svelte"
      to: "frontend/src/lib/api/client.ts"
      via: "auth.listUsers, auth.updateUser, etc"
      pattern: "auth\\.(listUsers|updateUser|deleteUser)"
---

<objective>
Create the admin user management page and add the Users link with pending badge to the navigation.

Purpose: Enable admins to manage users (approve, disable, delete, reset passwords, promote to admin).
Output: /users page with full user management, nav link with pending badge (admin only).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-user-authentication/03-RESEARCH.md

@frontend/src/lib/components/layout/Navbar.svelte
@frontend/src/lib/api/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin user management page</name>
  <files>frontend/src/routes/(protected)/users/+page.svelte</files>
  <action>
    Create frontend/src/routes/(protected)/users/+page.svelte:

    1. Guard: Check authStore.isAdmin on mount, redirect to "/" if not admin

    2. State:
       - users: User[] (loaded from API)
       - loading: boolean
       - error: string | null
       - actionInProgress: number | null (user ID being acted upon)
       - resetPasswordModal: { userId: number; email: string } | null
       - newPassword: string

    3. Load users on mount:
       - Call auth.listUsers()
       - Sort: pending first, then by created_at desc

    4. User list table with columns:
       - Email
       - Status (badge: pending=yellow, approved=green, disabled=red)
       - Role (Admin badge if is_admin)
       - Created
       - Actions

    5. Actions per user (dropdown or button group):
       - If pending: "Approve" button -> auth.updateUser(id, { status: "approved" })
       - If approved: "Disable" button -> auth.updateUser(id, { status: "disabled" })
       - If disabled: "Enable" button -> auth.updateUser(id, { status: "approved" })
       - If not admin: "Make Admin" button -> auth.updateUser(id, { is_admin: true })
       - If admin (and not self): "Remove Admin" button -> auth.updateUser(id, { is_admin: false })
       - "Reset Password" button -> opens modal
       - "Delete" button -> confirm dialog, then auth.deleteUser(id)

    6. Self-protection:
       - Don't show Delete button on current user if they're the only admin
       - Don't show Remove Admin on self if only admin
       - Show tooltip explaining why action is disabled

    7. Reset Password Modal:
       - Input for new password (min 8 chars)
       - Submit calls auth.resetPassword(userId, newPassword)
       - Close on success, show error on failure

    8. Styling:
       - Use existing Tailwind patterns from other pages
       - Card layout with table inside
       - Status badges with appropriate colors
       - Loading spinner while fetching
       - Error alert if API fails

    9. Refresh list after any action
  </action>
  <verify>
    cd frontend && npm run check
  </verify>
  <done>Users page exists with full user management functionality</done>
</task>

<task type="auto">
  <name>Task 2: Add Users link with pending badge to Navbar</name>
  <files>frontend/src/lib/components/layout/Navbar.svelte</files>
  <action>
    Update frontend/src/lib/components/layout/Navbar.svelte:

    1. Import authStore:
       import { authStore } from '$lib/stores';

    2. Import auth API:
       import { auth } from '$lib/api/client';

    3. Add state for pending count:
       let pendingCount = $state(0);

    4. Fetch pending count on mount (only if admin):
       ```typescript
       onMount(() => {
         if (authStore.isAdmin) {
           loadPendingCount();
           // Optionally poll every 30s
           const interval = setInterval(loadPendingCount, 30000);
           return () => clearInterval(interval);
         }
       });

       async function loadPendingCount() {
         try {
           const { count } = await auth.getPendingCount();
           pendingCount = count;
         } catch {
           // Ignore errors - badge is not critical
         }
       }
       ```

    5. Add Users nav link (only visible to admins):
       After existing nav links, add:
       ```svelte
       {#if authStore.isAdmin}
         <a
           href="/users"
           class="..."
           class:active={$page.url.pathname === '/users'}
         >
           Users
           {#if pendingCount > 0}
             <span class="ml-1 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold leading-none text-white bg-red-500 rounded-full">
               {pendingCount}
             </span>
           {/if}
         </a>
       {/if}
       ```

    6. Add Logout link/button:
       ```svelte
       <button
         onclick={() => {
           authStore.clearAuth();
           window.location.href = '/login';
         }}
         class="text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white"
       >
         Logout
       </button>
       ```

    7. Show current user email in nav (optional, nice-to-have):
       ```svelte
       {#if authStore.user}
         <span class="text-sm text-gray-500 dark:text-gray-400">
           {authStore.user.email}
         </span>
       {/if}
       ```

    Ensure the Navbar only renders these auth-related elements when authStore.isAuthenticated is true.
  </action>
  <verify>
    cd frontend && npm run check && npm run lint
  </verify>
  <done>Navbar shows Users link with pending badge for admins, has logout button</done>
</task>

</tasks>

<verification>
All checks pass:
- npm run check passes
- npm run lint passes
- Users page renders for admin users
- Navbar shows Users link only for admins
- Pending badge displays when count > 0
</verification>

<success_criteria>
1. /users page exists with user list and management actions
2. Admins can approve, disable, delete users and reset passwords
3. Admins can promote/demote other users to admin
4. Self-protection prevents removing last admin
5. Navbar shows Users link with pending badge (admin only)
6. Navbar has logout button
7. All lint and type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-authentication/03-05-SUMMARY.md`
</output>
