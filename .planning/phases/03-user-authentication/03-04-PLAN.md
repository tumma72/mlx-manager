---
phase: 03-user-authentication
plan: 04
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - frontend/src/routes/(public)/+layout.ts
  - frontend/src/routes/(public)/+layout.svelte
  - frontend/src/routes/(public)/login/+page.svelte
  - frontend/src/routes/(protected)/+layout.ts
  - frontend/src/routes/(protected)/+layout.svelte
  - frontend/src/routes/(protected)/+page.svelte
  - frontend/src/routes/(protected)/models/+page.svelte
  - frontend/src/routes/(protected)/servers/+page.svelte
  - frontend/src/routes/(protected)/chat/+page.svelte
  - frontend/src/routes/(protected)/profiles/+page.svelte
  - frontend/src/routes/(protected)/profiles/new/+page.svelte
  - frontend/src/routes/(protected)/profiles/[id]/+page.svelte
  - frontend/src/routes/(protected)/profiles/[id]/edit/+page.svelte
  - frontend/src/routes/+layout.svelte
  - frontend/src/routes/+page.svelte
autonomous: true

must_haves:
  truths:
    - "Unauthenticated users are redirected to /login"
    - "Login page accepts email and password"
    - "Login page shows registration form for new users"
    - "Successful login redirects to home page"
    - "Pending approval shows appropriate message"
    - "All existing pages are protected behind auth"
  artifacts:
    - path: "frontend/src/routes/(public)/login/+page.svelte"
      provides: "Login and registration UI"
      min_lines: 50
    - path: "frontend/src/routes/(protected)/+layout.ts"
      provides: "Auth guard for protected routes"
      contains: "redirect"
  key_links:
    - from: "frontend/src/routes/(protected)/+layout.ts"
      to: "frontend/src/lib/stores/auth.svelte.ts"
      via: "authStore check"
      pattern: "authStore"
    - from: "frontend/src/routes/(public)/login/+page.svelte"
      to: "frontend/src/lib/api/client.ts"
      via: "auth.login and auth.register calls"
      pattern: "auth\\.(login|register)"
---

<objective>
Create the login/register page and restructure routes into (public) and (protected) groups with proper auth guards.

Purpose: Enable users to authenticate and protect all app pages from unauthorized access.
Output: Login page, route restructuring with auth guards, all existing pages protected.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-user-authentication/03-RESEARCH.md

@frontend/src/routes/+layout.svelte
@frontend/src/routes/+page.svelte
@frontend/src/lib/components/layout/Navbar.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create public route group with login page</name>
  <files>
    frontend/src/routes/(public)/+layout.ts
    frontend/src/routes/(public)/+layout.svelte
    frontend/src/routes/(public)/login/+page.svelte
  </files>
  <action>
    1. Create frontend/src/routes/(public)/+layout.ts:
       ```typescript
       // Public routes - no auth required, ssr disabled for SPA
       export const ssr = false;
       export const prerender = false;
       ```

    2. Create frontend/src/routes/(public)/+layout.svelte:
       ```svelte
       <script lang="ts">
         import '../../app.css';
         let { children } = $props();
       </script>

       <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
         {@render children()}
       </div>
       ```

    3. Create frontend/src/routes/(public)/login/+page.svelte:
       - State: mode ('login' | 'register'), email, password, loading, error, success (for pending message)
       - Form with email input, password input (min 8 chars)
       - Toggle between login and register modes
       - On login submit:
         - Call auth.login(email, password)
         - On success: Call auth.me() to get user, authStore.setAuth(token, user), redirect to "/"
         - On error: Show error message, handle 403 for pending/disabled
       - On register submit:
         - Call auth.register({ email, password })
         - If user.status === "approved": auto-login (call login flow)
         - If user.status === "pending": Show success message "Registration submitted. Please wait for admin approval."
       - Style with Tailwind: centered card, form inputs, buttons matching existing UI patterns
       - Show password requirements hint on register mode
  </action>
  <verify>
    cd frontend && npm run check
    ls -la frontend/src/routes/\(public\)/login/
  </verify>
  <done>Public route group exists with login/register page</done>
</task>

<task type="auto">
  <name>Task 2: Create protected route group and move existing pages</name>
  <files>
    frontend/src/routes/(protected)/+layout.ts
    frontend/src/routes/(protected)/+layout.svelte
    frontend/src/routes/(protected)/+page.svelte
    frontend/src/routes/(protected)/models/+page.svelte
    frontend/src/routes/(protected)/servers/+page.svelte
    frontend/src/routes/(protected)/chat/+page.svelte
    frontend/src/routes/(protected)/profiles/+page.svelte
    frontend/src/routes/(protected)/profiles/new/+page.svelte
    frontend/src/routes/(protected)/profiles/[id]/+page.svelte
    frontend/src/routes/(protected)/profiles/[id]/edit/+page.svelte
  </files>
  <action>
    1. Create frontend/src/routes/(protected)/+layout.ts:
       ```typescript
       import { redirect } from '@sveltejs/kit';
       import { authStore } from '$lib/stores';
       import { auth } from '$lib/api/client';

       export const ssr = false;
       export const prerender = false;

       export async function load() {
         // Initialize auth store from localStorage if not done
         if (typeof window !== 'undefined' && !authStore.isAuthenticated) {
           authStore.initialize();
         }

         // Check authentication
         if (!authStore.isAuthenticated) {
           throw redirect(302, '/login');
         }

         // Validate token with backend
         try {
           const user = await auth.me();
           // Update stored user in case it changed (admin status, etc)
           authStore.setAuth(authStore.token!, user);
           return { user };
         } catch {
           // Token invalid - clear and redirect
           authStore.clearAuth();
           throw redirect(302, '/login');
         }
       }
       ```

    2. Create frontend/src/routes/(protected)/+layout.svelte:
       Move content from existing frontend/src/routes/+layout.svelte here:
       - Import app.css (use relative path '../../app.css')
       - Import stores and components
       - Keep onMount with polling setup
       - Keep the min-h-screen wrapper with Navbar and main content

    3. Move existing pages into (protected) group:
       - Move frontend/src/routes/+page.svelte to frontend/src/routes/(protected)/+page.svelte
       - Move frontend/src/routes/models/ to frontend/src/routes/(protected)/models/
       - Move frontend/src/routes/servers/ to frontend/src/routes/(protected)/servers/
       - Move frontend/src/routes/chat/ to frontend/src/routes/(protected)/chat/
       - Move frontend/src/routes/profiles/ to frontend/src/routes/(protected)/profiles/

       Use shell commands: mv source destination

    4. Update the root layout (frontend/src/routes/+layout.svelte):
       Simplify to just render children (route groups handle their own layout):
       ```svelte
       <script lang="ts">
         let { children } = $props();
       </script>

       {@render children()}
       ```

    5. Remove root +page.svelte or create redirect:
       The old frontend/src/routes/+page.svelte should be removed (it's now in protected).
       The root will now just render the layout which renders children.
  </action>
  <verify>
    cd frontend && npm run check
    ls -la frontend/src/routes/\(protected\)/
    ls -la frontend/src/routes/\(protected\)/models/
    ls -la frontend/src/routes/\(protected\)/servers/
  </verify>
  <done>Protected route group exists with auth guard, all existing pages moved inside</done>
</task>

<task type="auto">
  <name>Task 3: Update auth store with initialize method and fix imports</name>
  <files>
    frontend/src/lib/stores/auth.svelte.ts
  </files>
  <action>
    Update auth store to ensure initialize() method works correctly:

    1. Add initialize() method if not present:
       ```typescript
       initialize() {
         if (typeof window === 'undefined') return;

         const savedToken = localStorage.getItem(TOKEN_KEY);
         const savedUser = localStorage.getItem(USER_KEY);

         if (savedToken && savedUser) {
           try {
             token = savedToken;
             user = JSON.parse(savedUser);
           } catch {
             // Invalid stored data - clear it
             localStorage.removeItem(TOKEN_KEY);
             localStorage.removeItem(USER_KEY);
           }
         }
         loading = false;
       }
       ```

    2. Ensure the store initializes automatically on creation (client-side):
       Call initialize() immediately if window exists (in the createAuthStore function body).

    3. Export loading state getter:
       get loading() { return loading; }

    This ensures the auth store is ready before route guards check authentication.
  </action>
  <verify>
    cd frontend && npm run check
  </verify>
  <done>Auth store has working initialize method, loads from localStorage on client</done>
</task>

</tasks>

<verification>
All checks pass:
- npm run check passes
- Route groups exist: (public) and (protected)
- Login page renders without errors
- Protected layout has auth guard
- All existing pages moved to (protected) group
</verification>

<success_criteria>
1. /login page exists with login and registration forms
2. (protected) route group has auth guard that redirects to /login
3. All existing pages (models, servers, chat, profiles) are inside (protected)
4. Root layout simplified to just render children
5. Auth store initializes from localStorage
6. All lint and type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-authentication/03-04-SUMMARY.md`
</output>
