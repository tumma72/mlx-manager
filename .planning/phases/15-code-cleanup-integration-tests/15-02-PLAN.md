---
phase: 15-code-cleanup-integration-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/mlx_manager/database.py
  - backend/mlx_manager/mlx_server/models/adapters/qwen.py
  - backend/mlx_manager/routers/chat.py
  - backend/mlx_manager/mlx_server/services/vision.py
autonomous: true

must_haves:
  truths:
    - "Database migration adds api_type and name columns to cloud_credentials"
    - "Qwen adapter handles all enable_thinking exceptions gracefully"
    - "Streaming token logging is at DEBUG level"
    - "Vision models load without processor attribute errors"
  artifacts:
    - path: "backend/mlx_manager/database.py"
      provides: "migrate_schema() with cloud_credentials columns"
      contains: "cloud_credentials.*api_type"
    - path: "backend/mlx_manager/mlx_server/models/adapters/qwen.py"
      provides: "apply_chat_template with robust exception handling"
      contains: "except.*TypeError.*ValueError.*KeyError"
    - path: "backend/mlx_manager/routers/chat.py"
      provides: "Token logging at DEBUG level"
      contains: "logger.debug"
  key_links:
    - from: "database.py migrate_schema"
      to: "cloud_credentials table"
      via: "PRAGMA table_info check + ALTER TABLE"
      pattern: "ALTER TABLE cloud_credentials ADD COLUMN"
---

<objective>
Fix critical infrastructure bugs discovered during Phase 14 UAT.

Purpose: UAT was blocked by several bugs:
1. Database missing api_type/name columns for cloud_credentials (breaks provider config)
2. Qwen adapter only catches TypeError for enable_thinking (other exceptions crash)
3. Streaming logs every token at INFO level (floods logs)
4. Vision processor attribute access broken

Output: All blocker bugs fixed, UAT can resume.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-model-adapter-enhancements/14-UAT.md

@backend/mlx_manager/database.py
@backend/mlx_manager/models.py
@backend/mlx_manager/mlx_server/models/adapters/qwen.py
@backend/mlx_manager/routers/chat.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add database migration for CloudCredential columns</name>
  <files>backend/mlx_manager/database.py</files>
  <action>
    Add migration entries to migrate_schema() function for cloud_credentials table:

    1. Locate the `migrations` list in migrate_schema()

    2. Add two new migration tuples:
       ```python
       ("cloud_credentials", "api_type", "TEXT", "'openai'"),
       ("cloud_credentials", "name", "TEXT", "''"),
       ```

    Notes:
    - Default 'openai' for api_type provides backward compatibility with existing rows
    - Default '' for name allows existing credentials to work without a name
    - The existing PRAGMA-based migration pattern handles this safely

    3. Migration should be idempotent - only adds columns if they don't exist
  </action>
  <verify>
    ```bash
    # Start fresh database and verify columns exist
    cd backend && source .venv/bin/activate
    rm -f ~/.mlx-manager/test-migration.db
    MLX_MANAGER_DATABASE_PATH=~/.mlx-manager/test-migration.db python -c "
    import asyncio
    from mlx_manager.database import init_db
    asyncio.run(init_db())
    print('Migration successful')
    "
    # Check columns exist
    sqlite3 ~/.mlx-manager/test-migration.db "PRAGMA table_info(cloud_credentials);" | grep -E "api_type|name"
    ```
  </verify>
  <done>Database migration adds api_type (DEFAULT 'openai') and name (DEFAULT '') columns to cloud_credentials table</done>
</task>

<task type="auto">
  <name>Task 2: Fix Qwen adapter exception handling and logging levels</name>
  <files>
    backend/mlx_manager/mlx_server/models/adapters/qwen.py
    backend/mlx_manager/routers/chat.py
  </files>
  <action>
    1. In qwen.py, update apply_chat_template exception handling:
       - Current: `except TypeError as e:`
       - Change to: `except (TypeError, ValueError, KeyError, AttributeError) as e:`
       - This handles all ways tokenizers can reject enable_thinking parameter:
         - TypeError: unexpected keyword argument
         - ValueError: invalid parameter value
         - KeyError: template lookup fails
         - AttributeError: tokenizer missing method

    2. In qwen.py, change logging level for enable_thinking fallback:
       - Current: `logger.warning(f"Tokenizer doesn't support enable_thinking: {e}")`
       - Change to: `logger.debug(f"Tokenizer doesn't support enable_thinking, falling back: {e}")`
       - Rationale: This is expected behavior for older tokenizers, not a warning

    3. In chat.py, fix excessive streaming logging:
       - Find: `logger.info(f"First content starts with: {repr(preview)}")`
       - Change to: `logger.debug(f"First content starts with: {repr(preview)}")`
       - Rationale: Token-level details should be DEBUG, not INFO

    4. Audit chat.py for any other INFO logs that should be DEBUG:
       - Per-token logging -> DEBUG
       - Request start/end -> INFO
       - Errors -> WARNING or ERROR
  </action>
  <verify>
    ```bash
    cd backend && source .venv/bin/activate
    # Check exception handling in qwen.py
    grep -A2 "except.*TypeError" mlx_manager/mlx_server/models/adapters/qwen.py
    # Check logging level in chat.py
    grep "First content starts" mlx_manager/routers/chat.py | grep -v "debug"
    # Should return empty (all should be debug now)
    ```
  </verify>
  <done>Qwen adapter catches TypeError, ValueError, KeyError, AttributeError; streaming logs at DEBUG level</done>
</task>

<task type="auto">
  <name>Task 3: Fix vision processor attribute access</name>
  <files>backend/mlx_manager/mlx_server/services/vision.py</files>
  <action>
    1. Read vision.py to understand current processor handling

    2. The error is: "processor does not have 'chat_template' or 'tokenizer' attribute"
       This indicates vision.py is directly accessing processor.chat_template or processor.tokenizer
       when it should use getattr() pattern

    3. Find all processor attribute accesses and update:
       - Before: `processor.tokenizer` or `processor.chat_template`
       - After: `getattr(processor, 'tokenizer', processor)` or `getattr(processor, 'chat_template', None)`

    4. Common pattern for processor/tokenizer access:
       ```python
       # Get actual tokenizer (Processor wraps tokenizer, regular tokenizer is itself)
       actual_tokenizer = getattr(processor, 'tokenizer', processor)
       ```

    5. Ensure all attribute accesses handle both:
       - Processor objects (from mlx-vlm) - have nested tokenizer
       - Direct tokenizer objects - are the tokenizer

    6. Run vision-related tests to verify fix
  </action>
  <verify>
    ```bash
    cd backend && source .venv/bin/activate
    # Check for direct processor.tokenizer access without getattr
    grep -n "processor\\.tokenizer" mlx_manager/mlx_server/services/vision.py | grep -v getattr
    # Check for direct processor.chat_template access without getattr
    grep -n "processor\\.chat_template" mlx_manager/mlx_server/services/vision.py | grep -v getattr
    # Both should return empty (all access uses getattr)

    # Run related tests
    pytest tests/mlx_server/test_vision*.py -v
    ```
  </verify>
  <done>Vision processor attribute access uses getattr() pattern consistently, works with both Processor and Tokenizer objects</done>
</task>

</tasks>

<verification>
1. Database migration works:
   ```bash
   sqlite3 ~/.mlx-manager/mlx-manager.db "PRAGMA table_info(cloud_credentials);" | grep -E "api_type|name"
   ```

2. Qwen exception handling is robust:
   ```bash
   grep -A1 "except.*TypeError" backend/mlx_manager/mlx_server/models/adapters/qwen.py
   # Should show: except (TypeError, ValueError, KeyError, AttributeError)
   ```

3. Streaming logging is DEBUG:
   ```bash
   grep "First content starts" backend/mlx_manager/routers/chat.py
   # Should show: logger.debug
   ```

4. Vision processor uses getattr:
   ```bash
   grep -c "getattr.*processor" backend/mlx_manager/mlx_server/services/vision.py
   # Should show count > 0
   ```

5. All tests pass:
   ```bash
   cd backend && pytest -v
   ```
</verification>

<success_criteria>
- Database migration adds api_type and name columns with appropriate defaults
- Qwen adapter catches TypeError, ValueError, KeyError, AttributeError for enable_thinking
- chat.py token logging changed from INFO to DEBUG
- Vision processor attribute access works with both Processor and Tokenizer objects
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-code-cleanup-integration-tests/15-02-SUMMARY.md`
</output>
