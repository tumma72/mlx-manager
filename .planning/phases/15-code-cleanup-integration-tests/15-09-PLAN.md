---
task: 15-09
title: Loguru Migration - Structured Logging with Separate Log Files
status: planned
priority: high
estimated_effort: high
wave: 1
autonomous: true
---

## Goal

Replace Python's standard `logging` module with Loguru for improved logging efficiency and automatic stack traces. Configure separate log files for MLX Server and MLX Manager components.

## Context

The codebase currently uses Python's standard `logging` module across 45+ files. The user requested:
1. Switch to Loguru for efficiency and `.exception()` auto-stacktrace support
2. Separate logs: `logs/mlx-server.log` for inference, `logs/mlx-manager.log` for app
3. Configurable log levels via environment variables

## Current State

- **Logging configured in**: `main.py` (lines 25-37) and `mlx_server/main.py` (lines 18-24)
- **Env var**: `MLX_MANAGER_LOG_LEVEL` (default: INFO)
- **Output**: stdout only (no file logging)
- **Files using logging**: 45 Python files
- **Loguru usage**: None currently

## Implementation Plan

### Task 1: Add Loguru Dependency

**File:** `backend/pyproject.toml`

Add loguru to dependencies:
```toml
dependencies = [
    ...
    "loguru>=0.7.0",
]
```

### Task 2: Create Logging Configuration Module

**File:** `backend/mlx_manager/logging_config.py` (NEW)

Create centralized logging configuration:
```python
"""Loguru-based logging configuration.

Provides:
- Separate log files for mlx-server and mlx-manager
- Configurable log levels via environment variables
- Automatic rotation and retention
- Intercept handler for standard logging compatibility
"""
import logging
import os
import sys
from pathlib import Path

from loguru import logger

# Environment variables
LOG_LEVEL = os.environ.get("MLX_MANAGER_LOG_LEVEL", "INFO").upper()
LOG_DIR = Path(os.environ.get("MLX_MANAGER_LOG_DIR", "logs"))

# Ensure log directory exists
LOG_DIR.mkdir(parents=True, exist_ok=True)

def setup_logging() -> None:
    """Configure Loguru logging with separate files."""
    # Remove default handler
    logger.remove()

    # Console output (stderr)
    logger.add(
        sys.stderr,
        level=LOG_LEVEL,
        format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
        colorize=True,
    )

    # MLX Server log file (inference, models, adapters)
    logger.add(
        LOG_DIR / "mlx-server.log",
        level=LOG_LEVEL,
        format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
        rotation="10 MB",
        retention="7 days",
        filter=lambda record: record["name"].startswith("mlx_manager.mlx_server"),
    )

    # MLX Manager log file (app, routers, services)
    logger.add(
        LOG_DIR / "mlx-manager.log",
        level=LOG_LEVEL,
        format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
        rotation="10 MB",
        retention="7 days",
        filter=lambda record: not record["name"].startswith("mlx_manager.mlx_server"),
    )

class InterceptHandler(logging.Handler):
    """Intercept standard logging and redirect to Loguru."""

    def emit(self, record: logging.LogRecord) -> None:
        # Get corresponding Loguru level
        try:
            level = logger.level(record.levelname).name
        except ValueError:
            level = record.levelno

        # Find caller from where the logged message originated
        frame, depth = logging.currentframe(), 2
        while frame and frame.f_code.co_filename == logging.__file__:
            frame = frame.f_back
            depth += 1

        logger.opt(depth=depth, exception=record.exc_info).log(level, record.getMessage())

def intercept_standard_logging() -> None:
    """Redirect all standard logging to Loguru."""
    logging.basicConfig(handlers=[InterceptHandler()], level=0, force=True)

    # Suppress noisy third-party loggers
    for name in ["httpx", "httpcore", "uvicorn.access", "huggingface_hub"]:
        logging.getLogger(name).setLevel(logging.WARNING)
```

### Task 3: Update Main Application Entry Point

**File:** `backend/mlx_manager/main.py`

Replace logging setup:
```python
# REMOVE these lines (25-37):
# import logging
# log_level = os.environ.get("MLX_MANAGER_LOG_LEVEL", "INFO").upper()
# logging.basicConfig(...)

# ADD:
from mlx_manager.logging_config import setup_logging, intercept_standard_logging

# In module initialization:
setup_logging()
intercept_standard_logging()
```

### Task 4: Update MLX Server Entry Point

**File:** `backend/mlx_manager/mlx_server/main.py`

Remove duplicate logging setup (lines 18-24) - now handled centrally.

### Task 5: Migrate All Files from logging to loguru

**Pattern for each file:**

Before:
```python
import logging
logger = logging.getLogger(__name__)
```

After:
```python
from loguru import logger
```

**Files to update (MLX Server - 26 files):**
- `mlx_server/main.py`
- `mlx_server/database.py`
- `mlx_server/models/pool.py`
- `mlx_server/models/detection.py`
- `mlx_server/models/adapters/registry.py`
- `mlx_server/models/adapters/llama.py`
- `mlx_server/models/adapters/glm4.py`
- `mlx_server/models/adapters/qwen.py`
- `mlx_server/services/inference.py`
- `mlx_server/services/audit.py`
- `mlx_server/services/embeddings.py`
- `mlx_server/services/vision.py`
- `mlx_server/services/response_processor.py`
- `mlx_server/services/image_processor.py`
- `mlx_server/services/cloud/router.py`
- `mlx_server/services/cloud/client.py`
- `mlx_server/services/cloud/openai.py`
- `mlx_server/services/cloud/anthropic.py`
- `mlx_server/services/batching/batch_inference.py`
- `mlx_server/services/batching/scheduler.py`
- `mlx_server/services/batching/scheduler_manager.py`
- `mlx_server/api/v1/chat.py`
- `mlx_server/api/v1/completions.py`
- `mlx_server/api/v1/embeddings.py`
- `mlx_server/api/v1/messages.py`
- `mlx_server/api/v1/admin.py`
- `mlx_server/errors/handlers.py`
- `mlx_server/middleware/timeout.py`
- `mlx_server/utils/memory.py`
- `mlx_server/benchmark/runner.py`
- `mlx_server/observability/logfire_config.py`

**Files to update (MLX Manager - 19 files):**
- `main.py`
- `database.py`
- `menubar.py`
- `routers/chat.py`
- `routers/servers.py`
- `routers/system.py`
- `routers/settings.py`
- `services/launchd.py`
- `services/health_checker.py`
- `services/hf_client.py`
- `services/hf_api.py`
- `services/auth_service.py`
- `utils/model_detection.py`
- `observability/logfire_config.py`

### Task 6: Update Exception Handling

Replace `logger.error()` in exception blocks with `logger.exception()`:

Before:
```python
except Exception as e:
    logger.error(f"Failed: {e}")
```

After:
```python
except Exception as e:
    logger.exception(f"Failed: {e}")  # Auto-includes stack trace
```

### Task 7: Add Log Directory to .gitignore

**File:** `backend/.gitignore`

Add:
```
logs/
```

### Task 8: Update Config Documentation

**File:** `backend/mlx_manager/config.py`

Add docstring noting new env vars:
- `MLX_MANAGER_LOG_LEVEL` - Log level (DEBUG, INFO, WARNING, ERROR)
- `MLX_MANAGER_LOG_DIR` - Log directory (default: `logs/`)

## Testing

- [ ] Server starts without errors
- [ ] Logs appear in `logs/mlx-server.log` for inference operations
- [ ] Logs appear in `logs/mlx-manager.log` for app operations
- [ ] DEBUG level shows detailed logs when `MLX_MANAGER_LOG_LEVEL=DEBUG`
- [ ] `.exception()` produces stack traces automatically
- [ ] Third-party library logs are suppressed
- [ ] All existing tests pass

## Verification Commands

```bash
# Start server with debug logging
MLX_MANAGER_LOG_LEVEL=DEBUG mlx-manager serve

# Check log files
tail -f logs/mlx-server.log
tail -f logs/mlx-manager.log

# Run tests
cd backend && pytest -v
```

## Dependencies

- None (standalone task)

## Risks

- **Third-party compatibility**: Some libraries may not work well with loguru intercept
- **Test fixtures**: May need to update test fixtures that mock logging
- **LogFire integration**: Need to verify Pydantic LogFire still works with loguru
