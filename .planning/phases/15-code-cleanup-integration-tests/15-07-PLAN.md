# Plan 15-07: Fix Hanging Model Downloads

## Objective

Investigate and fix model downloads that hang without starting.

## Problem Statement

User reports that model downloads initiated from UI hang and never start. Need to investigate:
1. Whether the dry_run size check is hanging
2. Whether the SSE connection is established
3. Whether there's a frontend issue connecting to progress endpoint

## Investigation Steps

### Step 1: Check backend logs during download attempt

Add more logging to identify where the hang occurs:

**File:** `backend/mlx_manager/services/hf_client.py`

```python
async def download_model(self, model_id: str) -> AsyncGenerator[DownloadStatus, None]:
    logger.info(f"Starting download for {model_id}")

    if settings.offline_mode:
        logger.warning("Download blocked - offline mode enabled")
        yield DownloadStatus(...)
        return

    loop = asyncio.get_event_loop()
    logger.info(f"Getting total size for {model_id} via dry_run")

    try:
        dry_run_result = await loop.run_in_executor(...)
        logger.info(f"Dry run complete for {model_id}: {total_bytes} bytes")
    except Exception as e:
        logger.warning(f"Dry run failed for {model_id}: {e}")
        ...

    logger.info(f"Starting actual download for {model_id}")
    ...
```

### Step 2: Check frontend download initiation

**File:** `frontend/src/lib/components/models/ModelDownload.svelte` (or similar)

Verify:
1. POST to `/api/models/download` succeeds and returns task_id
2. GET to `/api/models/download/{task_id}/progress` is called
3. SSE connection is established

### Step 3: Check for HuggingFace Hub issues

The `snapshot_download` with `dry_run=True` might hang if:
- HuggingFace Hub is slow/down
- Network issues
- Token authentication issues

Add timeout to dry_run:

```python
import asyncio

try:
    dry_run_result = await asyncio.wait_for(
        loop.run_in_executor(
            None,
            lambda: snapshot_download(repo_id=model_id, dry_run=True, tqdm_class=SilentProgress),
        ),
        timeout=30.0,  # 30 second timeout for size check
    )
except asyncio.TimeoutError:
    logger.warning(f"Dry run timed out for {model_id}, proceeding without size estimate")
    total_bytes = 0
```

### Step 4: Check SSE connection in browser

In browser dev tools:
- Network tab â†’ filter by "progress"
- Check if SSE connection is established
- Check if events are being received

## Tasks

### Task 1: Add comprehensive logging

**File:** `backend/mlx_manager/services/hf_client.py`

Add INFO-level logs at each step:
- Before dry_run
- After dry_run (with result)
- Before download start
- During polling
- On completion/error

### Task 2: Add timeout to dry_run

**File:** `backend/mlx_manager/services/hf_client.py`

Wrap dry_run in `asyncio.wait_for` with 30s timeout.

### Task 3: Check and fix frontend SSE handling

**File:** `frontend/src/lib/components/models/` (relevant file)

Verify EventSource is properly handling the SSE stream.

### Task 4: Add download status endpoint

**File:** `backend/mlx_manager/routers/models.py`

Add a simple GET endpoint to check download status without SSE:

```python
@router.get("/download/{task_id}/status")
async def get_download_status(task_id: str) -> dict:
    """Simple status check without SSE."""
    if task_id not in download_tasks:
        raise HTTPException(status_code=404, detail="Task not found")
    return download_tasks[task_id]
```

### Task 5: Test with a small model

Test download with a small model to verify the pipeline:
- `mlx-community/Qwen3-0.6B-4bit-DWQ` (small, fast download)

## Success Criteria

1. [ ] Clear logging shows where download process is at each step
2. [ ] Dry_run has timeout to prevent indefinite hang
3. [ ] Frontend properly connects to SSE endpoint
4. [ ] Downloads complete successfully for test model
5. [ ] Progress updates appear in UI during download

## Dependencies

None - isolated fix

## Estimated Complexity

Medium - Investigation + targeted fixes

---

*Plan: 15-07*
*Phase: 15-code-cleanup-integration-tests*
*Priority: HIGH*
