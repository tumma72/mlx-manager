---
phase: 07-foundation-server-skeleton
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/mlx_manager/mlx_server/__init__.py
  - backend/mlx_manager/mlx_server/config.py
  - backend/mlx_manager/mlx_server/main.py
  - backend/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "MLX server module exists as separate subpackage within mlx_manager"
    - "Server configuration uses Pydantic settings with MLX_SERVER_ env prefix"
    - "FastAPI app instance created with lifespan handler"
    - "LogFire instrumentation enabled for request tracing"
  artifacts:
    - path: "backend/mlx_manager/mlx_server/__init__.py"
      provides: "Package exports"
      contains: "__version__"
    - path: "backend/mlx_manager/mlx_server/config.py"
      provides: "Server configuration"
      contains: "class MLXServerSettings"
    - path: "backend/mlx_manager/mlx_server/main.py"
      provides: "FastAPI application"
      contains: "logfire.instrument_fastapi"
  key_links:
    - from: "backend/mlx_manager/mlx_server/main.py"
      to: "backend/mlx_manager/mlx_server/config.py"
      via: "import settings"
      pattern: "from.*config.*import.*settings"
---

<objective>
Create the MLX server module skeleton with FastAPI + LogFire instrumentation.

Purpose: Establish the foundational structure for the new MLX inference server as a subpackage within the existing mlx_manager backend. This enables the server to share database, auth, and other infrastructure while remaining modular.

Output: Working FastAPI app skeleton with Pydantic v2 config, LogFire instrumentation, and health endpoint.
</objective>

<execution_context>
@.claude/agents/gsd-executor.md
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-foundation-server-skeleton/07-RESEARCH.md

# Existing codebase patterns to follow
@backend/mlx_manager/main.py
@backend/mlx_manager/config.py
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MLX server package structure</name>
  <files>
    backend/mlx_manager/mlx_server/__init__.py
    backend/mlx_manager/mlx_server/config.py
  </files>
  <action>
Create the new mlx_server subpackage within mlx_manager:

1. Create `backend/mlx_manager/mlx_server/__init__.py`:
   - Export `__version__ = "0.1.0"`
   - Docstring: "MLX Unified Inference Server"

2. Create `backend/mlx_manager/mlx_server/config.py`:
   - Use pydantic_settings BaseSettings like existing config.py
   - Class `MLXServerSettings` with `MLX_SERVER_` env prefix
   - Settings:
     - `host: str = "127.0.0.1"`
     - `port: int = 8000` (different from main app's 8080)
     - `max_memory_gb: float = 48.0` (model pool memory limit)
     - `max_models: int = 4` (max hot models)
     - `default_max_tokens: int = 4096`
     - `logfire_enabled: bool = True`
     - `logfire_token: str | None = None` (optional LogFire API token)
   - Instantiate singleton: `mlx_server_settings = MLXServerSettings()`

Follow the existing config.py pattern for consistency.
  </action>
  <verify>
    - `python -c "from mlx_manager.mlx_server import __version__; print(__version__)"`
    - `python -c "from mlx_manager.mlx_server.config import mlx_server_settings; print(mlx_server_settings.port)"`
  </verify>
  <done>Package imports successfully, settings load with defaults</done>
</task>

<task type="auto">
  <name>Task 2: Create FastAPI app with LogFire instrumentation</name>
  <files>
    backend/mlx_manager/mlx_server/main.py
    backend/pyproject.toml
  </files>
  <action>
1. Update `backend/pyproject.toml`:
   - Add dependencies: `logfire`, `sse-starlette>=2.0.0`
   - These are new dependencies for Phase 7

2. Create `backend/mlx_manager/mlx_server/main.py`:
   - Import FastAPI, logfire, asynccontextmanager
   - Import mlx_server_settings from config

   - Create lifespan context manager (async):
     ```python
     @asynccontextmanager
     async def lifespan(app: FastAPI):
         # Startup
         logger.info("MLX Server starting...")
         # TODO: Initialize model pool (Plan 03)
         logger.info("MLX Server ready")
         yield
         # Shutdown
         logger.info("MLX Server shutting down...")
         # TODO: Cleanup model pool
     ```

   - Create FastAPI app:
     ```python
     app = FastAPI(
         title="MLX Inference Server",
         description="OpenAI-compatible inference server for MLX models",
         version=__version__,
         lifespan=lifespan,
     )
     ```

   - Configure LogFire (conditional on settings):
     ```python
     if mlx_server_settings.logfire_enabled:
         logfire.configure(token=mlx_server_settings.logfire_token)
         logfire.instrument_fastapi(app)
     ```

   - Add health endpoint:
     ```python
     @app.get("/health")
     async def health():
         return {"status": "healthy", "version": __version__}
     ```

   - Add main block for standalone testing:
     ```python
     if __name__ == "__main__":
         import uvicorn
         uvicorn.run(app, host=mlx_server_settings.host, port=mlx_server_settings.port)
     ```

Note: Use standard logging like main.py does. LogFire augments but doesn't replace logging.
  </action>
  <verify>
    - `cd backend && pip install -e ".[dev]"` (install new deps)
    - `cd backend && python -c "from mlx_manager.mlx_server.main import app; print(app.title)"`
    - `cd backend && python -m mlx_manager.mlx_server.main &` then `curl http://127.0.0.1:8000/health`
  </verify>
  <done>
    - FastAPI app creates without errors
    - Health endpoint returns JSON with status and version
    - LogFire instrumentation configured (visible in logs if LOGFIRE_TOKEN set)
  </done>
</task>

</tasks>

<verification>
1. Package structure exists:
   ```bash
   ls backend/mlx_manager/mlx_server/
   # Should show: __init__.py, config.py, main.py
   ```

2. Imports work:
   ```bash
   cd backend && python -c "
   from mlx_manager.mlx_server import __version__
   from mlx_manager.mlx_server.config import mlx_server_settings
   from mlx_manager.mlx_server.main import app
   print(f'Version: {__version__}')
   print(f'Port: {mlx_server_settings.port}')
   print(f'App: {app.title}')
   "
   ```

3. Run quality checks:
   ```bash
   cd backend && ruff check mlx_manager/mlx_server/ && ruff format --check mlx_manager/mlx_server/ && mypy mlx_manager/mlx_server/
   ```
</verification>

<success_criteria>
- [ ] mlx_server package created under mlx_manager
- [ ] MLXServerSettings loads with defaults and MLX_SERVER_ prefix
- [ ] FastAPI app initializes with lifespan handler
- [ ] LogFire instrumentation conditional on settings
- [ ] Health endpoint returns version
- [ ] All quality checks pass (ruff, mypy)
</success_criteria>

<output>
After completion, create `.planning/phases/07-foundation-server-skeleton/07-01-SUMMARY.md`
</output>
