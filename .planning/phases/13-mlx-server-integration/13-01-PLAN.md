---
phase: 13-mlx-server-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/mlx_manager/main.py
  - backend/mlx_manager/mlx_server/main.py
  - backend/mlx_manager/mlx_server/config.py
autonomous: true

must_haves:
  truths:
    - "MLX Server routes accessible at /v1/* from MLX Manager app"
    - "Model pool initializes on startup"
    - "Database sessions shared between apps"
    - "Health endpoint returns both apps healthy"
  artifacts:
    - path: "backend/mlx_manager/main.py"
      provides: "Mounted MLX Server sub-application"
      contains: "app.mount"
    - path: "backend/mlx_manager/mlx_server/main.py"
      provides: "Embeddable app factory function"
      exports: ["create_app"]
  key_links:
    - from: "backend/mlx_manager/main.py"
      to: "backend/mlx_manager/mlx_server/main.py"
      via: "app.mount with sub-app"
      pattern: 'mount.*"/v1"'
---

<objective>
Mount MLX Server as sub-application of MLX Manager

Purpose: Enable the MLX Server (built in phases 7-12) to run embedded within MLX Manager rather than as a separate process. This eliminates the need for mlx-openai-server subprocess management and provides a unified application.

Output: MLX Manager app that serves both /api/* (manager routes) and /v1/* (MLX Server inference routes) from a single FastAPI application.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/mlx_manager/main.py
@backend/mlx_manager/mlx_server/main.py
@backend/mlx_manager/mlx_server/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create embeddable app factory in MLX Server</name>
  <files>backend/mlx_manager/mlx_server/main.py</files>
  <action>
Refactor mlx_server/main.py to support both standalone and embedded modes:

1. Create `create_app(embedded: bool = False)` factory function that returns a FastAPI app
2. When `embedded=True`:
   - Skip LogFire configuration (parent app handles it)
   - Skip lifespan handler (parent app handles model pool init)
   - Return the app WITHOUT starting it
3. When `embedded=False` (standalone mode):
   - Keep existing behavior with lifespan and LogFire
   - Used for `if __name__ == "__main__":` block

4. Keep the existing `app` module-level variable for backward compatibility but create it via `create_app(embedded=False)`

5. Export `create_app` in __all__

Key change: The embedded app must NOT have its own lifespan handler since the parent app will manage model pool initialization.
  </action>
  <verify>
- `from mlx_manager.mlx_server.main import create_app` imports without error
- `create_app(embedded=True)` returns FastAPI app without starting server
- Standalone `python -m mlx_manager.mlx_server.main` still works
  </verify>
  <done>MLX Server has create_app() factory that supports embedded mode</done>
</task>

<task type="auto">
  <name>Task 2: Mount MLX Server in MLX Manager main.py</name>
  <files>backend/mlx_manager/main.py</files>
  <action>
Modify main.py to mount MLX Server as sub-application:

1. Import the embedded app factory:
   ```python
   from mlx_manager.mlx_server.main import create_app as create_mlx_server_app
   from mlx_manager.mlx_server.models import pool
   from mlx_manager.mlx_server.models.pool import ModelPoolManager
   from mlx_manager.mlx_server.config import mlx_server_settings
   from mlx_manager.mlx_server.utils.memory import set_memory_limit
   ```

2. In the `lifespan` async context manager, AFTER `init_db()`:
   - Initialize the model pool singleton:
     ```python
     # Initialize MLX Server model pool
     set_memory_limit(mlx_server_settings.max_memory_gb)
     pool.model_pool = ModelPoolManager(
         max_memory_gb=mlx_server_settings.max_memory_gb,
         max_models=mlx_server_settings.max_models,
     )
     logger.info("MLX Server model pool initialized")
     ```
   - Optionally initialize scheduler manager if batching enabled

3. In the `lifespan` shutdown section:
   - Cleanup model pool:
     ```python
     if pool.model_pool:
         await pool.model_pool.cleanup()
     ```

4. After `app = FastAPI(...)` creation, mount the embedded MLX Server:
   ```python
   # Mount MLX Server at /v1 prefix
   mlx_server_app = create_mlx_server_app(embedded=True)
   app.mount("/v1", mlx_server_app, name="mlx_server")
   ```

5. Remove any duplicate CORS configuration for /v1 routes (sub-app inherits parent CORS)

Note: The mount MUST happen AFTER instrument_fastapi(app) to ensure LogFire traces both apps.
  </action>
  <verify>
- `cd backend && python -c "from mlx_manager.main import app; print([r.path for r in app.routes])"` shows /v1 mount
- `cd backend && uvicorn mlx_manager.main:app --port 8080` starts without error
- `curl http://localhost:8080/v1/models` returns JSON (may be empty list if no models loaded)
  </verify>
  <done>/v1/* routes accessible from MLX Manager app, model pool initializes on startup</done>
</task>

<task type="auto">
  <name>Task 3: Update MLX Server config for embedded mode</name>
  <files>backend/mlx_manager/mlx_server/config.py</files>
  <action>
Update mlx_server/config.py to support configuration from MLX Manager:

1. Add an `embedded_mode: bool = False` setting
2. When `embedded_mode=True`:
   - Use MLX Manager's database path for audit logs (shared database)
   - Skip standalone-only settings (host, port)

3. Add a helper function to detect embedded mode:
   ```python
   def is_embedded() -> bool:
       """Check if running in embedded mode within MLX Manager."""
       return mlx_server_settings.embedded_mode
   ```

4. Ensure the database path for audit logs points to the same SQLite file as MLX Manager when embedded

Note: The config should be read from environment variables for flexibility, but have sensible defaults for embedded mode.
  </action>
  <verify>
- `cd backend && python -c "from mlx_manager.mlx_server.config import mlx_server_settings, is_embedded; print(is_embedded())"` works
- Setting `MLX_SERVER_EMBEDDED_MODE=true` changes behavior
  </verify>
  <done>MLX Server config supports embedded mode detection and shared database path</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Start combined server:
   ```bash
   cd backend && uvicorn mlx_manager.main:app --port 8080
   ```

2. Verify routes work:
   ```bash
   # Manager routes
   curl http://localhost:8080/health
   curl http://localhost:8080/api/profiles

   # MLX Server routes (mounted at /v1)
   curl http://localhost:8080/v1/models
   curl http://localhost:8080/v1/health  # if exists
   ```

3. Verify logs show model pool initialization:
   - "MLX Server model pool initialized" in startup logs
</verification>

<success_criteria>
- MLX Server routes accessible at /v1/* from single FastAPI app
- Model pool initializes on MLX Manager startup
- No separate MLX Server process needed
- Health checks work for both /health and /v1/health
</success_criteria>

<output>
After completion, create `.planning/phases/13-mlx-server-integration/13-01-SUMMARY.md`
</output>
