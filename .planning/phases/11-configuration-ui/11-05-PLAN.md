---
phase: 11-configuration-ui
plan: 05
type: execute
wave: 3
depends_on: ["11-02", "11-03", "11-04"]
files_modified:
  - frontend/src/lib/components/layout/Navbar.svelte
  - frontend/src/routes/(protected)/settings/+page.svelte
  - frontend/src/lib/stores/settings.svelte.ts
  - frontend/src/lib/components/settings/index.ts
autonomous: true

must_haves:
  truths:
    - "Settings link visible in navbar"
    - "All three settings sections render on settings page"
    - "Settings page fetches and displays real data"
    - "Configuration changes apply without page reload"
  artifacts:
    - path: "frontend/src/lib/stores/settings.svelte.ts"
      provides: "Settings state management with Svelte 5 runes"
      min_lines: 40
  key_links:
    - from: "frontend/src/lib/components/layout/Navbar.svelte"
      to: "/settings"
      via: "navigation link"
      pattern: "href.*settings"
    - from: "frontend/src/routes/(protected)/settings/+page.svelte"
      to: "frontend/src/lib/components/settings"
      via: "component imports"
      pattern: "ProviderSection|ModelPoolSettings|RoutingRulesSection"
---

<objective>
Integrate all settings components into a cohesive settings page with navigation, state management, and final polish.

Purpose: Wire together provider configuration, model pool settings, and routing rules into a complete settings experience accessible from the main navigation.

Output: Settings navbar link, unified settings page, optional settings store for shared state.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-configuration-ui/11-CONTEXT.md
@.planning/phases/11-configuration-ui/11-02-SUMMARY.md
@.planning/phases/11-configuration-ui/11-03-SUMMARY.md
@.planning/phases/11-configuration-ui/11-04-SUMMARY.md
@frontend/src/lib/components/layout/Navbar.svelte
@frontend/src/routes/(protected)/settings/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Settings link to navbar</name>
  <files>
    frontend/src/lib/components/layout/Navbar.svelte
  </files>
  <action>
Add Settings to the main navigation in the navbar:

1. Update `frontend/src/lib/components/layout/Navbar.svelte`:
   - Import Settings icon from lucide-svelte (already imported but not used in nav)
   - Add Settings to the navigation array:
     ```typescript
     const navigation = [
       { href: '/servers' as const, label: 'Servers', icon: Server },
       { href: '/chat' as const, label: 'Chat', icon: MessageSquare },
       { href: '/models' as const, label: 'Models', icon: Package },
       { href: '/profiles' as const, label: 'Profiles', icon: Settings },
       { href: '/settings' as const, label: 'Settings', icon: Sliders }, // Use Sliders icon to differentiate from Profiles
     ];
     ```
   - Note: Use `Sliders` icon (or `SlidersHorizontal`) for Settings to differentiate from Profiles which already uses `Settings` icon
   - Import the new icon: `import { ..., Sliders } from 'lucide-svelte';`

The navigation loop already handles rendering, so just adding to the array should work.
  </action>
  <verify>
```bash
cd /Users/atomasini/Development/mlx-manager/frontend
npm run check
grep -n "settings" src/lib/components/layout/Navbar.svelte
```
  </verify>
  <done>
Settings link added to navbar navigation array with Sliders icon, TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Finalize settings page with all sections</name>
  <files>
    frontend/src/routes/(protected)/settings/+page.svelte
  </files>
  <action>
Ensure the settings page integrates all three sections properly:

1. Update `frontend/src/routes/(protected)/settings/+page.svelte`:
   - Import all three section components
   - Add proper section styling with consistent spacing
   - Add helpful descriptions for each section
   - Ensure proper dark mode support

```svelte
<script lang="ts">
  import { ProviderSection, ModelPoolSettings, RoutingRulesSection } from '$lib/components/settings';
</script>

<svelte:head>
  <title>Settings | MLX Manager</title>
</svelte:head>

<div class="space-y-10">
  <div>
    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Settings</h1>
    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
      Configure cloud providers, model pool, and routing rules.
    </p>
  </div>

  <!-- Cloud Providers -->
  <section class="space-y-4">
    <div>
      <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Cloud Providers</h2>
      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
        Configure API keys for cloud inference providers. Keys are encrypted at rest.
      </p>
    </div>
    <ProviderSection />
  </section>

  <hr class="border-gray-200 dark:border-gray-700" />

  <!-- Model Pool -->
  <section class="space-y-4">
    <div>
      <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Model Pool</h2>
      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
        Configure memory limits, eviction policy, and models to preload on startup.
      </p>
    </div>
    <ModelPoolSettings />
  </section>

  <hr class="border-gray-200 dark:border-gray-700" />

  <!-- Routing Rules -->
  <section class="space-y-4">
    <div>
      <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Model Routing Rules</h2>
      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
        Define which backend handles each model. Rules are evaluated top-to-bottom by priority.
        Drag to reorder. Rules referencing unconfigured providers are skipped at runtime.
      </p>
    </div>
    <RoutingRulesSection />
  </section>
</div>
```
  </action>
  <verify>
```bash
cd /Users/atomasini/Development/mlx-manager/frontend
npm run check
npm run lint
```
  </verify>
  <done>
Settings page imports and renders all three section components with proper styling, descriptions, and dark mode support. TypeScript and ESLint pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create settings store and add unit tests</name>
  <files>
    frontend/src/lib/stores/settings.svelte.ts
    frontend/src/lib/stores/index.ts
    frontend/src/lib/components/settings/index.ts
  </files>
  <action>
Create a settings store for shared state and ensure all components are properly exported:

1. Create `frontend/src/lib/stores/settings.svelte.ts`:
   - Simple store to track configured providers (for warning badges across components)
   - Fetch providers on init
   - Export helper to check if provider is configured

```typescript
/**
 * Settings store for tracking configured providers.
 * Used by routing rules to show warning badges for unconfigured backends.
 */
import { settings } from '$lib/api/client';
import type { CloudCredential, BackendType } from '$lib/api/types';

class SettingsStore {
  credentials = $state<CloudCredential[]>([]);
  loading = $state(false);
  loaded = $state(false);

  get configuredProviders(): BackendType[] {
    return this.credentials.map(c => c.backend_type);
  }

  isProviderConfigured(type: BackendType): boolean {
    return type === 'local' || this.configuredProviders.includes(type);
  }

  async load() {
    if (this.loaded) return;
    this.loading = true;
    try {
      this.credentials = await settings.listProviders();
      this.loaded = true;
    } finally {
      this.loading = false;
    }
  }

  async refresh() {
    this.loading = true;
    try {
      this.credentials = await settings.listProviders();
    } finally {
      this.loading = false;
    }
  }

  reset() {
    this.credentials = [];
    this.loaded = false;
    this.loading = false;
  }
}

export const settingsStore = new SettingsStore();
```

2. Update `frontend/src/lib/stores/index.ts`:
   - Add export for settingsStore
   ```typescript
   export { settingsStore } from './settings.svelte';
   ```

3. Update `frontend/src/lib/components/settings/index.ts` to ensure all components are exported:
   ```typescript
   export { default as ProviderSection } from './ProviderSection.svelte';
   export { default as ProviderForm } from './ProviderForm.svelte';
   export { default as ModelPoolSettings } from './ModelPoolSettings.svelte';
   export { default as RoutingRulesSection } from './RoutingRulesSection.svelte';
   export { default as RuleCard } from './RuleCard.svelte';
   export { default as RuleForm } from './RuleForm.svelte';
   export { default as RuleTestInput } from './RuleTestInput.svelte';
   ```
  </action>
  <verify>
```bash
cd /Users/atomasini/Development/mlx-manager/frontend
npm run check
npm run lint

# Verify store is exported
grep -n "settingsStore" src/lib/stores/index.ts
```
  </verify>
  <done>
Settings store created with provider tracking, exported from stores index, all settings components exported. TypeScript and ESLint pass.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
cd /Users/atomasini/Development/mlx-manager/frontend

# Type checking
npm run check

# Linting
npm run lint

# Verify exports
grep -n "settings" src/lib/stores/index.ts
grep -n "Settings" src/lib/components/layout/Navbar.svelte
```

Full integration test:
1. Start dev servers: `./scripts/dev.sh`
2. Login to the app
3. Verify Settings link appears in navbar
4. Click Settings link - should navigate to /settings
5. Verify all three sections render:
   - Cloud Providers (accordion with OpenAI/Anthropic)
   - Model Pool (memory slider, eviction dropdown, preload selector)
   - Routing Rules (test input, add form, sortable list)
6. Configure an OpenAI API key and test connection
7. Adjust memory settings and save
8. Create a routing rule and test with a model name
9. Reorder rules via drag-drop
10. Refresh page - all settings should persist
</verification>

<success_criteria>
- [ ] Settings link visible in navbar with Sliders icon
- [ ] Clicking Settings navigates to /settings page
- [ ] All three sections render correctly
- [ ] Provider accordion expands/collapses
- [ ] Memory slider adjusts with mode toggle
- [ ] Routing rules can be created, reordered, deleted
- [ ] Rule test shows matching results
- [ ] Settings persist across page refresh
- [ ] settingsStore exported and functional
- [ ] All TypeScript compiles, ESLint passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-configuration-ui/11-05-SUMMARY.md`
</output>
