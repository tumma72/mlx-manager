---
phase: 11-configuration-ui
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - frontend/src/lib/components/settings/ModelPoolSettings.svelte
  - frontend/src/lib/components/settings/index.ts
  - frontend/src/routes/(protected)/settings/+page.svelte
autonomous: true

must_haves:
  truths:
    - "User can toggle between % and GB mode for memory limit"
    - "User can adjust memory limit via slider"
    - "User can select eviction policy from dropdown"
    - "User can select preload models from downloaded list"
    - "Settings persist to backend on save"
  artifacts:
    - path: "frontend/src/lib/components/settings/ModelPoolSettings.svelte"
      provides: "Memory slider, mode toggle, eviction dropdown, preload selector"
      min_lines: 120
  key_links:
    - from: "frontend/src/lib/components/settings/ModelPoolSettings.svelte"
      to: "/api/settings/pool"
      via: "fetch calls"
      pattern: "settings\\.getPoolConfig|settings\\.updatePoolConfig"
    - from: "frontend/src/lib/components/settings/ModelPoolSettings.svelte"
      to: "/api/models/local"
      via: "models.listLocal for preload selection"
      pattern: "models\\.listLocal"
---

<objective>
Create the model pool configuration UI with memory slider, eviction policy dropdown, and preload model selector.

Purpose: Enable users to configure model pool memory limits (% or GB), choose eviction policy (LRU/LFU/TTL), and select models to preload on startup.

Output: ModelPoolSettings component with all controls, integrated into settings page.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-configuration-ui/11-CONTEXT.md
@.planning/phases/11-configuration-ui/11-RESEARCH.md
@frontend/src/lib/api/client.ts
@frontend/src/lib/api/types.ts
@frontend/src/lib/stores/system.svelte.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModelPoolSettings component</name>
  <files>
    frontend/src/lib/components/settings/ModelPoolSettings.svelte
  </files>
  <action>
Create the model pool configuration component with memory slider, eviction dropdown, and preload selector:

1. Create `frontend/src/lib/components/settings/ModelPoolSettings.svelte`:

**Structure:**
- Memory Limit section:
  - Toggle switch for % vs GB mode (use bits-ui Switch)
  - Slider for value (use bits-ui Slider)
  - Display current value prominently
  - Min/max based on mode: % mode (10-100), GB mode (1-systemMemory)
  - Step: % mode = 5, GB mode = 1

- Eviction Policy section (under "Advanced Options" collapsible):
  - Dropdown with LRU (default), LFU, TTL options
  - Brief description of each policy

- Preload Models section:
  - Searchable combobox (bits-ui Combobox) to select from downloaded models
  - Selected models shown as removable tags
  - Fetch local models via `models.listLocal()`

- Save button at bottom
- Loading states for initial load and save

**Implementation:**
```svelte
<script lang="ts">
  import { onMount } from 'svelte';
  import { Slider, Switch, Select, Combobox, Collapsible } from 'bits-ui';
  import { ChevronDown, X, Save, Loader2 } from 'lucide-svelte';
  import { settings, models } from '$lib/api/client';
  import { systemStore } from '$stores';
  import type { ServerPoolConfig, LocalModel, EvictionPolicy, MemoryLimitMode } from '$lib/api/types';

  let config = $state<ServerPoolConfig | null>(null);
  let localModels = $state<LocalModel[]>([]);
  let loading = $state(true);
  let saving = $state(false);
  let error = $state<string | null>(null);
  let showAdvanced = $state(false);

  // Form state
  let memoryMode = $state<MemoryLimitMode>('percent');
  let memoryValue = $state(80);
  let evictionPolicy = $state<EvictionPolicy>('lru');
  let preloadModels = $state<string[]>([]);

  // Derived values
  const maxMemoryGb = $derived(systemStore.memory?.total_gb ?? 64);
  const sliderMax = $derived(memoryMode === 'percent' ? 100 : Math.floor(maxMemoryGb));
  const sliderMin = $derived(memoryMode === 'percent' ? 10 : 1);
  const sliderStep = $derived(memoryMode === 'percent' ? 5 : 1);
  const displayValue = $derived(
    memoryMode === 'percent' ? `${memoryValue}%` : `${memoryValue} GB`
  );

  const evictionOptions = [
    { value: 'lru', label: 'LRU (Least Recently Used)', description: 'Evict models not used for longest' },
    { value: 'lfu', label: 'LFU (Least Frequently Used)', description: 'Evict models with fewest requests' },
    { value: 'ttl', label: 'TTL (Time To Live)', description: 'Evict models after idle timeout' },
  ];

  onMount(async () => {
    try {
      [config, localModels] = await Promise.all([
        settings.getPoolConfig(),
        models.listLocal(),
      ]);
      // Initialize form from config
      memoryMode = config.memory_limit_mode;
      memoryValue = config.memory_limit_value;
      evictionPolicy = config.eviction_policy;
      preloadModels = config.preload_models;
    } catch (e) {
      error = e instanceof Error ? e.message : 'Failed to load settings';
    } finally {
      loading = false;
    }
  });

  async function handleSave() {
    saving = true;
    error = null;
    try {
      await settings.updatePoolConfig({
        memory_limit_mode: memoryMode,
        memory_limit_value: memoryValue,
        eviction_policy: evictionPolicy,
        preload_models: preloadModels,
      });
    } catch (e) {
      error = e instanceof Error ? e.message : 'Failed to save settings';
    } finally {
      saving = false;
    }
  }

  function addPreloadModel(modelPath: string) {
    if (!preloadModels.includes(modelPath)) {
      preloadModels = [...preloadModels, modelPath];
    }
  }

  function removePreloadModel(modelPath: string) {
    preloadModels = preloadModels.filter(m => m !== modelPath);
  }
</script>
```

**UI Layout:**
- Card container with padding
- Sections separated by dividers
- Memory slider should be visually prominent (larger text for value)
- Preload models shown as pills with X button to remove
- Combobox searches by model_id
  </action>
  <verify>
```bash
cd /Users/atomasini/Development/mlx-manager/frontend
npm run check
```
  </verify>
  <done>
ModelPoolSettings component renders memory slider with mode toggle, eviction dropdown under Advanced, preload selector with local models, TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ModelPoolSettings into settings page</name>
  <files>
    frontend/src/lib/components/settings/index.ts
    frontend/src/routes/(protected)/settings/+page.svelte
  </files>
  <action>
Wire up the ModelPoolSettings component to the settings page:

1. Update `frontend/src/lib/components/settings/index.ts`:
   ```typescript
   export { default as ProviderSection } from './ProviderSection.svelte';
   export { default as ProviderForm } from './ProviderForm.svelte';
   export { default as ModelPoolSettings } from './ModelPoolSettings.svelte';
   ```

2. Update `frontend/src/routes/(protected)/settings/+page.svelte`:
   - Import ModelPoolSettings
   - Replace placeholder with component
   - Add brief description explaining model pool purpose

```svelte
<script lang="ts">
  import { ProviderSection, ModelPoolSettings } from '$lib/components/settings';
</script>

<div class="space-y-8">
  <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Settings</h1>

  <!-- Cloud Providers -->
  <section>
    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Cloud Providers</h2>
    <p class="text-sm text-muted-foreground mb-4">
      Configure API keys for cloud inference providers. Keys are encrypted at rest.
    </p>
    <ProviderSection />
  </section>

  <!-- Model Pool -->
  <section>
    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Model Pool</h2>
    <p class="text-sm text-muted-foreground mb-4">
      Configure memory limits and caching behavior for the local model pool.
    </p>
    <ModelPoolSettings />
  </section>

  <!-- Routing Rules (placeholder for 11-04) -->
  <section>
    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Model Routing Rules</h2>
    <p class="text-sm text-muted-foreground">Coming soon...</p>
  </section>
</div>
```
  </action>
  <verify>
```bash
cd /Users/atomasini/Development/mlx-manager/frontend
npm run check
npm run lint
```
  </verify>
  <done>
ModelPoolSettings exported and integrated into settings page, placeholder replaced, TypeScript and ESLint pass.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
cd /Users/atomasini/Development/mlx-manager/frontend

# Type checking
npm run check

# Linting
npm run lint

# Verify component exists
cat src/lib/components/settings/index.ts
```

Manual verification:
1. Start dev servers: `./scripts/dev.sh`
2. Navigate to http://localhost:5173/settings
3. Verify Model Pool section renders
4. Toggle between % and GB mode - slider should adjust range
5. Adjust slider and verify value display updates
6. Expand Advanced Options and select different eviction policy
7. Add a preload model via combobox
8. Click Save and verify no errors
</verification>

<success_criteria>
- [ ] ModelPoolSettings component renders without errors
- [ ] Mode toggle switches between % and GB
- [ ] Slider respects min/max for each mode
- [ ] Eviction policy dropdown shows LRU/LFU/TTL options
- [ ] Preload selector shows downloaded models
- [ ] Selected preload models shown as removable tags
- [ ] Save persists settings to backend
- [ ] All TypeScript compiles, ESLint passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-configuration-ui/11-03-SUMMARY.md`
</output>
