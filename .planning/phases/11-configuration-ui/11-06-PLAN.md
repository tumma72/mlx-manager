---
phase: 11-configuration-ui
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/components/settings/ModelPoolSettings.svelte
  - frontend/src/lib/components/settings/RuleForm.svelte
  - frontend/src/lib/components/settings/RoutingRulesSection.svelte
  - frontend/src/lib/components/settings/ProviderForm.svelte
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Model pool settings save successfully when Save is clicked"
    - "Provider warning appears/disappears reactively when backend selection changes"
    - "Delete actions show styled ConfirmDialog instead of native browser dialogs"
  artifacts:
    - path: "frontend/src/lib/components/settings/ModelPoolSettings.svelte"
      provides: "Pool settings with shared API client"
      contains: "import { settings } from '$lib/api/client'"
    - path: "frontend/src/lib/components/settings/RuleForm.svelte"
      provides: "Reactive provider warning"
      contains: "$derived"
    - path: "frontend/src/lib/components/settings/RoutingRulesSection.svelte"
      provides: "ConfirmDialog for rule deletion"
      contains: "ConfirmDialog"
    - path: "frontend/src/lib/components/settings/ProviderForm.svelte"
      provides: "ConfirmDialog for provider deletion"
      contains: "ConfirmDialog"
  key_links:
    - from: "ModelPoolSettings.svelte"
      to: "settings.getPoolConfig/updatePoolConfig"
      via: "shared API client import"
      pattern: "settings\\.(get|update)PoolConfig"
    - from: "RuleForm.svelte"
      to: "configuredProviders prop"
      via: "$derived wrapper"
      pattern: "\\$derived.*configuredProviders"
---

<objective>
Fix three UAT-identified bugs in Phase 11 Configuration UI

Purpose: Close gaps between implemented code and expected behavior discovered during user acceptance testing
Output: All settings components functioning correctly without auth token mismatches, reactivity loss, or native dialogs
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@frontend/src/lib/api/client.ts (shared settings API with correct auth)
@frontend/src/lib/components/ui/confirm-dialog.svelte (existing ConfirmDialog component)
@frontend/src/lib/components/ui/index.ts (UI exports)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ModelPoolSettings auth token mismatch</name>
  <files>frontend/src/lib/components/settings/ModelPoolSettings.svelte</files>
  <action>
Replace local API helpers (lines 21-53) with imports from the shared settings client.

Current problem: The component defines local `getAuthHeaders()` that uses hardcoded localStorage key 'mlx_manager_token', but authStore uses 'mlx_auth_token'. This causes 401 errors on save.

Changes needed:
1. Add import: `import { settings } from '$lib/api/client';`
2. Remove lines 21-53 (the local API_BASE, getAuthHeaders, getPoolConfig, updatePoolConfig)
3. Update onMount to use `settings.getPoolConfig()` instead of local `getPoolConfig()`
4. Update handleSave to use `settings.updatePoolConfig()` instead of local `updatePoolConfig()`

The shared client correctly uses `authStore.token` which reads from the correct localStorage key.

Note: Keep the local type definitions (MemoryLimitMode, EvictionPolicy, ServerPoolConfig) as they match the shared types and provide local type safety.
  </action>
  <verify>
Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify TypeScript compiles.
Search for 'mlx_manager_token' in the file - should find 0 occurrences.
Search for `settings.getPoolConfig` - should find 1 occurrence.
  </verify>
  <done>ModelPoolSettings uses shared API client; no hardcoded token key; TypeScript passes</done>
</task>

<task type="auto">
  <name>Task 2: Fix RuleForm Svelte 5 reactivity for configuredProviders</name>
  <files>frontend/src/lib/components/settings/RuleForm.svelte</files>
  <action>
Fix reactivity loss from destructuring props in Svelte 5.

Current problem: Line 12 destructures `configuredProviders` from `$props()`, which breaks reactivity in Svelte 5. When parent's configuredProviders array changes, the warning doesn't update.

```svelte
// CURRENT (loses reactivity):
let { onSave, configuredProviders }: Props = $props();

const showWarning = $derived(
  backendType !== 'local' && !configuredProviders.includes(backendType)
);
```

Fix: Access configuredProviders through the props object to maintain reactivity.

```svelte
// FIXED (maintains reactivity):
let props = $props<Props>();

const showWarning = $derived(
  props.backendType !== 'local' && !props.configuredProviders.includes(backendType)
);
```

Alternative approach - use $derived.by() for the prop access:

```svelte
let { onSave, configuredProviders }: Props = $props();

// Wrap in $derived to maintain reactivity
const providers = $derived(configuredProviders);

const showWarning = $derived(
  backendType !== 'local' && !providers.includes(backendType)
);
```

Choose the approach that requires minimal changes. The key is ensuring configuredProviders is accessed reactively.

Also update the onSave call at line 54 to use `props.onSave()` if using the props object approach.
  </action>
  <verify>
Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify TypeScript compiles.
Verify the component still builds and the showWarning derived uses reactive access.
  </verify>
  <done>RuleForm maintains reactivity for configuredProviders; warning updates when providers change</done>
</task>

<task type="auto">
  <name>Task 3: Replace native confirm() with ConfirmDialog in delete flows</name>
  <files>
    frontend/src/lib/components/settings/RoutingRulesSection.svelte
    frontend/src/lib/components/settings/ProviderForm.svelte
  </files>
  <action>
Replace native browser dialogs with the existing ConfirmDialog component for consistent UX.

**RoutingRulesSection.svelte** (line 86 uses `confirm()`):

1. Add import: `import { ConfirmDialog } from '$components/ui';`
2. Add state for dialog:
   ```svelte
   let deleteDialogOpen = $state(false);
   let ruleToDelete = $state<number | null>(null);
   ```
3. Replace handleDelete function:
   ```svelte
   function requestDelete(ruleId: number) {
     ruleToDelete = ruleId;
     deleteDialogOpen = true;
   }

   async function confirmDelete() {
     if (ruleToDelete === null) return;
     try {
       await settings.deleteRule(ruleToDelete);
       await loadData();
     } catch (e) {
       error = e instanceof Error ? e.message : 'Failed to delete rule';
     }
     ruleToDelete = null;
   }

   function cancelDelete() {
     ruleToDelete = null;
   }
   ```
4. Update RuleCard onDelete prop to use `requestDelete`:
   ```svelte
   onDelete={() => requestDelete(item.rule.id)}
   ```
5. Add ConfirmDialog at bottom of template (before closing div):
   ```svelte
   <ConfirmDialog
     bind:open={deleteDialogOpen}
     title="Delete Routing Rule"
     description="Are you sure you want to delete this routing rule? This action cannot be undone."
     confirmLabel="Delete"
     variant="destructive"
     onConfirm={confirmDelete}
     onCancel={cancelDelete}
   />
   ```

**ProviderForm.svelte** (lines 98-113 delete without confirmation):

1. Add import: `import { ConfirmDialog } from '$components/ui';`
2. Add state:
   ```svelte
   let deleteDialogOpen = $state(false);
   ```
3. Split handleDelete into request and confirm:
   ```svelte
   function requestDelete() {
     deleteDialogOpen = true;
   }

   async function confirmDelete() {
     if (!existingCredential) return;
     deleting = true;
     error = null;
     try {
       await settings.deleteProvider(backendType);
       testResult = null;
       onDelete();
     } catch (e) {
       error = e instanceof Error ? e.message : 'Failed to delete credentials';
     } finally {
       deleting = false;
     }
   }
   ```
4. Update Delete button onclick to use `requestDelete`:
   ```svelte
   <Button onclick={requestDelete} ...>
   ```
5. Add ConfirmDialog at bottom of template:
   ```svelte
   <ConfirmDialog
     bind:open={deleteDialogOpen}
     title="Delete Provider Credentials"
     description="Are you sure you want to delete the {backendType === 'openai' ? 'OpenAI' : 'Anthropic'} credentials? You will need to re-enter your API key to use this provider again."
     confirmLabel="Delete"
     variant="destructive"
     onConfirm={confirmDelete}
     onCancel={() => {}}
   />
   ```
  </action>
  <verify>
Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify TypeScript compiles.
Search for 'confirm(' in both files - should find 0 occurrences of native confirm.
Search for 'ConfirmDialog' in both files - should find imports and usage.
  </verify>
  <done>Both delete flows use styled ConfirmDialog; no native confirm() calls remain</done>
</task>

</tasks>

<verification>
All three UAT bugs resolved:
1. `grep -r "mlx_manager_token" frontend/src/lib/components/settings/` returns empty
2. `npm run check` in frontend passes
3. `grep -r "confirm(" frontend/src/lib/components/settings/*.svelte` returns only ConfirmDialog references, no native calls
</verification>

<success_criteria>
- Model pool Save button works (no 401 errors)
- Provider warning in RuleForm updates reactively when backend changes
- All delete confirmations use styled ConfirmDialog, not native browser dialogs
- All TypeScript/Svelte checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-configuration-ui/11-06-SUMMARY.md`
</output>
