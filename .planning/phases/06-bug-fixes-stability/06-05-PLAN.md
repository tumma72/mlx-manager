---
phase: 06-bug-fixes-stability
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - backend/mlx_manager/models.py
  - backend/mlx_manager/routers/profiles.py
  - frontend/src/lib/api/types.ts
  - frontend/src/lib/components/profiles/ProfileForm.svelte
  - frontend/src/routes/(protected)/chat/+page.svelte
autonomous: true

must_haves:
  truths:
    - "Profile model description uses a textarea (multi-line) instead of single-line input"
    - "Profile has a system_prompt field that persists in the database"
    - "When a profile with system_prompt is used in chat, the prompt appears as a pinned first message"
    - "System prompt message is visually distinct (grayed-out) and cannot be edited in chat"
    - "If no system prompt is set, a dismissible hint suggests setting one in profile settings"
  artifacts:
    - path: "backend/mlx_manager/models.py"
      provides: "system_prompt field on ServerProfile"
      contains: "system_prompt"
    - path: "frontend/src/lib/components/profiles/ProfileForm.svelte"
      provides: "Textarea for description and system prompt fields"
      contains: "textarea"
    - path: "frontend/src/routes/(protected)/chat/+page.svelte"
      provides: "Pinned system prompt message in chat"
      contains: "system.*prompt"
  key_links:
    - from: "frontend/src/routes/(protected)/chat/+page.svelte"
      to: "selectedProfile.system_prompt"
      via: "profile data access"
      pattern: "system_prompt"
    - from: "frontend/src/lib/components/profiles/ProfileForm.svelte"
      to: "backend/mlx_manager/models.py"
      via: "API profile create/update"
      pattern: "system_prompt"
---

<objective>
Add profile system prompt field and change description to textarea. Display system prompt as a pinned first message in chat.

Purpose: Enable users to configure a default system prompt per profile (used when starting conversations) and provide multi-line description editing. The system prompt appears in chat as context for the model's behavior.
Output: Backend model with system_prompt field; ProfileForm with textarea description and system prompt; Chat page with pinned system prompt display.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-bug-fixes-stability/06-CONTEXT.md
@backend/mlx_manager/models.py
@frontend/src/lib/api/types.ts
@frontend/src/lib/components/profiles/ProfileForm.svelte
@frontend/src/routes/(protected)/chat/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add system_prompt field to backend model and API</name>
  <files>
    backend/mlx_manager/models.py
    backend/mlx_manager/routers/profiles.py
  </files>
  <action>
    1. In `models.py`, add `system_prompt: str | None = None` to `ServerProfileBase` (after `auto_start`):
    ```python
    system_prompt: str | None = None
    ```

    2. In `ServerProfileUpdate`, add:
    ```python
    system_prompt: str | None = None
    ```

    3. The field will automatically be included in the API response (ServerProfileResponse inherits from ServerProfileBase) and accepted in create/update requests.

    4. Since SQLModel handles migrations via table recreation for SQLite, adding a nullable field is safe. However, since we're using SQLite and the table already exists, we need to handle the migration. Add an alembic migration or use the existing pattern: check if the database.py initialization handles schema updates. Looking at the codebase, it uses `SQLModel.metadata.create_all()` which only creates new tables, not alter existing ones.

    **Migration approach**: Add a simple migration in the lifespan handler (main.py) or database.py initialization that adds the column if it doesn't exist:
    ```python
    # In database initialization or lifespan
    async with engine.begin() as conn:
        # Add system_prompt column if not exists (SQLite compatible)
        try:
            await conn.execute(text("ALTER TABLE server_profiles ADD COLUMN system_prompt TEXT"))
        except Exception:
            pass  # Column already exists
    ```

    Add this migration in `database.py` alongside any existing migrations, or in the lifespan startup in `main.py`.
  </action>
  <verify>
    Run `cd backend && ruff check . && ruff format --check . && mypy mlx_manager` — no errors.
    Run `pytest -v` — all tests pass.
    Test: Create a profile with `system_prompt: "You are a helpful coding assistant"` via API, verify it persists.
  </verify>
  <done>ServerProfile model has system_prompt field. API accepts and returns system_prompt in create/update/get operations. Existing database is migrated safely.</done>
</task>

<task type="auto">
  <name>Task 2: Update ProfileForm with textarea and system prompt</name>
  <files>
    frontend/src/lib/api/types.ts
    frontend/src/lib/components/profiles/ProfileForm.svelte
  </files>
  <action>
    1. In `types.ts`, add `system_prompt: string | null;` to `ServerProfile` interface, and `system_prompt?: string;` to `ServerProfileCreate` and `ServerProfileUpdate`.

    2. In `ProfileForm.svelte`:

    a) **Change description from Input to textarea**: Replace line 191:
    ```svelte
    <Input id="description" bind:value={description} placeholder="Optional description" />
    ```
    With a textarea (using similar styling to Input component but multi-line):
    ```svelte
    <textarea
      id="description"
      bind:value={description}
      placeholder="Optional description"
      rows="2"
      class="flex w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
    ></textarea>
    ```

    b) **Add system_prompt field**: After the description field, add a new section:
    ```svelte
    <div>
      <label for="systemPrompt" class="block text-sm font-medium mb-1">
        System Prompt
        {#if systemPrompt.length > 0}
          <span class="text-xs text-muted-foreground ml-2">
            {systemPrompt.length} chars
            {#if systemPrompt.length > 2000}
              <span class="text-amber-500">(long prompt may affect performance)</span>
            {/if}
          </span>
        {/if}
      </label>
      <textarea
        id="systemPrompt"
        bind:value={systemPrompt}
        placeholder="e.g., You are a helpful coding assistant specializing in Python..."
        rows="4"
        class="flex w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
      ></textarea>
      <p class="text-xs text-muted-foreground mt-1">
        Sets the model's behavior context. Appears as first message when chatting.
      </p>
    </div>
    ```

    c) **Add state variable**: `let systemPrompt = $state('');`

    d) **Initialize in effect**: Add `systemPrompt = profile?.system_prompt ?? '';` to the reset effect.

    e) **Include in submit data**: Add `system_prompt: systemPrompt || undefined` to the data object in handleSubmit.
  </action>
  <verify>
    Run `cd frontend && npm run check && npm run lint` — no errors.
    Visual check: Profile form shows textarea for description (multi-line), system prompt textarea with character counter, and warning at >2000 chars.
  </verify>
  <done>ProfileForm uses textarea for description (multi-line). System prompt field with character counter and soft limit warning is present. Data flows correctly through create/update API calls.</done>
</task>

<task type="auto">
  <name>Task 3: Display system prompt as pinned message in chat</name>
  <files>frontend/src/routes/(protected)/chat/+page.svelte</files>
  <action>
    1. **Pinned system prompt message**: When a profile is selected and has a system_prompt, display it as a visually distinct first message in the chat area. Add this above the messages loop:

    ```svelte
    {#if selectedProfile?.system_prompt}
      <div class="flex gap-3 opacity-60">
        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-muted flex items-center justify-center">
          <Bot class="w-4 h-4 text-muted-foreground" />
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-xs text-muted-foreground mb-1 italic">System Prompt</p>
          <div class="text-sm text-muted-foreground italic whitespace-pre-wrap">
            {selectedProfile.system_prompt}
          </div>
        </div>
      </div>
    {:else if selectedProfile && !selectedProfile.system_prompt}
      <div class="flex items-center gap-2 text-xs text-muted-foreground bg-muted/50 rounded-lg px-3 py-2" id="system-prompt-hint">
        <AlertCircle class="w-3 h-3" />
        <span>No system prompt set.</span>
        <a href="/profiles/{selectedProfile.id}" class="text-primary hover:underline">Set one in profile settings</a>
        <button
          class="ml-auto text-muted-foreground hover:text-foreground"
          onclick={(e) => { (e.currentTarget.closest('#system-prompt-hint') as HTMLElement)?.remove() }}
        >
          <X class="w-3 h-3" />
        </button>
      </div>
    {/if}
    ```

    2. **Include system prompt in API messages**: When sending the first message to the chat API, prepend the system prompt as a system message:
    ```typescript
    // In the send function, before building the messages array:
    const apiMessages = [];
    if (selectedProfile?.system_prompt) {
      apiMessages.push({ role: 'system', content: selectedProfile.system_prompt });
    }
    // Add all user/assistant messages
    apiMessages.push(...messages.map(m => ({ role: m.role, content: m.content })));
    apiMessages.push({ role: 'user', content: userContent });
    ```

    3. **Dismissible hint**: The "no system prompt" hint is dismissible by clicking X. It simply removes itself from DOM (session-persistent dismissal — reappears on page reload which is acceptable).
  </action>
  <verify>
    Run `cd frontend && npm run check && npm run lint` — no errors.
    Visual check:
    - Select a profile with system_prompt → see grayed-out italic pinned message at top
    - Select a profile without system_prompt → see dismissible hint with link to profile settings
    - Send a message → system prompt is included as first message in API call
    - Dismiss hint → it disappears for the session
  </verify>
  <done>System prompt displays as a pinned, grayed-out first message in chat. Hint shows when no system prompt is set with link to profile settings. System prompt is sent as system message in API calls.</done>
</task>

</tasks>

<verification>
- Backend: `cd backend && ruff check . && mypy mlx_manager && pytest -v` all pass
- Frontend: `cd frontend && npm run check && npm run lint && npm run test` all pass
- Profile form shows textarea for description and system prompt with character counter
- Chat page shows pinned system prompt or dismissible hint
- System prompt is included in chat API calls
</verification>

<success_criteria>
- Description field is a multi-line textarea
- System prompt field persists in database and API
- Chat shows pinned system prompt (grayed-out, italic)
- Missing system prompt shows dismissible hint
- System prompt sent as system message to model
- All quality checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes-stability/06-05-SUMMARY.md`
</output>
