---
phase: 06-bug-fixes-stability
plan: 15
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/routes/(protected)/chat/+page.svelte
  - frontend/src/lib/stores/models.svelte.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Text file attachments work for .log, .md, .csv, .json, .xml, .yaml, .yml, .py, .js, .ts, .html, .css, .sh, .sql, .conf, .ini, .toml extensions"
    - "Error message for unsupported files lists accepted formats"
    - "Tool-use badge appears on models with tool-use/function-calling tags"
  artifacts:
    - path: "frontend/src/routes/(protected)/chat/+page.svelte"
      provides: "Extension-based text file validation"
      contains: "TEXT_EXTENSIONS"
    - path: "frontend/src/lib/stores/models.svelte.ts"
      provides: "Tool-use characteristic in fallback check"
      contains: "is_tool_use"
  key_links:
    - from: "addAttachment()"
      to: "TEXT_EXTENSIONS"
      via: "Extension extraction and Set.has() check"
      pattern: "TEXT_EXTENSIONS"
    - from: "fetchConfig() catch block"
      to: "hasAnyCharacteristic"
      via: "Fallback characteristics conditional storage"
      pattern: "hasAnyCharacteristic"
---

<objective>
Fix text file attachment validation to use extension-based detection (matching the acceptedFormats list) instead of unreliable mime-type checking, and add is_tool_use to the hasAnyCharacteristic fallback check so tool-use badges display correctly.

Purpose: macOS reports inconsistent mime types for many text files (.log, .md, .yaml, etc.) causing valid text files to be rejected. Extension-based validation is the reliable approach. The is_tool_use field needs to be included in the hasAnyCharacteristic check so models with only tool-use detected (no architecture/quantization/multimodal) still get their characteristics stored.

Output: All text file extensions in acceptedFormats are accepted as attachments. Error message lists supported formats. Tool-use badge displays for models with tool-use tags.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/src/routes/(protected)/chat/+page.svelte (addAttachment at line 119, acceptedFormats at line 53)
@frontend/src/lib/stores/models.svelte.ts (parseCharacteristicsFromName with TOOL_USE_PATTERNS at line 92, hasAnyCharacteristic at line 191)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extension-based text file validation</name>
  <files>frontend/src/routes/(protected)/chat/+page.svelte</files>
  <action>
    1. Add a constant near the top of the script block (after imports, before interface):
       ```typescript
       const TEXT_EXTENSIONS = new Set([
           'txt', 'md', 'csv', 'json', 'xml', 'yaml', 'yml',
           'log', 'py', 'js', 'ts', 'html', 'css', 'sh',
           'sql', 'conf', 'ini', 'toml'
       ]);
       ```

    2. In the addAttachment() function, replace the mime-type-based `isText` detection
       (lines 127-132) with extension-based detection:
       ```typescript
       const ext = file.name.split('.').pop()?.toLowerCase() || '';
       const isText = TEXT_EXTENSIONS.has(ext);
       ```

    3. Update the error message for unsupported file types (line 136) to list accepted formats:
       ```typescript
       const supported = isMultimodal
           ? 'images, videos, and text files (.txt, .md, .py, .js, .json, .csv, .log, etc.)'
           : 'text files (.txt, .md, .py, .js, .json, .csv, .log, .yaml, .xml, etc.)';
       chatError = { summary: `Unsupported file type. Accepted: ${supported}` };
       ```

    4. Keep the isVideo and isImage checks as mime-type based (they work correctly for
       media files). Only text detection switches to extension-based.
  </action>
  <verify>
    Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify no type errors.
    Grep for "TEXT_EXTENSIONS" in the file to confirm the constant exists.
    Grep for "startsWith('text/')" - should NOT appear in addAttachment validation logic (may still exist elsewhere).
  </verify>
  <done>
    All text extensions from TEXT_EXTENSIONS set are accepted as attachments regardless of
    browser-reported mime type. Error message shows supported formats. Extension detection
    is the single source of truth for text file identification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add is_tool_use to hasAnyCharacteristic check</name>
  <files>frontend/src/lib/stores/models.svelte.ts</files>
  <action>
    In the fetchConfig() method's catch block (around line 191-194), add `is_tool_use` to
    the hasAnyCharacteristic check. This ensures models with only tool-use detected (no
    architecture/quantization/multimodal) still get their fallback characteristics stored
    and displayed.

    Update the hasAnyCharacteristic constant from:
    ```typescript
    const hasAnyCharacteristic =
        fallbackCharacteristics.architecture_family ||
        fallbackCharacteristics.quantization_bits ||
        fallbackCharacteristics.is_multimodal;
    ```

    To:
    ```typescript
    const hasAnyCharacteristic =
        fallbackCharacteristics.architecture_family ||
        fallbackCharacteristics.quantization_bits ||
        fallbackCharacteristics.is_multimodal ||
        fallbackCharacteristics.is_tool_use;
    ```

    This is an unconditional fix - the field is confirmed missing from the current code
    (checker verified lines 191-194 do not include is_tool_use).
  </action>
  <verify>
    Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify no type errors.
    Grep for "is_tool_use" in models.svelte.ts - should appear in TOOL_USE_PATTERNS section AND in hasAnyCharacteristic check (around line 194).
  </verify>
  <done>
    hasAnyCharacteristic includes is_tool_use. Models with tool-use tags get fallback
    characteristics stored even when backend returns 404 for config.json. Tool-use badge
    displays correctly for models with function-calling/tool-use/tool-calling tags.
  </done>
</task>

</tasks>

<verification>
- `npm run check` passes in frontend
- TEXT_EXTENSIONS constant defined with all 18 extensions
- addAttachment uses extension-based detection for text files
- Error message includes list of supported formats
- is_tool_use included in hasAnyCharacteristic fallback check at line ~194
</verification>

<success_criteria>
- Files with .log, .md, .yaml, .yml, .toml extensions accepted as text attachments
- Unsupported file error shows accepted format list
- Tool-use badge renders for models with tool-use/function-calling tags (via fallback detection)
- No type errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes-stability/06-15-SUMMARY.md`
</output>
