---
phase: 06-bug-fixes-stability
plan: 15
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/routes/(protected)/chat/+page.svelte
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Text file attachments work for .log, .md, .csv, .json, .xml, .yaml, .yml, .py, .js, .ts, .html, .css, .sh, .sql, .conf, .ini, .toml extensions"
    - "Error message for unsupported files lists accepted formats"
    - "Tool-use badge appears on models with tool-use/function-calling tags"
  artifacts:
    - path: "frontend/src/routes/(protected)/chat/+page.svelte"
      provides: "Extension-based text file validation"
      contains: "TEXT_EXTENSIONS"
  key_links:
    - from: "addAttachment()"
      to: "TEXT_EXTENSIONS"
      via: "Extension extraction and Set.has() check"
      pattern: "TEXT_EXTENSIONS"
---

<objective>
Fix text file attachment validation to use extension-based detection (matching the acceptedFormats list) instead of unreliable mime-type checking, and verify the tool-use badge fix already applied by the debug agent.

Purpose: macOS reports inconsistent mime types for many text files (.log, .md, .yaml, etc.) causing valid text files to be rejected. Extension-based validation is the reliable approach. The tool-use badge fix was already applied to models.svelte.ts and database.py by a debug agent but needs verification.

Output: All text file extensions in acceptedFormats are accepted as attachments. Error message lists supported formats.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/src/routes/(protected)/chat/+page.svelte (addAttachment at line 119, acceptedFormats at line 53)
@frontend/src/lib/stores/models.svelte.ts (parseCharacteristicsFromName with TOOL_USE_PATTERNS at line 92)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extension-based text file validation</name>
  <files>frontend/src/routes/(protected)/chat/+page.svelte</files>
  <action>
    1. Add a constant near the top of the script block (after imports, before interface):
       ```typescript
       const TEXT_EXTENSIONS = new Set([
           'txt', 'md', 'csv', 'json', 'xml', 'yaml', 'yml',
           'log', 'py', 'js', 'ts', 'html', 'css', 'sh',
           'sql', 'conf', 'ini', 'toml'
       ]);
       ```

    2. In the addAttachment() function, replace the mime-type-based `isText` detection
       (lines 127-132) with extension-based detection:
       ```typescript
       const ext = file.name.split('.').pop()?.toLowerCase() || '';
       const isText = TEXT_EXTENSIONS.has(ext);
       ```

    3. Update the error message for unsupported file types (line 136) to list accepted formats:
       ```typescript
       const supported = isMultimodal
           ? 'images, videos, and text files (.txt, .md, .py, .js, .json, .csv, .log, etc.)'
           : 'text files (.txt, .md, .py, .js, .json, .csv, .log, .yaml, .xml, etc.)';
       chatError = { summary: `Unsupported file type. Accepted: ${supported}` };
       ```

    4. Keep the isVideo and isImage checks as mime-type based (they work correctly for
       media files). Only text detection switches to extension-based.
  </action>
  <verify>
    Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify no type errors.
    Grep for "TEXT_EXTENSIONS" in the file to confirm the constant exists.
    Grep for "startsWith('text/')" - should NOT appear in addAttachment validation logic (may still exist elsewhere).
  </verify>
  <done>
    All text extensions from TEXT_EXTENSIONS set are accepted as attachments regardless of
    browser-reported mime type. Error message shows supported formats. Extension detection
    is the single source of truth for text file identification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify tool-use badge detection works</name>
  <files>frontend/src/lib/stores/models.svelte.ts</files>
  <action>
    Verify the debug agent's fix is in place by confirming:
    1. TOOL_USE_PATTERNS array exists (lines 92-97) with patterns for tool-use, function-calling, tool-calling, tools
    2. parseCharacteristicsFromName() iterates TOOL_USE_PATTERNS and sets characteristics.is_tool_use = true (lines 137-143)
    3. In ModelConfigStore.fetchConfig() catch block, the hasAnyCharacteristic check includes
       `fallbackCharacteristics.is_tool_use` in the OR condition (line 191-193)

    If the hasAnyCharacteristic check at line 191-193 does NOT include is_tool_use, add it:
    ```typescript
    const hasAnyCharacteristic =
        fallbackCharacteristics.architecture_family ||
        fallbackCharacteristics.quantization_bits ||
        fallbackCharacteristics.is_multimodal ||
        fallbackCharacteristics.is_tool_use;
    ```

    This ensures models with only tool-use detected (no architecture/quantization/multimodal)
    still get their fallback characteristics stored and displayed.
  </action>
  <verify>
    Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify no type errors.
    Grep for "is_tool_use" in models.svelte.ts - should appear in TOOL_USE_PATTERNS section AND in hasAnyCharacteristic check.
  </verify>
  <done>
    parseCharacteristicsFromName() detects tool-use from tags. hasAnyCharacteristic includes
    is_tool_use. Models with tool-use tags get fallback characteristics stored even when
    backend returns 404 for config.json.
  </done>
</task>

</tasks>

<verification>
- `npm run check` passes in frontend
- TEXT_EXTENSIONS constant defined with all 18 extensions
- addAttachment uses extension-based detection for text files
- Error message includes list of supported formats
- is_tool_use included in hasAnyCharacteristic fallback check
</verification>

<success_criteria>
- Files with .log, .md, .yaml, .yml, .toml extensions accepted as text attachments
- Unsupported file error shows accepted format list
- Tool-use badge renders for models with tool-use/function-calling tags (via fallback detection)
- No type errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes-stability/06-15-SUMMARY.md`
</output>
