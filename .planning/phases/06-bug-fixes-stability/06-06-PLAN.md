---
phase: 06-bug-fixes-stability
plan: 06
type: execute
wave: 3
depends_on: ["06-05"]
files_modified:
  - frontend/src/routes/(protected)/chat/+page.svelte
autonomous: true

must_haves:
  truths:
    - "When a model fails to respond (still loading), chat shows retry progress with attempt count"
    - "Up to 3 retry attempts with linear backoff (increasing wait between attempts)"
    - "After all retries fail, an error message with 'Retry' button appears in chat"
    - "User can click Retry to resend without leaving the chat page"
    - "Chat input remains functional during and after retry failures"
  artifacts:
    - path: "frontend/src/routes/(protected)/chat/+page.svelte"
      provides: "Retry logic with backoff for model loading"
      contains: "attempt.*retry|Connecting to model"
  key_links:
    - from: "frontend/src/routes/(protected)/chat/+page.svelte"
      to: "/api/chat/completions"
      via: "fetch with retry"
      pattern: "attempt|retry"
---

<objective>
Add retry-with-backoff logic to chat when model is still loading, with progress indication and a manual retry button on failure.

Purpose: Models marked as "started" in the server panel may still be loading into memory. The chat should gracefully handle this timing gap by retrying with linear backoff rather than immediately showing an error.
Output: Chat page with automatic retry on connection/server errors, progress UI, and manual retry fallback.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-bug-fixes-stability/06-CONTEXT.md
@frontend/src/routes/(protected)/chat/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry-with-backoff to chat send function</name>
  <files>frontend/src/routes/(protected)/chat/+page.svelte</files>
  <action>
    Modify the message send function to implement retry-with-backoff when the model server returns errors (indicating model is still loading):

    1. **Add retry state variables:**
    ```typescript
    let retryAttempt = $state(0);
    let retryMax = 3;
    let isRetrying = $state(false);
    let lastFailedMessage = $state<{ content: string | ContentPart[]; attachments: Attachment[] } | null>(null);
    ```

    2. **Create a retry-aware send function:**
    ```typescript
    async function sendWithRetry(userContent: string | ContentPart[], userAttachments: Attachment[], attempt: number = 1): Promise<boolean> {
      retryAttempt = attempt;
      isRetrying = attempt > 1;

      try {
        // ... existing fetch to /api/chat/completions ...

        const response = await fetch('/api/chat/completions', { ... });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        // Process SSE stream as before...
        // On success, reset retry state
        retryAttempt = 0;
        isRetrying = false;
        lastFailedMessage = null;
        return true;

      } catch (error) {
        if (attempt < retryMax) {
          // Linear backoff: 2s, 4s, 6s
          const waitMs = attempt * 2000;
          await new Promise(resolve => setTimeout(resolve, waitMs));
          return sendWithRetry(userContent, userAttachments, attempt + 1);
        }

        // All retries exhausted
        retryAttempt = 0;
        isRetrying = false;
        lastFailedMessage = { content: userContent, attachments: userAttachments };

        // Show error in chat area
        chatError = {
          summary: 'Failed to connect to model after 3 attempts',
          details: `The model may still be loading. Check the Servers page for status.\n\nError: ${error instanceof Error ? error.message : String(error)}`
        };

        return false;
      }
    }
    ```

    3. **Update the main send handler** to use `sendWithRetry()` instead of direct fetch. The existing `handleSend` function should call `sendWithRetry(userContent, attachments, 1)`.

    4. **Add retry progress indicator** in the chat area (shown during retrying):
    ```svelte
    {#if isRetrying}
      <div class="flex items-center gap-2 text-sm text-muted-foreground animate-pulse px-4 py-2">
        <Loader2 class="w-4 h-4 animate-spin" />
        <span>Connecting to model... (attempt {retryAttempt}/{retryMax})</span>
      </div>
    {/if}
    ```

    5. **Add retry button in error state**: When `lastFailedMessage` is set, show a "Retry" button that calls `sendWithRetry(lastFailedMessage.content, lastFailedMessage.attachments, 1)`:
    ```svelte
    {#if lastFailedMessage}
      <div class="flex justify-center py-2">
        <Button
          variant="outline"
          size="sm"
          onclick={() => {
            if (lastFailedMessage) {
              chatError = null;
              sendWithRetry(lastFailedMessage.content, lastFailedMessage.attachments, 1);
            }
          }}
        >
          Retry
        </Button>
      </div>
    {/if}
    ```

    6. **Keep input functional**: The chat input should remain enabled even during retry. User can type and send new messages (which will also trigger retry logic if model isn't ready).

    7. **Only retry on connection/server errors**: Don't retry on 401 (auth), 400 (bad request), or other client errors. Only retry on network errors, 502, 503, 504, or connection refused.
  </action>
  <verify>
    Run `cd frontend && npm run check && npm run lint` — no errors.
    Manual test:
    1. Start a large model that takes time to load
    2. Immediately navigate to chat and send a message
    3. Observe: "Connecting to model... (attempt 1/3)" → wait → "(attempt 2/3)" → etc.
    4. If model loads during retries: message sends successfully
    5. If all retries fail: error shown with Retry button
    6. Click Retry: attempts again
  </verify>
  <done>Chat gracefully handles model loading with retry-with-backoff. Progress shown during attempts. Retry button available after failure. Input remains functional throughout.</done>
</task>

</tasks>

<verification>
- `cd frontend && npm run check && npm run lint && npm run test` all pass
- Chat shows retry progress when model isn't ready
- After 3 failed attempts, error with Retry button appears
- Retry button works to resend the message
- Chat input remains functional during and after failures
</verification>

<success_criteria>
- Retry with linear backoff (2s, 4s, 6s) on server/connection errors
- Progress indicator shows current attempt
- Manual Retry button after all attempts fail
- Chat input stays enabled throughout
- Only retries on server/network errors (not client errors)
- All quality checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes-stability/06-06-SUMMARY.md`
</output>
