---
phase: 06-bug-fixes-stability
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/routes/(protected)/chat/+page.svelte
  - frontend/src/lib/api/types.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Text file attachments are sent as text content parts, not base64 image_url"
    - "Text files read via FileReader.readAsText() and included as {type: 'text', text: content}"
    - "Image/video attachments still sent as base64 image_url"
  artifacts:
    - path: "frontend/src/routes/(protected)/chat/+page.svelte"
      provides: "buildMessageContent handling text vs image attachments"
      contains: "readAsText"
    - path: "frontend/src/lib/api/types.ts"
      provides: "ContentPart type supporting text parts"
      contains: "type.*text.*image_url"
  key_links:
    - from: "frontend/src/routes/(protected)/chat/+page.svelte"
      to: "frontend/src/lib/api/types.ts"
      via: "ContentPart type"
      pattern: "ContentPart"
---

<objective>
Fix text file attachments being sent to the model as base64 image_url (which the model cannot read) by reading them as plain text and including as text content parts.

Purpose: Users attach .txt/.py/.json files expecting the model to read their contents
Output: Text attachments sent as readable text, images still sent as base64
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@frontend/src/routes/(protected)/chat/+page.svelte
@frontend/src/lib/api/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix buildMessageContent to handle text attachments</name>
  <files>
    frontend/src/routes/(protected)/chat/+page.svelte
    frontend/src/lib/api/types.ts
  </files>
  <action>
    1. The ContentPart type in types.ts already supports `type: "text"` with `text?: string`. No type changes needed - the existing type is sufficient.

    2. In chat/+page.svelte, add a helper function to read a file as text (near line 185, after encodeFileAsBase64):

    ```typescript
    async function readFileAsText(file: File): Promise<string> {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result as string);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }
    ```

    3. Modify `buildMessageContent` (lines 194-210) to branch on attachment type:

    ```typescript
    async function buildMessageContent(text: string, currentAttachments: Attachment[]): Promise<string | ContentPart[]> {
      if (currentAttachments.length === 0) {
        return text;
      }

      const parts: ContentPart[] = [{ type: 'text', text }];

      for (const attachment of currentAttachments) {
        if (attachment.type === 'text') {
          // Read text files as plain text and include inline
          const fileContent = await readFileAsText(attachment.file);
          parts.push({
            type: 'text',
            text: `[File: ${attachment.file.name}]\n${fileContent}`
          });
        } else {
          // Images and videos: encode as base64 data URL
          const base64 = await encodeFileAsBase64(attachment.file);
          parts.push({
            type: 'image_url',
            image_url: { url: base64 }
          });
        }
      }

      return parts;
    }
    ```

    This handles the three attachment types correctly:
    - `type: 'text'` -> readAsText, include as text content part with filename header
    - `type: 'image'` -> readAsDataURL, include as image_url part
    - `type: 'video'` -> readAsDataURL, include as image_url part (model handles video frames)
  </action>
  <verify>
    Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify TypeScript compiles.
  </verify>
  <done>
    - Text attachments (.txt, .py, .json, etc.) read as plain text
    - Text content sent as `{type: 'text', text: '[File: name]\ncontent'}`
    - Image/video attachments still encoded as base64 image_url
    - Model receives readable text file contents
  </done>
</task>

</tasks>

<verification>
- `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` passes
- `cd /Users/atomasini/Development/mlx-manager/frontend && npm run lint` passes
- grep confirms `readAsText` in chat page
- grep confirms `attachment.type === 'text'` branching logic
</verification>

<success_criteria>
- Text files sent as readable text content parts
- Image files still sent as base64 image_url parts
- Video files still sent as base64 image_url parts
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes-stability/06-10-SUMMARY.md`
</output>
