---
phase: 06-bug-fixes-stability
plan: 14
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/components/servers/StartingTile.svelte
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "No browser console errors during server startup health check polling"
    - "Server startup detection still works (model loaded -> tile transitions to running)"
    - "Timeout detection still works (2 minutes -> error tile)"
  artifacts:
    - path: "frontend/src/lib/components/servers/StartingTile.svelte"
      provides: "Backend-mediated health polling during startup"
      contains: "servers.health"
  key_links:
    - from: "frontend/src/lib/components/servers/StartingTile.svelte"
      to: "/api/servers/{id}/health"
      via: "API client servers.health() call"
      pattern: "servers\\.health"
---

<objective>
Eliminate browser console errors during server startup by switching from direct fetch() to the mlx-server /v1/models endpoint to using the existing backend-mediated health API (GET /api/servers/{id}/health).

Purpose: Browser fetch() to a not-yet-ready server logs network errors at the native level before JS can catch them. The backend already has a health endpoint that checks the server internally via httpx, so the frontend should poll that instead.

Output: StartingTile.svelte uses servers.health() instead of direct fetch(), eliminating console noise.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/src/lib/components/servers/StartingTile.svelte
@frontend/src/lib/api/client.ts (servers.health method at line 350)
@frontend/src/lib/api/types.ts (HealthStatus interface at line 160)
@backend/mlx_manager/routers/servers.py (health endpoint at line 180)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify health API exists in client.ts</name>
  <files>frontend/src/lib/api/client.ts</files>
  <action>
    Confirm that the `servers.health(profileId: number)` method exists in the servers API
    section of client.ts (around line 350). The method should:
    - Accept a profileId parameter
    - Call GET /api/servers/{profileId}/health
    - Return Promise<HealthStatus>

    If the method does not exist, add it to the servers export object following the pattern
    of other server methods (start, stop, restart, status).

    Do NOT modify the file if the method already exists as expected.
  </action>
  <verify>
    Grep for "health:" in frontend/src/lib/api/client.ts to confirm the method exists.
    Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify types are correct.
  </verify>
  <done>
    The servers.health() method exists and returns Promise<HealthStatus>. No changes needed
    if already present, or method added if missing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace direct fetch with backend health API call</name>
  <files>frontend/src/lib/components/servers/StartingTile.svelte</files>
  <action>
    In StartingTile.svelte, replace the direct fetch() block (lines 139-155) that calls
    `http://${profile.host}:${profile.port}/v1/models` with a call to the existing
    `servers.health(profile.id)` method from the API client.

    The health endpoint returns `{ status, model_loaded, response_time_ms, error }`.
    Check `response.model_loaded === true` to determine if the model is ready (equivalent
    to the current check for data.data.length > 0).

    Specifically:
    1. Add servers import at the top (if not already present):
       ```typescript
       import { servers } from '$lib/api/client';
       ```

    2. Replace the inner try/catch block (lines 139-155) with:
       ```typescript
       const healthStatus = await servers.health(profile.id);
       if (healthStatus.status === 'healthy' && healthStatus.model_loaded) {
           serverStore.markStartupSuccess(profile.id);
           isPolling = false;
           pollTimeoutId = null;
           serverStore.stopProfilePolling(profile.id);
           return;
       }
       ```

    3. Keep the outer try/catch that handles servers.status() failures
    4. Remove the `healthCheckReady` state variable and the INITIAL_HEALTH_DELAY_MS constant
       since the backend handles connection errors internally without browser console noise
    5. Keep the first status check via servers.status() to confirm PID is running
    6. After PID confirmed, poll immediately with servers.health() (no delay needed since
       backend-side httpx errors don't show in browser console)
    7. Keep POLL_INTERVAL_MS at 3000ms between health checks

    The health API catches connection errors server-side and returns
    { status: "unhealthy", error: "..." } instead of throwing, so no browser console errors.
  </action>
  <verify>
    Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify no type errors.
    Visually confirm: no `fetch()` calls to `profile.host:profile.port` remain in StartingTile.svelte.
    Grep the file for "v1/models" - should return no matches.
    Grep the file for "servers.health" - should return matches.
  </verify>
  <done>
    StartingTile.svelte polls backend health API exclusively. No direct browser fetch to
    the mlx-server port. healthCheckReady state removed. INITIAL_HEALTH_DELAY_MS removed.
    Uses servers.health() from API client.
  </done>
</task>

</tasks>

<verification>
- `npm run check` passes in frontend
- No `fetch(` calls to dynamic server URLs remain in StartingTile.svelte
- No reference to `/v1/models` in StartingTile.svelte
- `servers.health` is called for health checking (not serversApi.health)
- servers import added to StartingTile.svelte
</verification>

<success_criteria>
- StartingTile uses only backend API for health polling (no direct fetch to server port)
- Model-loaded detection works: health.model_loaded === true triggers success
- Timeout still works: 2-minute timeout unchanged
- No type errors from svelte-check
- Correct import name used (servers, not serversApi)
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes-stability/06-14-SUMMARY.md`
</output>
