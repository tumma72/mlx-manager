---
phase: 06-bug-fixes-stability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/mlx_manager/services/hf_client.py
  - backend/mlx_manager/services/health_checker.py
  - backend/mlx_manager/services/launchd.py
  - backend/mlx_manager/services/auth_service.py
  - backend/mlx_manager/database.py
  - backend/mlx_manager/routers/servers.py
  - backend/mlx_manager/routers/system.py
  - backend/mlx_manager/menubar.py
autonomous: true

must_haves:
  truths:
    - "All bare `except: pass` blocks log the exception with appropriate level"
    - "No `assert` statements used for request validation in router endpoints"
    - "API returns proper HTTPException with status codes on invalid state"
  artifacts:
    - path: "backend/mlx_manager/services/hf_client.py"
      provides: "Logged exception handlers"
      contains: "logger.debug"
    - path: "backend/mlx_manager/routers/servers.py"
      provides: "HTTPException instead of assert"
      contains: "HTTPException(status_code=400"
  key_links:
    - from: "backend/mlx_manager/routers/servers.py"
      to: "HTTPException"
      via: "validation replacement"
      pattern: "raise HTTPException.*profile.id"
---

<objective>
Add proper logging to all silent exception handlers and replace assertion-based validation with proper HTTPException responses in API routers.

Purpose: Eliminate invisible failures that make debugging impossible, and ensure API endpoints return proper HTTP error responses instead of crashing with 500 on assertion failures.
Output: All `except: pass` blocks have logging; all `assert` statements in routers replaced with HTTPException.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/mlx_manager/services/hf_client.py
@backend/mlx_manager/services/health_checker.py
@backend/mlx_manager/services/launchd.py
@backend/mlx_manager/services/auth_service.py
@backend/mlx_manager/database.py
@backend/mlx_manager/routers/servers.py
@backend/mlx_manager/routers/system.py
@backend/mlx_manager/menubar.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add logging to silent exception handlers</name>
  <files>
    backend/mlx_manager/services/hf_client.py
    backend/mlx_manager/services/health_checker.py
    backend/mlx_manager/services/launchd.py
    backend/mlx_manager/services/auth_service.py
    backend/mlx_manager/database.py
    backend/mlx_manager/routers/system.py
    backend/mlx_manager/menubar.py
  </files>
  <action>
    Find all bare `except Exception: pass` and `except ...: pass` blocks that swallow exceptions silently, and add appropriate logging:

    1. **hf_client.py** (lines 109, 129, 235, 301): Add `logger.debug(f"...")` with context about what failed. These are non-critical (cache checks, size estimation fallbacks) so use debug level.

    2. **health_checker.py** (line 33): `except asyncio.CancelledError: pass` is correct (expected during shutdown). Line 42: Replace `print(f"Health check error: {e}")` with `logger.warning(f"Health check error for profile: {e}")`.

    3. **launchd.py** (line 88): `except subprocess.CalledProcessError: pass` — Add `logger.debug(f"launchctl bootout failed (may not be loaded): {e}")`.

    4. **auth_service.py** (line 58): `except jwt.InvalidTokenError: return None` — Add `logger.debug(f"Invalid JWT token: {e}")`.

    5. **database.py** (lines 135, 148): `except Exception: await session.rollback()` — Add `logger.error(f"Database session error, rolling back: {e}")`. Ensure `e` is captured in the except clause.

    6. **routers/system.py** (lines 109, 118): `except ImportError: pass` — Add `logger.debug(f"Optional dependency not available: {e}")`.

    7. **menubar.py** (line 72): `except Exception: return False` — Add `logger.debug(f"Server status check failed: {e}")`.

    Ensure each file has a logger instance. Most already do (`logger = logging.getLogger(__name__)`). For files that don't, add one at module level.
  </action>
  <verify>
    Run `cd backend && ruff check . && ruff format --check . && mypy mlx_manager` — no new errors.
    Run `grep -rn "except.*: *$\|except.*:\n *pass$" mlx_manager/` to verify no remaining bare handlers (excluding asyncio.CancelledError which is intentional).
  </verify>
  <done>All silent exception handlers have appropriate logging. No bare `except: pass` remains without a log statement (except asyncio.CancelledError in health_checker which is expected behavior).</done>
</task>

<task type="auto">
  <name>Task 2: Replace assertions with HTTPException in routers</name>
  <files>backend/mlx_manager/routers/servers.py</files>
  <action>
    Replace all 4 `assert profile.id is not None` statements in servers.py with proper HTTPException:

    Lines 86, 147, 185, 203 — Replace each with:
    ```python
    if profile.id is None:
        raise HTTPException(status_code=400, detail="Profile must be saved before this operation")
    ```

    Also check `server_manager.py` line 30 which has `assert profile.id is not None, "Profile must be saved before starting server"`. This is in business logic (not a router), but since it's called from the router, it should be handled gracefully. Replace with:
    ```python
    if profile.id is None:
        raise ValueError("Profile must be saved before starting server")
    ```
    The router already catches RuntimeError from start_server and converts to HTTPException, so ValueError will be caught by the generic `except Exception as e` handler.

    Note: Do NOT remove the assert in server_manager.py if it's truly an internal invariant. Since it's called from routers that already validate, it can stay as a defensive check. But change it from assert to an explicit if/raise for clarity.
  </action>
  <verify>
    Run `cd backend && grep -n "assert " mlx_manager/routers/*.py` — should return no results.
    Run `pytest -v` — all existing tests pass.
    Run `ruff check . && mypy mlx_manager` — no errors.
  </verify>
  <done>No assertion statements remain in router files. API endpoints return proper 400 HTTPException on invalid profile state instead of crashing with 500 AssertionError.</done>
</task>

</tasks>

<verification>
- `cd backend && ruff check . && ruff format --check . && mypy mlx_manager && pytest -v` all pass
- `grep -rn "except.*pass" mlx_manager/services/ mlx_manager/routers/` shows only expected patterns with logging
- `grep -n "^.*assert " mlx_manager/routers/` returns empty
</verification>

<success_criteria>
- Zero bare `except: pass` blocks without logging (except asyncio.CancelledError)
- Zero `assert` statements in router files
- All existing tests pass
- Type checking and linting pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes-stability/06-01-SUMMARY.md`
</output>
