---
phase: 06-bug-fixes-stability
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/components/servers/StartingTile.svelte
  - frontend/src/lib/components/servers/ServerTile.svelte
  - frontend/src/lib/components/servers/ServerCard.svelte
  - frontend/src/routes/(protected)/chat/+page.svelte
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Memory displays as GB when >= 1024 MB (e.g., '2.5 GB' not '2560 MB')"
    - "Chat input wraps text and grows vertically as user types"
    - "Enter sends message, Shift+Enter inserts newline"
    - "Health check polling only starts after PID is confirmed running"
  artifacts:
    - path: "frontend/src/lib/components/servers/ServerTile.svelte"
      provides: "Dynamic memory unit display"
      contains: "formatBytes"
    - path: "frontend/src/lib/components/servers/ServerCard.svelte"
      provides: "Dynamic memory unit display"
      contains: "formatBytes"
    - path: "frontend/src/routes/(protected)/chat/+page.svelte"
      provides: "Auto-growing textarea input"
      contains: "textarea"
    - path: "frontend/src/lib/components/servers/StartingTile.svelte"
      provides: "Deferred health check polling"
      contains: "INITIAL_DELAY_MS"
  key_links:
    - from: "ServerTile.svelte"
      to: "format.ts"
      via: "import formatBytes"
      pattern: "formatBytes\\(server\\.memory_mb"
    - from: "ServerCard.svelte"
      to: "format.ts"
      via: "import formatBytes"
      pattern: "formatBytes\\(server\\.memory_mb"
---

<objective>
Fix three minor UX issues from UAT: memory units always showing MB, chat input being single-line, and console errors from premature health check polling.

Purpose: Polish display and input UX before release
Output: Dynamic memory units, auto-growing textarea, reduced console noise
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@frontend/src/lib/utils/format.ts
@frontend/src/lib/components/servers/ServerTile.svelte
@frontend/src/lib/components/servers/ServerCard.svelte
@frontend/src/lib/components/servers/StartingTile.svelte
@frontend/src/routes/(protected)/chat/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix memory display and health check timing</name>
  <files>
    frontend/src/lib/components/servers/ServerTile.svelte
    frontend/src/lib/components/servers/ServerCard.svelte
    frontend/src/lib/components/servers/StartingTile.svelte
  </files>
  <action>
    1. In ServerTile.svelte (line 117): Replace `{server.memory_mb.toFixed(0)} MB` with `{formatBytes(server.memory_mb * 1024 * 1024)}`. Add import for `formatBytes` from `$lib/utils/format`.

    2. In ServerCard.svelte (line 126): Replace `{server.memory_mb.toFixed(1)} MB` with `{formatBytes(server.memory_mb * 1024 * 1024)}`. Add import for `formatBytes` from `$lib/utils/format`.

    3. In StartingTile.svelte: Add an initial delay before the first `/v1/models` health check poll. After confirming the server process is running (PID check passes at line 110), wait 5 seconds before making the first direct fetch to `/v1/models`. This reduces "Failed to load resource" console noise during initial model loading.

    Implementation for StartingTile:
    - Add constant `INITIAL_HEALTH_DELAY_MS = 5000`
    - Add state `healthCheckReady = $state(false)`
    - When PID is first confirmed running, set a timeout to enable health checks after INITIAL_HEALTH_DELAY_MS
    - Guard the `/v1/models` fetch (line 129-143) with `if (healthCheckReady) { ... }` - skip the fetch but continue polling if not ready yet
    - Also increase POLL_INTERVAL_MS from 2000 to 3000 to reduce poll frequency
  </action>
  <verify>
    Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify TypeScript compiles. Verify formatBytes import is used correctly in both components.
  </verify>
  <done>
    - ServerTile and ServerCard show "2.5 GB" for 2560 MB, "512 MB" for 512 MB
    - StartingTile waits 5s after PID confirmed before first /v1/models fetch
    - Poll interval is 3s instead of 2s
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace chat input with auto-growing textarea</name>
  <files>frontend/src/routes/(protected)/chat/+page.svelte</files>
  <action>
    Replace the `<Input>` component on lines 708-713 with a `<textarea>` that auto-resizes:

    1. Remove the `Input` import (from `$components/ui`) if not used elsewhere in this file.

    2. Replace the Input element with:
    ```svelte
    <textarea
      bind:value={input}
      placeholder="Type a message..."
      disabled={loading}
      class="flex-1 resize-none overflow-hidden rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
      rows="1"
      style="max-height: 150px; overflow-y: {input.split('\n').length > 4 ? 'auto' : 'hidden'}"
      oninput={(e) => { const el = e.currentTarget; el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 150) + 'px'; }}
      onkeydown={(e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const form = e.currentTarget.closest('form');
          if (form && input.trim()) form.requestSubmit();
        }
      }}
    ></textarea>
    ```

    3. The textarea starts at 1 row (~38px), grows with content up to 150px max, then scrolls. Enter submits the form, Shift+Enter inserts a newline.

    4. After form submit (in the handleSubmit function), reset the textarea height by finding it and setting `style.height = 'auto'` after clearing input. Or rely on the reactive binding - when `input` is set to '' the oninput won't fire, so add an $effect that resets height when input becomes empty:
    Add a ref: `let textareaRef = $state<HTMLTextAreaElement | null>(null);`
    Bind it: `bind:this={textareaRef}`
    Add effect: `$effect(() => { if (!input && textareaRef) textareaRef.style.height = 'auto'; });`
  </action>
  <verify>
    Run `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` passes. Verify the textarea renders correctly (check no duplicate Input component, proper Tailwind classes).
  </verify>
  <done>
    - Chat input is a textarea that starts at 1 line height
    - Typing long text causes it to grow up to 150px then scroll
    - Enter submits, Shift+Enter inserts newline
    - After sending, textarea resets to 1-line height
  </done>
</task>

</tasks>

<verification>
- `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` passes
- `cd /Users/atomasini/Development/mlx-manager/frontend && npm run lint` passes
- Memory display uses formatBytes (grep confirms)
- Chat textarea exists (grep confirms `<textarea` in chat page)
</verification>

<success_criteria>
- Memory values >= 1024 MB display as GB (e.g., "2.5 GB")
- Memory values < 1024 MB display as MB (e.g., "512 MB")
- Chat input wraps text and grows vertically
- Enter sends, Shift+Enter adds newline
- Health check polling starts 5s after PID confirmed, polls every 3s
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes-stability/06-08-SUMMARY.md`
</output>
