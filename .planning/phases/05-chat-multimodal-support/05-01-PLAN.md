---
phase: 05-chat-multimodal-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/routes/(protected)/chat/+page.svelte
  - frontend/src/lib/api/types.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can click attachment button to select images/videos"
    - "User can drag-drop files onto chat area to attach"
    - "Attached files show as thumbnail row above input"
    - "User can remove attachment by hovering and clicking X"
    - "Max 3 attachments enforced"
    - "Video duration limited to 2 minutes"
    - "File picker filters based on model multimodal support"
  artifacts:
    - path: "frontend/src/routes/(protected)/chat/+page.svelte"
      provides: "Chat page with attachment UI"
      contains: "handleDrop"
    - path: "frontend/src/lib/api/types.ts"
      provides: "ChatMessage and ContentPart types"
      contains: "ContentPart"
  key_links:
    - from: "chat/+page.svelte"
      to: "types.ts"
      via: "import type { ChatMessage, ContentPart }"
      pattern: "ContentPart"
---

<objective>
Add media attachment UI to chat page with image/video support.

Purpose: Enable users to attach images and videos to chat messages for testing multimodal models. This is the frontend foundation - encoding and sending happens in later plans.

Output: Chat page with attachment button, drag-drop, thumbnail previews, and file validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-chat-multimodal-support/05-CONTEXT.md
@.planning/phases/05-chat-multimodal-support/05-RESEARCH.md
@frontend/src/routes/(protected)/chat/+page.svelte
@frontend/src/lib/api/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multimodal message types</name>
  <files>frontend/src/lib/api/types.ts</files>
  <action>
Add TypeScript types for OpenAI-compatible multimodal messages at the end of the file:

```typescript
// Chat message types for multimodal support
export interface ContentPart {
  type: "text" | "image_url";
  text?: string;
  image_url?: {
    url: string; // "data:image/png;base64,..." or HTTP URL
  };
}

export interface ChatMessage {
  role: "user" | "assistant" | "system";
  content: string | ContentPart[];
}

export interface Attachment {
  file: File;
  preview: string; // Object URL for thumbnail
  type: "image" | "video";
}
```

These types follow the OpenAI message format that mlx-openai-server accepts.
  </action>
  <verify>Run `npm run check` in frontend/ - should pass with no type errors</verify>
  <done>ContentPart, ChatMessage, and Attachment types exported from types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add attachment UI to chat page</name>
  <files>frontend/src/routes/(protected)/chat/+page.svelte</files>
  <action>
Modify the chat page to add media attachment functionality. Key changes:

1. **State for attachments:**
```typescript
let attachments = $state<Attachment[]>([]);
let dragOver = $state(false);
```

2. **Import Attachment type and icons:**
```typescript
import type { Attachment } from '$lib/api/types';
import { Paperclip, X } from 'lucide-svelte';
```

3. **File input ref (hidden):**
```typescript
let fileInputRef: HTMLInputElement;
```

4. **Utility functions:**

```typescript
// Determine if current profile supports multimodal
const isMultimodal = $derived(
  selectedProfile?.model_type === 'multimodal' ||
  selectedProfile?.model_type === 'vlm'
);

// Accept string based on model capabilities
const acceptedFormats = $derived(
  isMultimodal ? 'image/*,video/*' : ''
);

// Validate video duration (max 2 minutes)
async function validateVideoDuration(file: File): Promise<boolean> {
  return new Promise((resolve) => {
    const video = document.createElement('video');
    video.preload = 'metadata';
    video.onloadedmetadata = () => {
      URL.revokeObjectURL(video.src);
      resolve(video.duration <= 120);
    };
    video.onerror = () => {
      URL.revokeObjectURL(video.src);
      resolve(false);
    };
    video.src = URL.createObjectURL(file);
  });
}

// Add attachment with validation
async function addAttachment(file: File): Promise<void> {
  if (attachments.length >= 3) {
    error = 'Maximum 3 attachments per message';
    return;
  }

  const isVideo = file.type.startsWith('video/');
  const isImage = file.type.startsWith('image/');

  if (!isVideo && !isImage) {
    error = 'Only images and videos are supported';
    return;
  }

  if (isVideo) {
    const valid = await validateVideoDuration(file);
    if (!valid) {
      error = 'Video must be 2 minutes or less';
      return;
    }
  }

  const preview = URL.createObjectURL(file);
  attachments.push({
    file,
    preview,
    type: isVideo ? 'video' : 'image'
  });
}

// Remove attachment and cleanup object URL
function removeAttachment(index: number): void {
  const attachment = attachments[index];
  URL.revokeObjectURL(attachment.preview);
  attachments.splice(index, 1);
}

// Handle file input change
async function handleFileSelect(e: Event): Promise<void> {
  const input = e.target as HTMLInputElement;
  const files = Array.from(input.files || []);
  for (const file of files) {
    await addAttachment(file);
  }
  input.value = ''; // Reset for same file re-selection
}

// Handle drag-drop
function handleDrop(e: DragEvent): void {
  e.preventDefault();
  dragOver = false;
  const files = Array.from(e.dataTransfer?.files || []);
  for (const file of files) {
    addAttachment(file);
  }
}

function handleDragOver(e: DragEvent): void {
  e.preventDefault();
  dragOver = true;
}

function handleDragLeave(e: DragEvent): void {
  e.preventDefault();
  dragOver = false;
}
```

5. **Update the Card wrapper for drag-drop on chat area (the message area + input):**
Add dragover, dragleave, drop handlers to the Card element that wraps messages and input.

6. **Add thumbnail row above the input (inside the form, before the input row):**
```svelte
{#if attachments.length > 0}
  <div class="px-4 pt-4 flex gap-2 flex-wrap">
    {#each attachments as attachment, i}
      <div class="relative group">
        {#if attachment.type === 'image'}
          <img
            src={attachment.preview}
            alt="Attachment"
            class="w-16 h-16 object-cover rounded-lg border"
          />
        {:else}
          <video
            src={attachment.preview}
            class="w-16 h-16 object-cover rounded-lg border"
          />
        {/if}
        <button
          type="button"
          onclick={() => removeAttachment(i)}
          class="absolute -top-2 -right-2 w-5 h-5 bg-destructive text-destructive-foreground rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
        >
          <X class="w-3 h-3" />
        </button>
      </div>
    {/each}
  </div>
{/if}
```

7. **Add attachment button inside the input row (before the Send button):**
```svelte
{#if isMultimodal}
  <Button
    type="button"
    variant="ghost"
    size="icon"
    onclick={() => fileInputRef.click()}
    disabled={loading || attachments.length >= 3}
  >
    <Paperclip class="w-4 h-4" />
  </Button>
{/if}
```

8. **Add hidden file input at the end of the form:**
```svelte
<input
  type="file"
  bind:this={fileInputRef}
  accept={acceptedFormats}
  multiple
  onchange={handleFileSelect}
  class="hidden"
/>
```

9. **Add visual drag-over indicator:**
Add conditional class to the Card: `{dragOver ? 'ring-2 ring-primary' : ''}`

10. **Clear attachments on message send:**
In handleSubmit, after sending, clear attachments:
```typescript
// Clear attachments after send
for (const attachment of attachments) {
  URL.revokeObjectURL(attachment.preview);
}
attachments = [];
```

Note: This plan only adds the UI. The actual message encoding and API call modification will be done in Plan 02. For now, the attachments are collected but not sent with the message.
  </action>
  <verify>
1. Run `npm run check` in frontend/ - should pass
2. Run `npm run lint` in frontend/ - should pass
3. Start dev server (`npm run dev`) and navigate to /chat
4. Verify attachment button appears only when a multimodal server is selected
5. Verify drag-drop area shows visual indicator
6. Verify thumbnails appear and can be removed
  </verify>
  <done>
- Attachment button visible in chat input (multimodal profiles only)
- Drag-drop enabled on chat message area
- Thumbnail row displays attached files
- X button removes attachments on hover
- Max 3 attachments enforced with error message
- Video duration validation (2 min max) works
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run check` passes
2. `cd frontend && npm run lint` passes
3. Visual verification:
   - Attachment button appears for multimodal profiles
   - Drag-drop shows visual feedback
   - Thumbnails display correctly
   - Remove button works
   - Error messages show for validation failures
</verification>

<success_criteria>
- Attachment UI complete and functional
- File validation working (type, count, video duration)
- No TypeScript or lint errors
- Attachments persist in state until message sent or removed
</success_criteria>

<output>
After completion, create `.planning/phases/05-chat-multimodal-support/05-01-SUMMARY.md`
</output>
