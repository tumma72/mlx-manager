---
phase: 05-chat-multimodal-support
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/api/types.ts
  - frontend/src/routes/(protected)/chat/+page.svelte
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Attachment button always visible regardless of model type"
    - "Text-only models accept only text-based file formats (no images/videos)"
    - "Multimodal models accept images, videos, AND text-based formats"
    - "Text files can be dragged and dropped into the chat"
    - "Text file attachments show filename preview instead of thumbnail"
  artifacts:
    - path: "frontend/src/lib/api/types.ts"
      provides: "Attachment type with 'text' option"
      exports: ["Attachment"]
    - path: "frontend/src/routes/(protected)/chat/+page.svelte"
      provides: "Updated attachment UI with text file support"
      min_lines: 570
  key_links:
    - from: "frontend/src/routes/(protected)/chat/+page.svelte"
      to: "Attachment type"
      via: "type property includes 'text'"
      pattern: "type: 'image' \\| 'video' \\| 'text'"
    - from: "acceptedFormats computed property"
      to: "model_type"
      via: "Returns text formats for text-only models"
      pattern: "isMultimodal.*text/"
    - from: "addAttachment function"
      to: "text MIME validation"
      via: "Accepts text/* and common text formats"
      pattern: "isText.*text/"
---

<objective>
Fix three UAT failures in chat attachment system: make attachment button always visible, add text file support for all model types, and update file validation to accept text formats based on model capabilities.

Purpose: Complete Phase 5 UAT requirements for universal attachment support across all model types.
Output: Chat page with universal attachment button, text file support, and model-appropriate format filtering.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-chat-multimodal-support/05-UAT.md
@frontend/src/lib/api/types.ts
@frontend/src/routes/(protected)/chat/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 'text' type to Attachment interface</name>
  <files>frontend/src/lib/api/types.ts</files>
  <action>
Update the Attachment interface (line 240-244) to include 'text' as a valid type:

```typescript
export interface Attachment {
  file: File;
  preview: string; // Object URL for thumbnail, or filename for text
  type: "image" | "video" | "text";
}
```

This enables the chat page to track text file attachments separately from media files.
  </action>
  <verify>
```bash
cd frontend
npm run check
```

No type errors. Attachment type now accepts 'text'.
  </verify>
  <done>Attachment interface includes 'text' type option, enabling text file tracking in attachments array.</done>
</task>

<task type="auto">
  <name>Task 2: Update chat page for universal text file support</name>
  <files>frontend/src/routes/(protected)/chat/+page.svelte</files>
  <action>
Make the following changes to support text files for all model types:

**1. Remove multimodal conditional around paperclip button (lines 530-540):**

Replace:
```svelte
{#if isMultimodal}
  <Button
    type="button"
    variant="ghost"
    size="icon"
    onclick={() => fileInputRef?.click()}
    disabled={loading || attachments.length >= 3}
  >
    <Paperclip class="w-4 h-4" />
  </Button>
{/if}
```

With:
```svelte
<Button
  type="button"
  variant="ghost"
  size="icon"
  onclick={() => fileInputRef?.click()}
  disabled={loading || attachments.length >= 3}
>
  <Paperclip class="w-4 h-4" />
</Button>
```

**2. Update acceptedFormats to include text formats (lines 42-45):**

Replace:
```typescript
const acceptedFormats = $derived(
  isMultimodal ? 'image/*,video/*' : ''
);
```

With:
```typescript
const acceptedFormats = $derived(
  isMultimodal
    ? 'image/*,video/*,.txt,.md,.csv,.json,.xml,.yaml,.yml,.log,.py,.js,.ts,.html,.css,.sh,.sql,.conf,.ini,.toml'
    : '.txt,.md,.csv,.json,.xml,.yaml,.yml,.log,.py,.js,.ts,.html,.css,.sh,.sql,.conf,.ini,.toml'
);
```

**3. Add text file validation in addAttachment (lines 92-104):**

Replace:
```typescript
const isVideo = file.type.startsWith('video/');
const isImage = file.type.startsWith('image/');

if (!isVideo && !isImage) {
  chatError = { summary: 'Only images and videos are supported' };
  return;
}
```

With:
```typescript
const isVideo = file.type.startsWith('video/');
const isImage = file.type.startsWith('image/');
const isText = file.type.startsWith('text/') ||
  file.type === 'application/json' ||
  file.type === 'application/xml' ||
  file.type === 'application/x-yaml' ||
  file.type === 'application/x-sh' ||
  file.type === 'application/sql';

// Validate based on model type
if (!isText && !isVideo && !isImage) {
  chatError = { summary: 'Unsupported file type' };
  return;
}

// Text-only models: reject media files
if (!isMultimodal && (isImage || isVideo)) {
  chatError = { summary: 'This model only supports text file attachments' };
  return;
}

// Multimodal models: accept everything
// Text models: accept only text files
```

**4. Update preview assignment to handle text files (lines 114-119):**

Replace:
```typescript
const preview = URL.createObjectURL(file);
attachments.push({
  file,
  preview,
  type: isVideo ? 'video' : 'image'
});
```

With:
```typescript
const preview = isText ? file.name : URL.createObjectURL(file);
attachments.push({
  file,
  preview,
  type: isText ? 'text' : isVideo ? 'video' : 'image'
});
```

**5. Update removeAttachment to skip revoking text file previews (lines 123-127):**

Replace:
```typescript
function removeAttachment(index: number): void {
  const attachment = attachments[index];
  URL.revokeObjectURL(attachment.preview);
  attachments.splice(index, 1);
}
```

With:
```typescript
function removeAttachment(index: number): void {
  const attachment = attachments[index];
  // Only revoke object URLs (not filenames for text files)
  if (attachment.type !== 'text') {
    URL.revokeObjectURL(attachment.preview);
  }
  attachments.splice(index, 1);
}
```

**6. Add text file preview in thumbnail section (lines 500-527):**

Replace the entire attachment preview block with:
```svelte
{#if attachments.length > 0}
  <div class="px-4 pt-4 flex gap-2 flex-wrap">
    {#each attachments as attachment, i (attachment.preview)}
      <div class="relative group">
        {#if attachment.type === 'image'}
          <img
            src={attachment.preview}
            alt="Attachment"
            class="w-16 h-16 object-cover rounded-lg border"
          />
        {:else if attachment.type === 'video'}
          <video
            src={attachment.preview}
            class="w-16 h-16 object-cover rounded-lg border"
            muted
          >
            <track kind="captions" />
          </video>
        {:else if attachment.type === 'text'}
          <div class="w-16 h-16 flex flex-col items-center justify-center rounded-lg border bg-muted text-muted-foreground text-xs p-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-1">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <span class="truncate w-full text-center">{attachment.preview.split('.').pop()}</span>
          </div>
        {/if}
        <button
          type="button"
          onclick={() => removeAttachment(i)}
          class="absolute -top-2 -right-2 w-5 h-5 bg-destructive text-destructive-foreground rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
        >
          <X class="w-3 h-3" />
        </button>
      </div>
    {/each}
  </div>
{/if}
```

**7. Update attachment cleanup when switching profiles (lines 329-333):**

Replace:
```typescript
// Clear attachments when switching profiles
for (const attachment of attachments) {
  URL.revokeObjectURL(attachment.preview);
}
attachments = [];
```

With:
```typescript
// Clear attachments when switching profiles
for (const attachment of attachments) {
  if (attachment.type !== 'text') {
    URL.revokeObjectURL(attachment.preview);
  }
}
attachments = [];
```

**8. Update attachment cleanup after send (lines 200-204):**

Replace:
```typescript
// Clear attachments
for (const attachment of attachments) {
  URL.revokeObjectURL(attachment.preview);
}
attachments = [];
```

With:
```typescript
// Clear attachments
for (const attachment of attachments) {
  if (attachment.type !== 'text') {
    URL.revokeObjectURL(attachment.preview);
  }
}
attachments = [];
```

**Why these changes:**
- Removes multimodal gate (Gap 1) - button now always visible
- Adds text format support to accept attribute (Gap 2) - file picker filters correctly
- Updates validation to accept text files for all models, reject media for text-only models
- Adds text file detection using MIME types
- Displays text files with document icon + extension instead of thumbnail (Gap 3)
- Only revokes object URLs for media files (text files use filename string)
  </action>
  <verify>
```bash
cd frontend
npm run check
npm run lint
```

No type errors, no linting errors. All three gaps addressed:
1. Attachment button visible for all model types
2. File picker accept attribute includes text formats
3. Text files accepted in drag-drop validation
  </verify>
  <done>
Chat page supports text file attachments for all model types:
- Attachment button always visible
- Text-only models: only text formats accepted
- Multimodal models: images, videos, and text formats accepted
- Text files show filename preview with document icon
- All validation and cleanup logic handles text files correctly
  </done>
</task>

</tasks>

<verification>
Run frontend quality checks:
```bash
cd frontend
npm run check && npm run lint
```

All checks pass. UAT failures resolved:
- Test 1: Attachment button always visible (isMultimodal conditional removed)
- Test 2: File picker accepts text formats for text models, all formats for multimodal
- Test 3: Text files accepted in drag-drop, show filename preview
</verification>

<success_criteria>
Phase 5 UAT gaps closed:
- [ ] Attachment button visible regardless of model type
- [ ] Text-only models: file picker shows only text formats
- [ ] Multimodal models: file picker shows images, videos, AND text formats
- [ ] Dragging text files into chat works
- [ ] Text file attachments display filename + document icon (not thumbnail)
- [ ] Max 3 attachments enforced for all file types
- [ ] Frontend quality checks pass (svelte-check, eslint)
</success_criteria>

<output>
After completion, create `.planning/phases/05-chat-multimodal-support/05-05-SUMMARY.md`
</output>
