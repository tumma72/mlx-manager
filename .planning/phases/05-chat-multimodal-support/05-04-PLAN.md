---
phase: 05-chat-multimodal-support
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - frontend/src/lib/components/ui/error-message.svelte
  - frontend/src/lib/components/ui/index.ts
  - frontend/src/routes/(protected)/chat/+page.svelte
autonomous: false

must_haves:
  truths:
    - "Connection errors show 'Failed to connect to MLX server' message when server unreachable"
    - "Server errors show with expandable details section"
    - "Validation errors (max attachments, file type) show in red text"
    - "Error has collapsible details section"
    - "User can copy error to clipboard"
    - "Error auto-collapses when next message sent"
  artifacts:
    - path: "frontend/src/lib/components/ui/error-message.svelte"
      provides: "Collapsible error display component"
      contains: "Copy"
    - path: "frontend/src/routes/(protected)/chat/+page.svelte"
      provides: "Chat page with error handling"
      contains: "ErrorMessage"
  key_links:
    - from: "chat/+page.svelte"
      to: "error-message.svelte"
      via: "component import"
      pattern: "ErrorMessage"
---

<objective>
Add polished error handling with collapsible details and copy functionality.

Purpose: Improve error UX by showing errors inline in chat with actionable details. Users can see, expand, and copy errors for debugging.

Output: ErrorMessage component and integrated error display in chat.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-chat-multimodal-support/05-CONTEXT.md
@.planning/phases/05-chat-multimodal-support/05-01-SUMMARY.md
@.planning/phases/05-chat-multimodal-support/05-02-SUMMARY.md
@.planning/phases/05-chat-multimodal-support/05-03-SUMMARY.md
@frontend/src/routes/(protected)/chat/+page.svelte
@frontend/src/lib/components/ui/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ErrorMessage component</name>
  <files>
    frontend/src/lib/components/ui/error-message.svelte
    frontend/src/lib/components/ui/index.ts
  </files>
  <action>
Create a reusable error message component with collapsible details and copy functionality.

**1. Create frontend/src/lib/components/ui/error-message.svelte:**

```svelte
<script lang="ts">
  import { Collapsible } from 'bits-ui';
  import { ChevronDown, ChevronRight, AlertCircle, Copy, Check } from 'lucide-svelte';

  interface Props {
    summary: string;
    details?: string;
    defaultExpanded?: boolean;
  }

  let { summary, details, defaultExpanded = true }: Props = $props();

  let expanded = $state(defaultExpanded);
  let copied = $state(false);

  async function copyToClipboard() {
    const text = details ? `${summary}\n\n${details}` : summary;
    try {
      await navigator.clipboard.writeText(text);
      copied = true;
      setTimeout(() => { copied = false; }, 2000);
    } catch {
      // Fallback for older browsers
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      copied = true;
      setTimeout(() => { copied = false; }, 2000);
    }
  }

  // Collapse this error (called from parent when new message sent)
  export function collapse() {
    expanded = false;
  }
</script>

<div class="rounded-lg border border-destructive/50 bg-destructive/10 p-3">
  <div class="flex items-start gap-2">
    <AlertCircle class="w-4 h-4 text-destructive mt-0.5 flex-shrink-0" />

    <div class="flex-1 min-w-0">
      {#if details}
        <Collapsible.Root bind:open={expanded}>
          <div class="flex items-center justify-between gap-2">
            <Collapsible.Trigger class="flex items-center gap-1 text-sm font-medium text-destructive hover:underline">
              {#if expanded}
                <ChevronDown class="w-4 h-4" />
              {:else}
                <ChevronRight class="w-4 h-4" />
              {/if}
              {summary}
            </Collapsible.Trigger>

            <button
              type="button"
              onclick={copyToClipboard}
              class="p-1 rounded hover:bg-destructive/20 transition-colors"
              title="Copy error"
            >
              {#if copied}
                <Check class="w-4 h-4 text-green-600" />
              {:else}
                <Copy class="w-4 h-4 text-destructive" />
              {/if}
            </button>
          </div>

          <Collapsible.Content>
            <pre class="mt-2 p-2 text-xs text-destructive bg-destructive/5 rounded overflow-x-auto whitespace-pre-wrap break-words">{details}</pre>
          </Collapsible.Content>
        </Collapsible.Root>
      {:else}
        <div class="flex items-center justify-between gap-2">
          <span class="text-sm font-medium text-destructive">{summary}</span>

          <button
            type="button"
            onclick={copyToClipboard}
            class="p-1 rounded hover:bg-destructive/20 transition-colors"
            title="Copy error"
          >
            {#if copied}
              <Check class="w-4 h-4 text-green-600" />
            {:else}
              <Copy class="w-4 h-4 text-destructive" />
            {/if}
          </button>
        </div>
      {/if}
    </div>
  </div>
</div>
```

**2. Update frontend/src/lib/components/ui/index.ts:**
Add export for the new component:

```typescript
export { default as ErrorMessage } from "./error-message.svelte";
```
  </action>
  <verify>Run `npm run check` in frontend/ - should pass</verify>
  <done>
- ErrorMessage component with collapsible details
- Copy to clipboard functionality
- Red styling with border
- Accessible using bits-ui Collapsible
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate error display in chat</name>
  <files>frontend/src/routes/(protected)/chat/+page.svelte</files>
  <action>
Replace the simple error banner with the ErrorMessage component, displayed inline in the chat messages area.

**Key changes:**

1. **Import ErrorMessage and AlertCircle:**
```typescript
import { Card, Button, Input, Select, Markdown, ThinkingBubble, ErrorMessage } from '$components/ui';
import { Send, Loader2, Bot, User, AlertCircle } from 'lucide-svelte';
```

2. **Change error state to store both summary and details:**
```typescript
// Replace: let error = $state<string | null>(null);
// With:
let chatError = $state<{ summary: string; details?: string } | null>(null);
let errorMessageRef: { collapse: () => void } | undefined;
```

3. **Update error handling in handleSubmit:**

In the SSE error handling (case 'error'):
```typescript
case 'error':
  // Parse connection errors vs server errors
  if (data.content.includes('Failed to connect')) {
    chatError = {
      summary: 'Connection failed',
      details: data.content
    };
  } else if (data.content.includes('timed out')) {
    chatError = {
      summary: 'Request timed out',
      details: data.content
    };
  } else {
    chatError = {
      summary: 'Server error',
      details: data.content
    };
  }
  break;
```

In the catch block:
```typescript
} catch (e) {
  const errorMsg = e instanceof Error ? e.message : 'Failed to send message';
  // Parse HTTP errors
  if (errorMsg.includes('HTTP')) {
    const [summary, ...rest] = errorMsg.split(':');
    chatError = { summary: summary.trim(), details: rest.join(':').trim() || undefined };
  } else {
    chatError = { summary: errorMsg };
  }
  // Remove the user message on error
  messages.pop();
}
```

4. **Auto-collapse error on new message:**
At the start of handleSubmit:
```typescript
// Collapse previous error
errorMessageRef?.collapse();
chatError = null;
```

5. **Update addAttachment validation errors:**
Replace `error = 'Maximum 3 attachments...'` with:
```typescript
chatError = { summary: 'Maximum 3 attachments per message' };
```

Do the same for other validation errors in addAttachment.

6. **Remove the old error banner:**
Delete the simple red div error display:
```svelte
<!-- DELETE THIS -->
{#if error}
  <div class="px-4 py-2 bg-red-100 dark:bg-red-950/50 text-red-700 dark:text-red-400 text-sm">
    {error}
  </div>
{/if}
```

7. **Add error display in messages area:**
Add after the loading indicator (inside the messages scroll area):

```svelte
{#if chatError}
  <div class="flex gap-3">
    <div class="w-8 h-8 rounded-full bg-destructive/10 flex items-center justify-center flex-shrink-0">
      <AlertCircle class="w-5 h-5 text-destructive" />
    </div>
    <div class="max-w-[80%]">
      <ErrorMessage
        bind:this={errorMessageRef}
        summary={chatError.summary}
        details={chatError.details}
      />
    </div>
  </div>
{/if}
```

8. **Clear error on profile change:**
In handleProfileChange:
```typescript
chatError = null;
```
  </action>
  <verify>
1. `cd frontend && npm run check` - should pass
2. `cd frontend && npm run lint` - should pass
3. Manual test: trigger an error (e.g., stop server mid-request), verify error displays with details
  </verify>
  <done>
- Errors display inline in chat messages area
- Error has collapsible details when available
- Copy button works
- Error auto-collapses on new message
- Error clears on profile change
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete multimodal chat support:
1. Media attachment UI (images/videos)
2. Streaming chat with SSE
3. Thinking model display with "Thought for Xs"
4. Collapsible error messages with copy
  </what-built>
  <how-to-verify>
1. Start dev servers: `./scripts/dev.sh` (or `make dev`)
2. Navigate to http://localhost:5173/chat
3. Start a text model server from /servers page

**Test 1: Basic streaming**
- Select the running server in chat
- Send a message
- Verify: Response streams in character-by-character (not all at once)

**Test 2: Thinking model** (if you have a thinking model like Qwen3)
- Create profile with reasoning_parser set
- Start the server
- Select it in chat and send a prompt
- Verify: "Thinking..." shows while generating
- Verify: Changes to "Thought for Xs" when done
- Verify: Click to expand/collapse thinking content

**Test 3: Attachments** (if you have a multimodal model like Qwen2-VL)
- Start a multimodal profile (model_type: multimodal or vlm)
- Verify: Attachment button (paperclip) appears in input
- Attach an image via button or drag-drop
- Verify: Thumbnail shows above input
- Verify: X button removes on hover
- Try to attach 4 images - verify error shows
- Send message with image - verify it works

**Test 4: Error handling**
- Stop a running server
- Try to send a message to it
- Verify: Error shows inline with red styling
- Verify: Click to expand details (shows "Failed to connect...")
- Verify: Copy button copies error text
- Send another message - verify previous error collapses
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `cd frontend && npm run check && npm run lint` passes
2. `cd backend && ruff check . && ruff format --check . && mypy mlx_manager && pytest -v` passes
3. All checkpoint verification tests pass
</verification>

<success_criteria>
- ErrorMessage component complete with copy and collapse
- Error displays inline in chat
- All Phase 5 requirements verified working
- No quality gate failures
</success_criteria>

<output>
After completion, create `.planning/phases/05-chat-multimodal-support/05-04-SUMMARY.md`
</output>
