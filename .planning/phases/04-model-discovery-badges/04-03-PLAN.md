---
phase: 04-model-discovery-badges
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/lib/components/models/ModelToggle.svelte
  - frontend/src/lib/components/models/FilterModal.svelte
  - frontend/src/lib/components/models/FilterChips.svelte
  - frontend/src/lib/components/models/index.ts
  - frontend/src/routes/(protected)/models/+page.svelte
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User sees toggle switch for 'My Models' / 'HuggingFace' (default: My Models)"
    - "User can open filter modal via filter icon button"
    - "Filter modal shows architecture, multimodal, quantization filter options"
    - "Active filters display as removable chips below search"
    - "Filtering works for both local and HuggingFace model lists"
  artifacts:
    - path: "frontend/src/lib/components/models/ModelToggle.svelte"
      provides: "Toggle switch for local/online mode"
      contains: "My Models"
    - path: "frontend/src/lib/components/models/FilterModal.svelte"
      provides: "Modal with filter checkboxes"
      contains: "Filter Models"
    - path: "frontend/src/lib/components/models/FilterChips.svelte"
      provides: "Removable filter chips"
      contains: "onRemove"
  key_links:
    - from: "models/+page.svelte"
      to: "FilterModal.svelte"
      via: "modal open state"
      pattern: "showFilterModal"
    - from: "FilterChips.svelte"
      to: "models/+page.svelte"
      via: "filter state updates"
      pattern: "activeFilters"
---

<objective>
Refactor models page search UX with toggle switch and filter modal for model characteristics.

Purpose: Replace checkbox-based filtering with a cleaner toggle (My Models / HuggingFace) and grouped filter modal, per CONTEXT.md decisions.

Output: ModelToggle, FilterModal, FilterChips components, updated models page with new filter UX.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-model-discovery-badges/04-CONTEXT.md
@.planning/phases/04-model-discovery-badges/04-RESEARCH.md
@.planning/phases/04-model-discovery-badges/04-01-SUMMARY.md

@frontend/src/routes/(protected)/models/+page.svelte
@frontend/src/lib/components/models/ModelCard.svelte
@frontend/src/lib/api/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModelToggle component</name>
  <files>
    frontend/src/lib/components/models/ModelToggle.svelte
    frontend/src/lib/components/models/index.ts
  </files>
  <action>
    1. Create ModelToggle.svelte:
       - Props:
         - mode: 'local' | 'online' (bindable)
         - onModeChange?: (mode: 'local' | 'online') => void
       - Style as a pill-shaped toggle button that displays both options
       - Active option highlighted, inactive option dimmed
       - Design: Two adjacent buttons in a rounded container
         - Left: "My Models" (local)
         - Right: "HuggingFace" (online)
       - Use Tailwind classes for styling:
         - Container: flex, rounded-full, bg-muted, p-1
         - Active button: bg-background, shadow-sm, text-foreground
         - Inactive button: text-muted-foreground, hover:text-foreground

       Example structure:
       ```svelte
       <script lang="ts">
         interface Props {
           mode: 'local' | 'online';
           onModeChange?: (mode: 'local' | 'online') => void;
         }

         let { mode = $bindable(), onModeChange }: Props = $props();

         function setMode(newMode: 'local' | 'online') {
           mode = newMode;
           onModeChange?.(newMode);
         }
       </script>

       <div class="flex rounded-full bg-muted p-1">
         <button
           type="button"
           class="px-4 py-1.5 text-sm font-medium rounded-full transition-all
             {mode === 'local' ? 'bg-background shadow-sm text-foreground' : 'text-muted-foreground hover:text-foreground'}"
           onclick={() => setMode('local')}
         >
           My Models
         </button>
         <button
           type="button"
           class="px-4 py-1.5 text-sm font-medium rounded-full transition-all
             {mode === 'online' ? 'bg-background shadow-sm text-foreground' : 'text-muted-foreground hover:text-foreground'}"
           onclick={() => setMode('online')}
         >
           HuggingFace
         </button>
       </div>
       ```

    2. Export from index.ts
  </action>
  <verify>
    cd frontend && npm run check && npm run lint
  </verify>
  <done>
    - ModelToggle displays two options
    - Active state clearly highlighted
    - Mode binding works correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FilterModal and FilterChips components</name>
  <files>
    frontend/src/lib/components/models/FilterModal.svelte
    frontend/src/lib/components/models/FilterChips.svelte
    frontend/src/lib/components/models/index.ts
  </files>
  <action>
    1. Define FilterState type (can be in FilterModal or separate types file):
       ```typescript
       export interface FilterState {
         architectures: string[];      // Selected architecture families
         multimodal: boolean | null;   // null = any, true = multimodal only, false = text only
         quantization: number[];       // Selected quantization bits (e.g., [4, 8])
       }

       export const ARCHITECTURE_OPTIONS = [
         'Llama', 'Qwen', 'Mistral', 'Gemma', 'Phi',
         'DeepSeek', 'StarCoder', 'GLM', 'MiniMax'
       ];

       export const QUANTIZATION_OPTIONS = [2, 3, 4, 8, 16]; // 16 = fp16
       ```

    2. Create FilterModal.svelte:
       - Props:
         - open: boolean (bindable)
         - filters: FilterState (bindable)
         - onApply?: (filters: FilterState) => void
       - Use bits-ui Dialog (import * as Dialog from 'bits-ui/dialog')
       - Sections:
         a. Architecture (checkboxes for each family)
         b. Capabilities (radio: Any / Text-only / Multimodal)
         c. Quantization (checkboxes: 2-bit, 3-bit, 4-bit, 8-bit, fp16)
       - Footer: "Clear All" and "Apply" buttons
       - Maintain local copy of filters, update on Apply

       Structure:
       ```svelte
       <Dialog.Root bind:open>
         <Dialog.Portal>
           <Dialog.Overlay class="fixed inset-0 bg-black/50" />
           <Dialog.Content class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-background p-6 rounded-lg shadow-lg w-[400px] max-h-[80vh] overflow-y-auto">
             <Dialog.Title class="text-lg font-semibold mb-4">Filter Models</Dialog.Title>

             <!-- Architecture section -->
             <section class="mb-6">
               <h4 class="text-sm font-medium mb-2">Architecture</h4>
               <div class="grid grid-cols-3 gap-2">
                 {#each ARCHITECTURE_OPTIONS as arch}
                   <label class="flex items-center gap-2 text-sm">
                     <input type="checkbox" ... />
                     {arch}
                   </label>
                 {/each}
               </div>
             </section>

             <!-- Capabilities section -->
             <section class="mb-6">
               <h4 class="text-sm font-medium mb-2">Capabilities</h4>
               <div class="space-y-2">
                 <label class="flex items-center gap-2 text-sm">
                   <input type="radio" name="multimodal" value={null} ... />
                   Any
                 </label>
                 <label class="flex items-center gap-2 text-sm">
                   <input type="radio" name="multimodal" value={false} ... />
                   Text-only
                 </label>
                 <label class="flex items-center gap-2 text-sm">
                   <input type="radio" name="multimodal" value={true} ... />
                   Multimodal (Vision)
                 </label>
               </div>
             </section>

             <!-- Quantization section -->
             <section class="mb-6">
               <h4 class="text-sm font-medium mb-2">Quantization</h4>
               <div class="flex flex-wrap gap-2">
                 {#each QUANTIZATION_OPTIONS as bits}
                   <label class="flex items-center gap-2 text-sm">
                     <input type="checkbox" ... />
                     {bits === 16 ? 'fp16' : `${bits}-bit`}
                   </label>
                 {/each}
               </div>
             </section>

             <div class="flex justify-between mt-6">
               <Button variant="ghost" onclick={clearAll}>Clear All</Button>
               <Button onclick={applyFilters}>Apply</Button>
             </div>
           </Dialog.Content>
         </Dialog.Portal>
       </Dialog.Root>
       ```

    3. Create FilterChips.svelte:
       - Props:
         - filters: FilterState
         - onRemove: (type: 'architecture' | 'multimodal' | 'quantization', value?: string | number) => void
       - Display active filters as badge chips with X button
       - For architectures: one chip per selected arch
       - For multimodal: "Text-only" or "Multimodal" chip if not null
       - For quantization: one chip per selected bit level
       - Each chip has onclick to remove that filter

       Example chip:
       ```svelte
       {#each filters.architectures as arch}
         <Badge variant="secondary" class="cursor-pointer gap-1">
           {arch}
           <button onclick={() => onRemove('architecture', arch)}>
             <X class="w-3 h-3" />
           </button>
         </Badge>
       {/each}
       ```

    4. Export from index.ts
  </action>
  <verify>
    cd frontend && npm run check && npm run lint
  </verify>
  <done>
    - FilterModal displays grouped filter options
    - Filter state properly managed with local copy until Apply
    - FilterChips renders removable badges for active filters
    - Clear All resets all filters
  </done>
</task>

<task type="auto">
  <name>Task 3: Update models page with new filter UX</name>
  <files>
    frontend/src/routes/(protected)/models/+page.svelte
  </files>
  <action>
    1. Import new components:
       ```typescript
       import { ModelToggle, FilterModal, FilterChips, type FilterState } from '$components/models';
       import { Filter } from 'lucide-svelte';
       ```

    2. Replace state:
       - Remove: showLocalOnly
       - Add: searchMode = $state<'local' | 'online'>('local')
       - Add: filters = $state<FilterState>({ architectures: [], multimodal: null, quantization: [] })
       - Add: showFilterModal = $state(false)

    3. Update search bar section:
       - Replace checkbox area with:
         ```svelte
         <div class="flex items-center gap-4 mt-4">
           <ModelToggle bind:mode={searchMode} />

           {#if searchMode === 'online'}
             <label class="flex items-center gap-2 text-sm">
               <input type="checkbox" bind:checked={filterByMemory} class="rounded" />
               <span>Fits in memory</span>
             </label>
           {/if}

           <Button variant="outline" size="sm" onclick={() => showFilterModal = true}>
             <Filter class="w-4 h-4 mr-1" />
             Filters
             {#if hasActiveFilters}
               <Badge variant="secondary" class="ml-1">{activeFilterCount}</Badge>
             {/if}
           </Button>
         </div>
         ```

    4. Add filter chips below search card:
       ```svelte
       {#if hasActiveFilters}
         <div class="mt-2">
           <FilterChips {filters} onRemove={handleRemoveFilter} />
         </div>
       {/if}
       ```

    5. Add derived values for filter state:
       ```typescript
       const hasActiveFilters = $derived(
         filters.architectures.length > 0 ||
         filters.multimodal !== null ||
         filters.quantization.length > 0
       );

       const activeFilterCount = $derived(
         filters.architectures.length +
         (filters.multimodal !== null ? 1 : 0) +
         filters.quantization.length
       );
       ```

    6. Add handleRemoveFilter function:
       ```typescript
       function handleRemoveFilter(type: 'architecture' | 'multimodal' | 'quantization', value?: string | number) {
         if (type === 'architecture' && typeof value === 'string') {
           filters.architectures = filters.architectures.filter(a => a !== value);
         } else if (type === 'multimodal') {
           filters.multimodal = null;
         } else if (type === 'quantization' && typeof value === 'number') {
           filters.quantization = filters.quantization.filter(q => q !== value);
         }
       }
       ```

    7. Update filtering logic:
       - Update displayResults to apply characteristic filters
       - For local models, filter using characteristics from LocalModel
       - For online models, filter using characteristics from modelConfigStore

       Filter matching function:
       ```typescript
       function matchesFilters(characteristics: ModelCharacteristics | null | undefined): boolean {
         if (!characteristics) return true; // Show models without loaded characteristics

         // Architecture filter
         if (filters.architectures.length > 0) {
           if (!characteristics.architecture_family ||
               !filters.architectures.includes(characteristics.architecture_family)) {
             return false;
           }
         }

         // Multimodal filter
         if (filters.multimodal !== null) {
           if (filters.multimodal && !characteristics.is_multimodal) return false;
           if (!filters.multimodal && characteristics.is_multimodal) return false;
         }

         // Quantization filter
         if (filters.quantization.length > 0) {
           if (!characteristics.quantization_bits ||
               !filters.quantization.includes(characteristics.quantization_bits)) {
             return false;
           }
         }

         return true;
       }
       ```

    8. Update conditional rendering:
       - Replace `isLocalSearchMode` with `searchMode === 'local'`
       - Remove references to showLocalOnly

    9. Add FilterModal at bottom of component:
       ```svelte
       <FilterModal bind:open={showFilterModal} bind:filters />
       ```
  </action>
  <verify>
    cd frontend && npm run check && npm run lint
    # Manual testing:
    # - Toggle between My Models and HuggingFace
    # - Open filter modal and select filters
    # - Verify filter chips appear
    # - Verify X on chips removes filter
    # - Verify filtered results update
  </verify>
  <done>
    - Toggle switch replaces "Downloaded only" checkbox
    - Filter button opens modal
    - Active filters show as chips
    - Filtering works on both local and online modes
    - Filter removal works via chip X buttons
  </done>
</task>

</tasks>

<verification>
1. Run frontend type check: `cd frontend && npm run check`
2. Run frontend linting: `cd frontend && npm run lint`
3. Manual testing:
   - Default view shows "My Models" (local)
   - Toggle to "HuggingFace" enables online search
   - Filter button shows count of active filters
   - Filter modal allows selecting architecture, multimodal, quantization
   - Chips appear for active filters
   - Clicking X on chip removes that filter
   - Results update when filters change
</verification>

<success_criteria>
- Toggle switch clearly shows active mode
- Filter modal properly grouped by category
- Filter chips are removable
- AND logic applied (all filters must match)
- Works for both local models and search results
- Frontend passes type check and lint
</success_criteria>

<output>
After completion, create `.planning/phases/04-model-discovery-badges/04-03-SUMMARY.md`
</output>
