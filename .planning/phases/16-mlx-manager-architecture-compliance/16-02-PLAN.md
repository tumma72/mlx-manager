---
phase: 16-mlx-manager-architecture-compliance
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - frontend/src/lib/stores/downloads.svelte.ts
  - frontend/src/lib/stores/downloads.svelte.test.ts
  - frontend/src/lib/api/client.ts
  - frontend/src/lib/api/client.test.ts
  - frontend/src/lib/api/types.ts
  - frontend/e2e/app.spec.ts
autonomous: true

must_haves:
  truths:
    - "Frontend EventSource URL includes ?token=<jwt> for SSE download progress"
    - "Frontend WebSocket URL includes ?token=<jwt> for audit log streaming"
    - "Frontend no longer calls getAvailableParsers() or parserOptions()"
    - "ParserOptions type removed from frontend"
    - "All frontend tests pass with updated URL expectations"
  artifacts:
    - path: "frontend/src/lib/stores/downloads.svelte.ts"
      provides: "Token injection in EventSource URL"
      contains: "token="
    - path: "frontend/src/lib/api/client.ts"
      provides: "Token injection in WebSocket URL, removed deprecated functions"
      contains: "token="
    - path: "frontend/src/lib/api/types.ts"
      provides: "Clean types without ParserOptions"
  key_links:
    - from: "frontend/src/lib/stores/downloads.svelte.ts"
      to: "frontend/src/lib/stores/auth.svelte.ts"
      via: "authStore.token used in EventSource URL"
      pattern: "authStore\\.token"
    - from: "frontend/src/lib/api/client.ts"
      to: "frontend/src/lib/stores/auth.svelte.ts"
      via: "authStore.token used in WebSocket URL"
      pattern: "authStore\\.token"
---

<objective>
Update frontend to pass JWT tokens in SSE/WebSocket URLs and remove deprecated parser API functions.

Purpose: Complete ARCH-01 frontend side (token injection for EventSource and WebSocket) and ARCH-03 frontend side (remove deprecated parser-options API functions and types) to achieve full architecture compliance.

Output: Updated frontend stores, API client, types, and tests -- all passing.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-mlx-manager-architecture-compliance/16-01-SUMMARY.md
@backend/mlx_manager/ARCHITECTURE.md
@frontend/src/lib/stores/downloads.svelte.ts
@frontend/src/lib/stores/downloads.svelte.test.ts
@frontend/src/lib/stores/auth.svelte.ts
@frontend/src/lib/api/client.ts
@frontend/src/lib/api/client.test.ts
@frontend/src/lib/api/types.ts
@frontend/e2e/app.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add token to SSE and WebSocket URLs in frontend</name>
  <files>
    frontend/src/lib/stores/downloads.svelte.ts
    frontend/src/lib/api/client.ts
  </files>
  <action>
1. In `downloads.svelte.ts`:
   a. Import `authStore` from `$lib/stores` at the top of the file (after the existing imports)
   b. In the `connectSSE()` method (line 142-176), modify the EventSource URL to include the auth token:
      ```typescript
      private connectSSE(modelId: string, taskId: string): void {
        this.closeSSE(modelId);

        const token = authStore.token;
        const url = `/api/models/download/${taskId}/progress${token ? `?token=${token}` : ''}`;
        const eventSource = new EventSource(url);
        // ... rest unchanged
      }
      ```
      Note: Use conditional inclusion (`token ? ...`) so it doesn't break if token is null (defensive).

2. In `client.ts`:
   a. In the `auditLogs.createWebSocket()` function (line 697-701), add the auth token as a query parameter:
      ```typescript
      createWebSocket: (): WebSocket => {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        const token = authStore.token;
        const tokenParam = token ? `?token=${token}` : '';
        return new WebSocket(`${protocol}//${host}/api/system/ws/audit-logs${tokenParam}`);
      },
      ```
   b. DELETE the `getAvailableParsers` function from the `models` object (lines 346-351). This calls the removed `/api/models/available-parsers` endpoint.
   c. DELETE the `parserOptions` function from the `system` object (lines 438-443). This calls the removed `/api/system/parser-options` endpoint.
   d. Remove the `ParserOptions` import from the types import statement at the top of the file (line 18).
  </action>
  <verify>
    Run: `cd /Users/atomasini/Development/mlx-manager/frontend && npx svelte-check --threshold error` to verify type checking passes.
    Run: `grep -n 'authStore.token' frontend/src/lib/stores/downloads.svelte.ts frontend/src/lib/api/client.ts` to verify token injection present.
    Run: `grep -n 'getAvailableParsers\|parserOptions' frontend/src/lib/api/client.ts` should return zero results.
  </verify>
  <done>
    - EventSource URL includes `?token=<jwt>`
    - WebSocket URL includes `?token=<jwt>`
    - `getAvailableParsers()` removed from models API
    - `parserOptions()` removed from system API
    - `ParserOptions` no longer imported in client.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Update frontend tests and types, remove deprecated test code</name>
  <files>
    frontend/src/lib/stores/downloads.svelte.test.ts
    frontend/src/lib/api/client.test.ts
    frontend/src/lib/api/types.ts
    frontend/e2e/app.spec.ts
  </files>
  <action>
1. In `types.ts`:
   a. DELETE the `ParserOptions` interface (lines 169-173):
      ```typescript
      // DELETE THIS:
      export interface ParserOptions {
        tool_call_parsers: string[];
        reasoning_parsers: string[];
        message_converters: string[];
      }
      ```
   b. Verify no other code imports `ParserOptions` (grep the frontend codebase). If found, remove those imports too.

2. In `downloads.svelte.test.ts`:
   a. The store test mocks will need to account for the authStore import. Add a mock for `$lib/stores` that provides `authStore.token`:
      ```typescript
      vi.mock("$lib/stores", () => ({
        authStore: { token: "test-jwt-token" },
      }));
      ```
      Place this mock setup BEFORE the store import (near the top of the file, after the `$api` mock).
   b. Update ALL EventSource URL expectations to include `?token=test-jwt-token`:
      - Line 139-141: `"/api/models/download/task-456/progress"` -> `"/api/models/download/task-456/progress?token=test-jwt-token"`
      - Line 432-434 (reconnect): `"/api/models/download/existing-task/progress"` -> `"/api/models/download/existing-task/progress?token=test-jwt-token"`
      - Line 636-638 (resume): `"/api/models/download/new-task-789/progress"` -> `"/api/models/download/new-task-789/progress?token=test-jwt-token"`
      - Line 771-772 (loadActive): `"/api/models/download/task-active/progress"` -> `"/api/models/download/task-active/progress?token=test-jwt-token"`
   c. Search for any other URL assertions in the test file that need updating.

3. In `client.test.ts`:
   a. Update the `createWebSocket` tests to expect the token query parameter in the URL:
      - The test at ~line 1195 expects `"ws://localhost:5173/api/system/ws/audit-logs"` -- update to `"ws://localhost:5173/api/system/ws/audit-logs?token=test-jwt-token"` (or whatever token the mock provides)
      - The HTTPS test expects `"wss://example.com/api/system/ws/audit-logs"` -- update similarly
      - Ensure `authStore` is mocked to provide a token value. Check how the existing tests mock authStore (likely already mocked since `getAuthHeaders()` uses it). Find the existing authStore mock and ensure it has `token: "test-jwt-token"` or similar.
   b. DELETE the test for `getAvailableParsers` if one exists (search for `getAvailableParsers` or `available-parsers`).
   c. DELETE the test for `parserOptions` if one exists (search for `parserOptions` or `parser-options`).

4. In `e2e/app.spec.ts`:
   a. Remove the parser-options mock at line 184 (the `if (url.includes("/api/system/parser-options"))` block and its response). Remove the entire if-block including the `route.fulfill(...)` call.
  </action>
  <verify>
    Run: `cd /Users/atomasini/Development/mlx-manager/frontend && npm run test` to verify all unit tests pass.
    Run: `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` to verify type checking passes.
    Run: `cd /Users/atomasini/Development/mlx-manager/frontend && npm run lint` to verify linting passes.
    Run: `grep -rn 'ParserOptions' frontend/src/` should return zero results (type removed everywhere).
    Run: `grep -rn 'parser-options\|available-parsers' frontend/src/` should return zero results.
  </verify>
  <done>
    - ParserOptions interface removed from types.ts
    - Download store tests updated with token in EventSource URLs
    - WebSocket tests updated with token in WS URLs
    - Deprecated API function tests removed
    - E2E mock for parser-options removed
    - All frontend tests pass (unit, type check, lint)
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/atomasini/Development/mlx-manager/frontend && npm run test` -- all unit tests pass
2. `cd /Users/atomasini/Development/mlx-manager/frontend && npm run check` -- type checking clean
3. `cd /Users/atomasini/Development/mlx-manager/frontend && npm run lint` -- linting clean
4. `grep -rn 'ParserOptions' frontend/src/` -- zero results
5. `grep -rn 'getAvailableParsers\|parserOptions' frontend/src/lib/api/client.ts` -- zero results
6. `grep -rn 'parser-options\|available-parsers' frontend/src/lib/api/client.ts frontend/src/lib/api/types.ts` -- zero results
7. `grep -n 'token=' frontend/src/lib/stores/downloads.svelte.ts` -- token present in EventSource URL
8. `grep -n 'token=' frontend/src/lib/api/client.ts` -- token present in WebSocket URL
</verification>

<success_criteria>
- EventSource URL for download progress includes ?token=<jwt> from authStore
- WebSocket URL for audit logs includes ?token=<jwt> from authStore
- getAvailableParsers() and parserOptions() removed from client.ts
- ParserOptions interface removed from types.ts
- All frontend tests (unit + type check + lint) pass
- E2E parser-options mock removed
</success_criteria>

<output>
After completion, create `.planning/phases/16-mlx-manager-architecture-compliance/16-02-SUMMARY.md`
</output>
