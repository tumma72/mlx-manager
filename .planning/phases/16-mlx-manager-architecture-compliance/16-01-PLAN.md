---
phase: 16-mlx-manager-architecture-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/mlx_manager/dependencies.py
  - backend/mlx_manager/main.py
  - backend/mlx_manager/routers/models.py
  - backend/mlx_manager/routers/system.py
  - backend/mlx_manager/routers/servers.py
  - backend/mlx_manager/mlx_server/models/pool.py
  - backend/tests/test_models.py
  - backend/tests/test_system.py
autonomous: true

must_haves:
  truths:
    - "SSE download progress endpoint validates JWT from query parameter ?token=<jwt>"
    - "WebSocket audit-logs endpoint validates JWT before accepting connection; closes with code 1008 on invalid/missing token"
    - "JWT secret placeholder triggers a startup warning log when unchanged from default"
    - "Deprecated /api/models/available-parsers endpoint is removed (404)"
    - "Deprecated /api/system/parser-options endpoint is removed (404)"
    - "routers/servers.py no longer accesses pool._models directly"
  artifacts:
    - path: "backend/mlx_manager/dependencies.py"
      provides: "get_current_user_from_token() dependency for SSE/WS query-param auth"
      contains: "get_current_user_from_token"
    - path: "backend/mlx_manager/mlx_server/models/pool.py"
      provides: "get_loaded_model() public method on ModelPoolManager"
      contains: "def get_loaded_model"
    - path: "backend/mlx_manager/main.py"
      provides: "JWT secret startup warning"
      contains: "CHANGE_ME_IN_PRODUCTION"
  key_links:
    - from: "backend/mlx_manager/routers/models.py"
      to: "backend/mlx_manager/dependencies.py"
      via: "get_current_user_from_token dependency on SSE endpoint"
      pattern: "get_current_user_from_token"
    - from: "backend/mlx_manager/routers/system.py"
      to: "backend/mlx_manager/services/auth_service.py"
      via: "decode_token() called before websocket.accept()"
      pattern: "decode_token.*websocket\\.accept"
    - from: "backend/mlx_manager/routers/servers.py"
      to: "backend/mlx_manager/mlx_server/models/pool.py"
      via: "get_loaded_model() public method replaces pool._models access"
      pattern: "get_loaded_model"
---

<objective>
Implement backend auth, decoupling, and housekeeping changes for Phase 16 Architecture Compliance.

Purpose: Bring the mlx_manager backend into full compliance with ARCHITECTURE.md by fixing SSE/WebSocket auth gaps, removing deprecated endpoints, adding JWT startup warning, and eliminating private pool access from routers.

Output: Updated backend files with query-param auth, removed deprecated endpoints, JWT warning, public pool API, and passing tests.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/mlx_manager/ARCHITECTURE.md
@backend/mlx_manager/dependencies.py
@backend/mlx_manager/main.py
@backend/mlx_manager/config.py
@backend/mlx_manager/services/auth_service.py
@backend/mlx_manager/routers/models.py
@backend/mlx_manager/routers/system.py
@backend/mlx_manager/routers/servers.py
@backend/mlx_manager/mlx_server/models/pool.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add query-param auth dependency, JWT warning, and pool public method</name>
  <files>
    backend/mlx_manager/dependencies.py
    backend/mlx_manager/main.py
    backend/mlx_manager/mlx_server/models/pool.py
  </files>
  <action>
1. In `dependencies.py`, add a new `get_current_user_from_token()` async function that:
   - Accepts `token: str = Query(..., description="JWT token for SSE/WS auth")` and `session: AsyncSession = Depends(get_db)`
   - Raises HTTPException 401 on invalid/expired token or missing/unapproved user
   - Uses the same `decode_token()` from auth_service (already imported)
   - Logic is identical to `get_current_user()` but extracts token from query param instead of Authorization header
   - Add `Query` to the fastapi import

2. In `main.py` lifespan function, after `logger.info("MLX Manager starting up...")` and before `await init_db()`, add a JWT secret check:
   - Import `settings` (already available as `manager_settings`)
   - If `manager_settings.jwt_secret == "CHANGE_ME_IN_PRODUCTION_USE_ENV_VAR"`, log: `logger.warning("JWT secret is using default placeholder. Set MLX_MANAGER_JWT_SECRET for production use.")`
   - This is a warning, not a failure -- the server still starts.

3. In `mlx_server/models/pool.py`, add a public `get_loaded_model()` method to `ModelPoolManager`:
   ```python
   def get_loaded_model(self, model_id: str) -> LoadedModel | None:
       """Get a loaded model by ID, or None if not loaded.

       This is the public API for reading model metadata.
       Use get_model() for loading models on demand.
       """
       return self._models.get(model_id)
   ```
   Place it after the `is_loaded()` method (around line 556).
  </action>
  <verify>
    Run: `cd /Users/atomasini/Development/mlx-manager/backend && python -c "from mlx_manager.dependencies import get_current_user_from_token; print('OK')"` to verify import works.
    Run: `cd /Users/atomasini/Development/mlx-manager/backend && python -c "from mlx_manager.mlx_server.models.pool import ModelPoolManager; assert hasattr(ModelPoolManager, 'get_loaded_model'); print('OK')"` to verify method exists.
  </verify>
  <done>
    - `get_current_user_from_token` is importable from dependencies.py
    - `ModelPoolManager.get_loaded_model()` exists and returns `LoadedModel | None`
    - JWT secret warning is emitted in lifespan when default placeholder is used
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SSE/WS endpoints, remove deprecated endpoints, fix router decoupling</name>
  <files>
    backend/mlx_manager/routers/models.py
    backend/mlx_manager/routers/system.py
    backend/mlx_manager/routers/servers.py
  </files>
  <action>
1. In `routers/models.py`:
   a. Import `get_current_user_from_token` from dependencies (alongside existing `get_current_user`)
   b. On the SSE endpoint `get_download_progress()` (line 115-185): change the dependency from `current_user: Annotated[User, Depends(get_current_user)]` to `current_user: Annotated[User, Depends(get_current_user_from_token)]`. This makes the endpoint require `?token=<jwt>` instead of Authorization header, which is necessary because browser EventSource cannot send custom headers.
   c. DELETE the entire `get_available_parsers()` endpoint (the `@router.get("/available-parsers")` function and its decorator, lines 519-529). This endpoint is deprecated and returns empty data.

2. In `routers/system.py`:
   a. Import `decode_token` from `mlx_manager.services.auth_service`
   b. Import `select` from `sqlmodel` and `User`, `UserStatus` from `mlx_manager.models`
   c. Import `get_db` from `mlx_manager.database`
   d. Modify the `proxy_audit_log_stream()` WebSocket endpoint:
      - BEFORE `await websocket.accept()`, add token validation:
        ```python
        # Validate JWT from query parameter before accepting connection
        token = websocket.query_params.get("token")
        if not token:
            await websocket.close(code=1008)
            return

        payload = decode_token(token)
        if payload is None:
            await websocket.close(code=1008)
            return

        email: str | None = payload.get("sub")
        if not email:
            await websocket.close(code=1008)
            return

        # Validate user exists and is approved
        async with get_session() as session:
            from sqlmodel import select as sql_select
            result = await session.execute(sql_select(User).where(User.email == email))
            user = result.scalar_one_or_none()
            if user is None or user.status != UserStatus.APPROVED:
                await websocket.close(code=1008)
                return
        ```
      - Import `get_session` from `mlx_manager.database` (this is the context manager version for standalone use outside of Depends)
      - Move `await websocket.accept()` AFTER the validation block
   e. DELETE the entire `get_available_parser_options()` endpoint (the `@router.get("/parser-options")` function and its decorator, lines 122-136). This endpoint is deprecated.

3. In `routers/servers.py`:
   a. Replace all 3 occurrences of `pool._models` access with the new public method `pool.get_loaded_model()`:
      - Line 109: `loaded_model = pool._models.get(profile.model_path)` -> `loaded_model = pool.get_loaded_model(profile.model_path)`
      - Lines 190-191: `if model_id in pool._models: loaded = pool._models[model_id]` -> `loaded = pool.get_loaded_model(model_id)` then `if loaded is not None:`
      - Line 361: `loaded = pool._models.get(model_id)` -> `loaded = pool.get_loaded_model(model_id)`
  </action>
  <verify>
    Run: `cd /Users/atomasini/Development/mlx-manager/backend && ruff check mlx_manager/routers/models.py mlx_manager/routers/system.py mlx_manager/routers/servers.py mlx_manager/dependencies.py` to verify no lint errors.
    Run: `cd /Users/atomasini/Development/mlx-manager/backend && grep -n '_models' mlx_manager/routers/servers.py` should return zero results (no private access).
    Run: `cd /Users/atomasini/Development/mlx-manager/backend && grep -n 'available.parsers\|parser.options' mlx_manager/routers/models.py mlx_manager/routers/system.py` should return zero results.
  </verify>
  <done>
    - SSE endpoint uses `get_current_user_from_token` (query param auth)
    - WebSocket endpoint validates JWT before accept, closes 1008 on invalid
    - Both deprecated parser endpoints removed
    - servers.py uses `pool.get_loaded_model()` instead of `pool._models`
  </done>
</task>

<task type="auto">
  <name>Task 3: Update backend tests for auth changes and removed endpoints</name>
  <files>
    backend/tests/test_models.py
    backend/tests/test_system.py
  </files>
  <action>
1. In `tests/test_models.py`:
   a. The SSE endpoint `/api/models/download/{task_id}/progress` now requires `?token=<jwt>` instead of Authorization header. Find any tests that call this endpoint and update them to pass token as query param. If no direct SSE tests exist (likely -- SSE is hard to test with httpx), no changes needed for the SSE endpoint itself.
   b. Find and DELETE the test `test_get_available_parsers_returns_empty_list` (line 838+). This tests the removed endpoint.
   c. Verify that any other tests referencing `available-parsers` are updated or removed.

2. In `tests/test_system.py`:
   a. Find and DELETE the test `test_get_parser_options_endpoint` (line 227+). This tests the removed endpoint.
   b. Add new tests for WebSocket query-param auth. Use `httpx.ASGITransport` with `TestClient` websocket testing or test at the unit level:
      - Test: WebSocket connection without token -> closes with code 1008
      - Test: WebSocket connection with invalid token -> closes with code 1008
      - Test: WebSocket connection with valid token for unapproved user -> closes with code 1008
      Note: If Starlette's TestClient WebSocket testing is complex to set up with the existing test fixtures (auth_client uses httpx.AsyncClient), write these as focused unit tests that mock `decode_token` and test the endpoint function directly, or use the existing test patterns from the codebase.

3. Add a new test for the `get_current_user_from_token` dependency in a relevant test file:
   - Test that it raises 401 when token is missing (Query param required)
   - Test that it raises 401 when token is invalid/expired
   - This can be tested implicitly via the SSE endpoint tests, or as a unit test.

4. Ensure all existing tests still pass by running the full test suite.
  </action>
  <verify>
    Run: `cd /Users/atomasini/Development/mlx-manager/backend && source .venv/bin/activate && pytest tests/test_models.py tests/test_system.py -v --tb=short` to verify updated tests pass.
    Run: `cd /Users/atomasini/Development/mlx-manager/backend && source .venv/bin/activate && pytest -v --tb=short -x` to verify full test suite passes.
  </verify>
  <done>
    - Deprecated endpoint tests removed
    - New WebSocket auth tests added (no token, invalid token, unapproved user)
    - All existing tests pass
    - Full backend test suite green
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/atomasini/Development/mlx-manager/backend && source .venv/bin/activate && ruff check . && ruff format --check .` -- lint and format clean
2. `cd /Users/atomasini/Development/mlx-manager/backend && source .venv/bin/activate && pytest -v --tb=short -x` -- all tests pass
3. `grep -rn 'pool\._models' backend/mlx_manager/routers/` -- zero results (no private access from routers)
4. `grep -rn 'available.parsers\|parser.options' backend/mlx_manager/routers/` -- zero results (deprecated endpoints removed)
5. `grep -n 'CHANGE_ME_IN_PRODUCTION' backend/mlx_manager/main.py` -- JWT warning present in lifespan
</verification>

<success_criteria>
- get_current_user_from_token exists in dependencies.py and is used by SSE download progress endpoint
- WebSocket audit-logs validates token before accept(), closes 1008 on failure
- JWT secret placeholder triggers startup warning
- Both deprecated parser endpoints removed from routers
- servers.py uses only public pool API (get_loaded_model)
- All backend tests pass including new auth tests
</success_criteria>

<output>
After completion, create `.planning/phases/16-mlx-manager-architecture-compliance/16-01-SUMMARY.md`
</output>
