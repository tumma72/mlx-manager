---
phase: 12-production-hardening
plan: 06
type: execute
wave: 3
depends_on: ["12-03"]
files_modified:
  - frontend/src/lib/components/settings/TimeoutSettings.svelte
  - frontend/src/lib/components/settings/index.ts
  - frontend/src/routes/(protected)/settings/+page.svelte
  - backend/mlx_manager/routers/settings.py
  - frontend/src/lib/api/types.ts
  - frontend/src/lib/api/client.ts
autonomous: true

must_haves:
  truths:
    - "Settings UI displays per-endpoint timeout configuration"
    - "Timeout values are editable with validation"
    - "Changes persist and affect MLX Server behavior"
    - "UI shows current values with sensible defaults"
  artifacts:
    - path: "frontend/src/lib/components/settings/TimeoutSettings.svelte"
      provides: "Timeout configuration UI component"
    - path: "backend/mlx_manager/routers/settings.py"
      provides: "API endpoint for timeout configuration"
      contains: "timeouts"
  key_links:
    - from: "frontend/TimeoutSettings.svelte"
      to: "backend/routers/settings.py"
      via: "REST API for timeouts"
      pattern: "/api/settings/timeouts"
---

<objective>
Add timeout configuration to Settings UI

Purpose: Per CONTEXT.md, per-endpoint timeouts should be exposed in Settings UI. Users need to be able to configure Chat (15 min default), Completions (10 min), and Embeddings (2 min) timeouts.

Output: Settings page has Timeout Configuration section with per-endpoint controls
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-production-hardening/12-CONTEXT.md
@.planning/phases/12-production-hardening/12-RESEARCH.md
@backend/mlx_manager/routers/settings.py
@frontend/src/routes/(protected)/settings/+page.svelte
@frontend/src/lib/components/settings/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timeout API endpoints</name>
  <files>
    backend/mlx_manager/routers/settings.py
    frontend/src/lib/api/types.ts
    frontend/src/lib/api/client.ts
  </files>
  <action>
1. Update `backend/mlx_manager/routers/settings.py` to add timeout endpoints:
   ```python
   # Add these models at the top
   class TimeoutSettings(SQLModel):
       """Timeout configuration for MLX Server endpoints."""
       chat_seconds: float = Field(default=900.0, ge=60, le=7200)
       completions_seconds: float = Field(default=600.0, ge=60, le=7200)
       embeddings_seconds: float = Field(default=120.0, ge=30, le=600)

   class TimeoutSettingsUpdate(SQLModel):
       """Update model for timeout settings."""
       chat_seconds: float | None = Field(default=None, ge=60, le=7200)
       completions_seconds: float | None = Field(default=None, ge=60, le=7200)
       embeddings_seconds: float | None = Field(default=None, ge=30, le=600)

   # Add these endpoints
   @router.get("/timeouts", response_model=TimeoutSettings)
   async def get_timeout_settings(
       session: AsyncSession = Depends(get_db),
   ) -> TimeoutSettings:
       """Get current timeout settings.

       Returns configured timeouts or defaults if not set.
       """
       # Settings are stored as individual keys
       result = await session.execute(
           select(Setting).where(
               Setting.key.in_([
                   "timeout_chat_seconds",
                   "timeout_completions_seconds",
                   "timeout_embeddings_seconds",
               ])
           )
       )
       settings_map = {s.key: float(s.value) for s in result.scalars().all()}

       return TimeoutSettings(
           chat_seconds=settings_map.get("timeout_chat_seconds", 900.0),
           completions_seconds=settings_map.get("timeout_completions_seconds", 600.0),
           embeddings_seconds=settings_map.get("timeout_embeddings_seconds", 120.0),
       )

   @router.put("/timeouts", response_model=TimeoutSettings)
   async def update_timeout_settings(
       data: TimeoutSettingsUpdate,
       session: AsyncSession = Depends(get_db),
   ) -> TimeoutSettings:
       """Update timeout settings.

       Only provided fields are updated. Values persist in database.
       Note: MLX Server reads from environment or config file at startup,
       so changes here are stored for reference but may require restart.
       """
       updates = {
           "timeout_chat_seconds": data.chat_seconds,
           "timeout_completions_seconds": data.completions_seconds,
           "timeout_embeddings_seconds": data.embeddings_seconds,
       }

       for key, value in updates.items():
           if value is not None:
               result = await session.execute(
                   select(Setting).where(Setting.key == key)
               )
               setting = result.scalars().first()
               if setting:
                   setting.value = str(value)
                   setting.updated_at = datetime.now(tz=UTC)
               else:
                   setting = Setting(key=key, value=str(value))
                   session.add(setting)

       await session.commit()

       # Return updated settings
       return await get_timeout_settings(session)
   ```

2. Update `frontend/src/lib/api/types.ts`:
   ```typescript
   export interface TimeoutSettings {
     chat_seconds: number;
     completions_seconds: number;
     embeddings_seconds: number;
   }

   export interface TimeoutSettingsUpdate {
     chat_seconds?: number;
     completions_seconds?: number;
     embeddings_seconds?: number;
   }
   ```

3. Update `frontend/src/lib/api/client.ts`:
   ```typescript
   export async function getTimeoutSettings(): Promise<TimeoutSettings> {
     const response = await fetch('/api/settings/timeouts');
     if (!response.ok) throw new Error('Failed to fetch timeout settings');
     return response.json();
   }

   export async function updateTimeoutSettings(
     data: TimeoutSettingsUpdate
   ): Promise<TimeoutSettings> {
     const response = await fetch('/api/settings/timeouts', {
       method: 'PUT',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify(data),
     });
     if (!response.ok) throw new Error('Failed to update timeout settings');
     return response.json();
   }
   ```
  </action>
  <verify>
    - `grep "timeouts" backend/mlx_manager/routers/settings.py`
    - `grep "TimeoutSettings" frontend/src/lib/api/types.ts`
    - `grep "getTimeoutSettings" frontend/src/lib/api/client.ts`
  </verify>
  <done>Timeout API endpoints and client functions exist</done>
</task>

<task type="auto">
  <name>Task 2: Create TimeoutSettings component</name>
  <files>
    frontend/src/lib/components/settings/TimeoutSettings.svelte
    frontend/src/lib/components/settings/index.ts
  </files>
  <action>
1. Create `frontend/src/lib/components/settings/TimeoutSettings.svelte`:
   ```svelte
   <script lang="ts">
     import { onMount } from 'svelte';
     import { Clock, Save, RotateCcw } from 'lucide-svelte';
     import { Button } from '$lib/components/ui/button';
     import {
       getTimeoutSettings,
       updateTimeoutSettings,
       type TimeoutSettings
     } from '$lib/api/client';

     // State
     let settings = $state<TimeoutSettings | null>(null);
     let loading = $state(true);
     let saving = $state(false);
     let error = $state<string | null>(null);

     // Editable values (in seconds)
     let chatTimeout = $state(900);
     let completionsTimeout = $state(600);
     let embeddingsTimeout = $state(120);

     // Track if values changed
     let hasChanges = $derived(
       settings !== null && (
         chatTimeout !== settings.chat_seconds ||
         completionsTimeout !== settings.completions_seconds ||
         embeddingsTimeout !== settings.embeddings_seconds
       )
     );

     // Format seconds to human readable
     function formatSeconds(seconds: number): string {
       if (seconds < 60) return `${seconds}s`;
       if (seconds < 3600) return `${Math.round(seconds / 60)} min`;
       return `${(seconds / 3600).toFixed(1)} hr`;
     }

     // Load settings
     async function loadSettings() {
       loading = true;
       error = null;
       try {
         settings = await getTimeoutSettings();
         chatTimeout = settings.chat_seconds;
         completionsTimeout = settings.completions_seconds;
         embeddingsTimeout = settings.embeddings_seconds;
       } catch (e) {
         error = 'Failed to load timeout settings';
         console.error(e);
       } finally {
         loading = false;
       }
     }

     // Save settings
     async function saveSettings() {
       saving = true;
       error = null;
       try {
         settings = await updateTimeoutSettings({
           chat_seconds: chatTimeout,
           completions_seconds: completionsTimeout,
           embeddings_seconds: embeddingsTimeout,
         });
       } catch (e) {
         error = 'Failed to save timeout settings';
         console.error(e);
       } finally {
         saving = false;
       }
     }

     // Reset to defaults
     function resetToDefaults() {
       chatTimeout = 900;
       completionsTimeout = 600;
       embeddingsTimeout = 120;
     }

     onMount(() => {
       loadSettings();
     });
   </script>

   <div class="space-y-4">
     {#if loading}
       <div class="text-muted-foreground">Loading timeout settings...</div>
     {:else if error}
       <div class="text-red-500">{error}</div>
     {:else}
       <div class="grid gap-4">
         <!-- Chat Completions -->
         <div class="flex items-center gap-4">
           <div class="flex-1">
             <label class="block text-sm font-medium mb-1">
               Chat Completions
               <span class="text-muted-foreground font-normal ml-1">
                 (/v1/chat/completions)
               </span>
             </label>
             <div class="flex items-center gap-2">
               <input
                 type="range"
                 min="60"
                 max="7200"
                 step="60"
                 class="flex-1"
                 bind:value={chatTimeout}
               />
               <input
                 type="number"
                 min="60"
                 max="7200"
                 step="60"
                 class="w-24 px-2 py-1 border rounded text-sm"
                 bind:value={chatTimeout}
               />
               <span class="text-sm text-muted-foreground w-16">
                 {formatSeconds(chatTimeout)}
               </span>
             </div>
             <p class="text-xs text-muted-foreground mt-1">
               Default: 15 minutes. For long conversations and large models.
             </p>
           </div>
         </div>

         <!-- Completions -->
         <div class="flex items-center gap-4">
           <div class="flex-1">
             <label class="block text-sm font-medium mb-1">
               Text Completions
               <span class="text-muted-foreground font-normal ml-1">
                 (/v1/completions)
               </span>
             </label>
             <div class="flex items-center gap-2">
               <input
                 type="range"
                 min="60"
                 max="7200"
                 step="60"
                 class="flex-1"
                 bind:value={completionsTimeout}
               />
               <input
                 type="number"
                 min="60"
                 max="7200"
                 step="60"
                 class="w-24 px-2 py-1 border rounded text-sm"
                 bind:value={completionsTimeout}
               />
               <span class="text-sm text-muted-foreground w-16">
                 {formatSeconds(completionsTimeout)}
               </span>
             </div>
             <p class="text-xs text-muted-foreground mt-1">
               Default: 10 minutes. For legacy completion requests.
             </p>
           </div>
         </div>

         <!-- Embeddings -->
         <div class="flex items-center gap-4">
           <div class="flex-1">
             <label class="block text-sm font-medium mb-1">
               Embeddings
               <span class="text-muted-foreground font-normal ml-1">
                 (/v1/embeddings)
               </span>
             </label>
             <div class="flex items-center gap-2">
               <input
                 type="range"
                 min="30"
                 max="600"
                 step="30"
                 class="flex-1"
                 bind:value={embeddingsTimeout}
               />
               <input
                 type="number"
                 min="30"
                 max="600"
                 step="30"
                 class="w-24 px-2 py-1 border rounded text-sm"
                 bind:value={embeddingsTimeout}
               />
               <span class="text-sm text-muted-foreground w-16">
                 {formatSeconds(embeddingsTimeout)}
               </span>
             </div>
             <p class="text-xs text-muted-foreground mt-1">
               Default: 2 minutes. Embeddings are fast, short timeout is appropriate.
             </p>
           </div>
         </div>
       </div>

       <!-- Actions -->
       <div class="flex items-center gap-2 pt-4 border-t">
         <Button
           variant="default"
           size="sm"
           onclick={saveSettings}
           disabled={!hasChanges || saving}
         >
           <Save class="h-4 w-4 mr-1" />
           {saving ? 'Saving...' : 'Save Changes'}
         </Button>
         <Button
           variant="outline"
           size="sm"
           onclick={resetToDefaults}
           disabled={saving}
         >
           <RotateCcw class="h-4 w-4 mr-1" />
           Reset to Defaults
         </Button>
         {#if hasChanges}
           <span class="text-sm text-muted-foreground ml-2">
             Unsaved changes
           </span>
         {/if}
       </div>

       <p class="text-xs text-muted-foreground">
         Note: Changes are stored but may require restarting the MLX Server to take effect.
       </p>
     {/if}
   </div>
   ```

2. Update `frontend/src/lib/components/settings/index.ts`:
   ```typescript
   export { default as ProviderSection } from './ProviderSection.svelte';
   export { default as ModelPoolSettings } from './ModelPoolSettings.svelte';
   export { default as RoutingRulesSection } from './RoutingRulesSection.svelte';
   export { default as AuditLogPanel } from './AuditLogPanel.svelte';
   export { default as TimeoutSettings } from './TimeoutSettings.svelte';
   ```
  </action>
  <verify>
    - `ls frontend/src/lib/components/settings/TimeoutSettings.svelte`
    - `grep "TimeoutSettings" frontend/src/lib/components/settings/index.ts`
  </verify>
  <done>TimeoutSettings component exists</done>
</task>

<task type="auto">
  <name>Task 3: Integrate timeout settings into settings page</name>
  <files>
    frontend/src/routes/(protected)/settings/+page.svelte
  </files>
  <action>
Update `frontend/src/routes/(protected)/settings/+page.svelte` to add Timeout Settings section:

```svelte
<script lang="ts">
  import {
    ProviderSection,
    ModelPoolSettings,
    RoutingRulesSection,
    TimeoutSettings,
    AuditLogPanel
  } from '$lib/components/settings';
</script>

<svelte:head>
  <title>Settings | MLX Manager</title>
</svelte:head>

<div class="space-y-8">
  <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Settings</h1>

  <!-- Cloud Providers -->
  <section>
    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Cloud Providers</h2>
    <p class="text-sm text-muted-foreground mb-4">
      Configure API keys for cloud inference providers. Keys are encrypted at rest.
    </p>
    <ProviderSection />
  </section>

  <hr class="border-gray-200 dark:border-gray-700" />

  <!-- Model Pool -->
  <section>
    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Model Pool</h2>
    <p class="text-sm text-muted-foreground mb-4">
      Configure memory limits and caching behavior for the local model pool.
    </p>
    <ModelPoolSettings />
  </section>

  <hr class="border-gray-200 dark:border-gray-700" />

  <!-- Routing Rules -->
  <section>
    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Model Routing Rules</h2>
    <p class="text-sm text-muted-foreground mb-4">
      Configure model-to-backend routing rules with pattern matching. Rules are evaluated by priority (lower number = higher priority).
    </p>
    <RoutingRulesSection />
  </section>

  <hr class="border-gray-200 dark:border-gray-700" />

  <!-- Timeouts -->
  <section>
    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Request Timeouts</h2>
    <p class="text-sm text-muted-foreground mb-4">
      Configure per-endpoint timeouts for inference requests. Longer timeouts allow for larger models and longer outputs.
    </p>
    <TimeoutSettings />
  </section>

  <hr class="border-gray-200 dark:border-gray-700" />

  <!-- Audit Logs -->
  <section>
    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Request Logs</h2>
    <p class="text-sm text-muted-foreground mb-4">
      View and export inference request logs. Live updates when connected.
    </p>
    <AuditLogPanel />
  </section>
</div>
```
  </action>
  <verify>
    - `grep "TimeoutSettings" frontend/src/routes/(protected)/settings/+page.svelte`
    - `grep "Request Timeouts" frontend/src/routes/(protected)/settings/+page.svelte`
    - `cd frontend && npm run check`
  </verify>
  <done>Timeout settings integrated into settings page</done>
</task>

</tasks>

<verification>
Backend verification:
```bash
cd backend && source .venv/bin/activate
pytest tests/ -v
```

Frontend verification:
```bash
cd frontend && npm run check
npm run lint
npm test
```

Manual testing:
1. Start backend: `cd backend && uvicorn mlx_manager.main:app --port 8080`
2. Start frontend: `cd frontend && npm run dev`
3. Navigate to Settings page
4. Verify "Request Timeouts" section appears
5. Test slider and number input interaction
6. Test "Save Changes" button
7. Test "Reset to Defaults" button
8. Verify changes persist after page refresh
</verification>

<success_criteria>
- GET /api/settings/timeouts returns current timeout values
- PUT /api/settings/timeouts updates timeout values
- TimeoutSettings component shows sliders and inputs
- Values are validated (min/max constraints)
- Changes persist in database
- Reset to Defaults restores 15min/10min/2min
- Settings page includes Timeout section between Routing Rules and Audit Logs
</success_criteria>

<output>
After completion, create `.planning/phases/12-production-hardening/12-06-SUMMARY.md`
</output>
