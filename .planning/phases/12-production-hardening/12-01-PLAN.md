---
phase: 12-production-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/mlx_manager/mlx_server/config.py
  - backend/mlx_manager/mlx_server/observability/__init__.py
  - backend/mlx_manager/mlx_server/observability/logfire_config.py
  - backend/mlx_manager/mlx_server/main.py
  - backend/mlx_manager/observability/__init__.py
  - backend/mlx_manager/observability/logfire_config.py
  - backend/mlx_manager/main.py
autonomous: true
user_setup:
  - service: logfire
    why: "Request tracing and LLM metrics (optional - works in offline mode without token)"
    env_vars:
      - name: LOGFIRE_TOKEN
        source: "LogFire Dashboard -> Settings -> API Tokens -> Create Token"
    dashboard_config:
      - task: "Create a LogFire account"
        location: "https://logfire.pydantic.dev/"

must_haves:
  truths:
    - "LogFire configure() is called before any instrumentation"
    - "FastAPI requests are traced with automatic spans"
    - "HTTPX outbound calls to cloud APIs are traced"
    - "SQLAlchemy/SQLModel database queries are traced"
    - "OpenAI and Anthropic LLM calls capture token usage"
    - "LogFire works in offline mode without token (send_to_logfire='if-token-present')"
  artifacts:
    - path: "backend/mlx_manager/mlx_server/observability/logfire_config.py"
      provides: "LogFire configuration for MLX server"
      exports: ["configure_logfire"]
    - path: "backend/mlx_manager/observability/logfire_config.py"
      provides: "LogFire configuration for MLX manager"
      exports: ["configure_logfire"]
  key_links:
    - from: "mlx_server/main.py"
      to: "observability/logfire_config.py"
      via: "configure_logfire() called before app creation"
      pattern: "configure_logfire.*app.*FastAPI"
    - from: "mlx_manager/main.py"
      to: "observability/logfire_config.py"
      via: "configure_logfire() called before app creation"
      pattern: "configure_logfire.*app.*FastAPI"
---

<objective>
Expand LogFire integration to both apps with full instrumentation stack

Purpose: PROD-01 requires full request lifecycle tracing with LLM token metrics. Existing LogFire integration in mlx_server is minimal - only FastAPI. Need to add HTTPX for cloud API tracing, SQLAlchemy for database queries, and OpenAI/Anthropic for LLM token tracking. Also need to add LogFire to mlx_manager app.

Output: Both apps have centralized LogFire configuration with all instrumentations enabled
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-production-hardening/12-CONTEXT.md
@.planning/phases/12-production-hardening/12-RESEARCH.md
@backend/mlx_manager/mlx_server/main.py
@backend/mlx_manager/mlx_server/config.py
@backend/mlx_manager/main.py
@backend/mlx_manager/database.py
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LogFire extras and create observability modules</name>
  <files>
    backend/pyproject.toml
    backend/mlx_manager/mlx_server/observability/__init__.py
    backend/mlx_manager/mlx_server/observability/logfire_config.py
    backend/mlx_manager/observability/__init__.py
    backend/mlx_manager/observability/logfire_config.py
  </files>
  <action>
1. Update pyproject.toml to add httpx and sqlalchemy extras to logfire:
   - Change `logfire[fastapi]>=3.0.0` to `logfire[fastapi,httpx,sqlalchemy]>=3.0.0`

2. Create `backend/mlx_manager/mlx_server/observability/__init__.py`:
   - Empty `__init__.py` with docstring

3. Create `backend/mlx_manager/mlx_server/observability/logfire_config.py`:
   ```python
   """LogFire configuration for MLX Inference Server."""
   import logging
   from typing import TYPE_CHECKING

   import logfire

   if TYPE_CHECKING:
       from fastapi import FastAPI
       from sqlalchemy.ext.asyncio import AsyncEngine

   logger = logging.getLogger(__name__)

   _configured = False

   def configure_logfire(
       service_name: str = "mlx-server",
       service_version: str | None = None,
   ) -> None:
       """Configure LogFire with service metadata.

       MUST be called before creating FastAPI app or any instrumented clients.
       Uses send_to_logfire='if-token-present' for offline development.
       """
       global _configured
       if _configured:
           return

       logfire.configure(
           service_name=service_name,
           service_version=service_version,
           send_to_logfire="if-token-present",  # Offline mode without token
       )
       _configured = True
       logger.info(f"LogFire configured for {service_name}")

   def instrument_fastapi(app: "FastAPI") -> None:
       """Add FastAPI instrumentation for request tracing."""
       logfire.instrument_fastapi(app)
       logger.info("LogFire FastAPI instrumentation enabled")

   def instrument_httpx() -> None:
       """Add HTTPX instrumentation for outbound HTTP tracing.

       Instruments ALL httpx clients globally.
       """
       logfire.instrument_httpx()
       logger.info("LogFire HTTPX instrumentation enabled")

   def instrument_sqlalchemy(engine: "AsyncEngine") -> None:
       """Add SQLAlchemy instrumentation for database query tracing."""
       logfire.instrument_sqlalchemy(engine=engine)
       logger.info("LogFire SQLAlchemy instrumentation enabled")

   def instrument_llm_clients() -> None:
       """Add OpenAI and Anthropic instrumentation for LLM token tracking.

       Captures request duration, token usage, and exceptions.
       """
       logfire.instrument_openai()
       logfire.instrument_anthropic()
       logger.info("LogFire LLM client instrumentation enabled")
   ```

4. Create `backend/mlx_manager/observability/__init__.py`:
   - Empty `__init__.py` with docstring

5. Create `backend/mlx_manager/observability/logfire_config.py`:
   - Same pattern as mlx_server but with service_name="mlx-manager"
   - No LLM client instrumentation (manager doesn't call LLM APIs directly)
  </action>
  <verify>
    - `grep -r "logfire\[fastapi,httpx,sqlalchemy\]" backend/pyproject.toml` returns match
    - Files exist: `ls backend/mlx_manager/mlx_server/observability/logfire_config.py backend/mlx_manager/observability/logfire_config.py`
    - `python -c "from mlx_manager.mlx_server.observability.logfire_config import configure_logfire; print('OK')"`
  </verify>
  <done>LogFire configuration modules exist for both apps with all instrumentation functions</done>
</task>

<task type="auto">
  <name>Task 2: Integrate LogFire into MLX Server startup</name>
  <files>
    backend/mlx_manager/mlx_server/main.py
    backend/mlx_manager/mlx_server/config.py
  </files>
  <action>
1. Update `mlx_server/config.py` to add environment setting:
   - Add `environment: str = Field(default="development", description="Environment (development/production)")`

2. Update `mlx_server/main.py` to use centralized LogFire config:
   - Import observability module BEFORE other imports that use instrumented libraries
   - Call `configure_logfire()` FIRST, before FastAPI app creation
   - Call `instrument_fastapi(app)` after app creation
   - Call `instrument_httpx()` for cloud API tracing
   - Call `instrument_llm_clients()` for OpenAI/Anthropic token tracking
   - Remove the old inline LogFire configuration block

   Structure:
   ```python
   # At TOP of file, before other imports
   from mlx_manager.mlx_server import __version__
   from mlx_manager.mlx_server.observability.logfire_config import (
       configure_logfire,
       instrument_fastapi,
       instrument_httpx,
       instrument_llm_clients,
   )

   # Configure LogFire FIRST (before FastAPI, before httpx usage)
   configure_logfire(service_version=__version__)
   instrument_httpx()
   instrument_llm_clients()

   # ... rest of imports ...

   app = FastAPI(...)
   instrument_fastapi(app)
   ```

3. Ensure the old LogFire block at the bottom of the file is removed:
   ```python
   # REMOVE THIS BLOCK:
   if mlx_server_settings.logfire_enabled:
       try:
           import logfire
           logfire.configure(token=mlx_server_settings.logfire_token)
           ...
   ```

Note: Keep logfire_enabled and logfire_token settings for backwards compatibility, but they're now only used to control whether configure_logfire() is called.
  </action>
  <verify>
    - `python -c "from mlx_manager.mlx_server.main import app; print('OK')"`
    - `grep "configure_logfire" backend/mlx_manager/mlx_server/main.py` shows import and call
    - `grep -c "logfire.configure(token=" backend/mlx_manager/mlx_server/main.py` returns 0 (old code removed)
  </verify>
  <done>MLX Server uses centralized LogFire config with FastAPI, HTTPX, and LLM instrumentation</done>
</task>

<task type="auto">
  <name>Task 3: Integrate LogFire into MLX Manager startup</name>
  <files>
    backend/mlx_manager/main.py
    backend/mlx_manager/database.py
  </files>
  <action>
1. Update `mlx_manager/main.py` to add LogFire:
   - Import observability module at TOP of file (before logging setup is fine, but before other mlx_manager imports)
   - Call `configure_logfire()` FIRST
   - Call `instrument_httpx()` for any outbound HTTP (HuggingFace API)
   - Call `instrument_fastapi(app)` after app creation

   Structure:
   ```python
   # At module level, before FastAPI imports
   from mlx_manager.observability.logfire_config import (
       configure_logfire,
       instrument_fastapi,
       instrument_httpx,
       instrument_sqlalchemy,
   )
   from mlx_manager import __version__

   configure_logfire(service_version=__version__)
   instrument_httpx()

   # ... rest of imports and logging setup ...

   # After engine creation in database.py is loaded:
   from mlx_manager.database import engine
   instrument_sqlalchemy(engine)

   app = FastAPI(...)
   instrument_fastapi(app)
   ```

2. Since database.py creates the engine at module level, and we need to instrument it, add the SQLAlchemy instrumentation after the database import. The engine is created when database.py is imported.

Note: Be careful with import order. The observability imports should come early, but after `mlx_manager` package is importable.
  </action>
  <verify>
    - `python -c "from mlx_manager.main import app; print('OK')"`
    - `grep "configure_logfire" backend/mlx_manager/main.py` shows import and call
    - `grep "instrument_sqlalchemy" backend/mlx_manager/main.py` shows SQLAlchemy instrumentation
  </verify>
  <done>MLX Manager uses centralized LogFire config with FastAPI, HTTPX, and SQLAlchemy instrumentation</done>
</task>

</tasks>

<verification>
Run the test suite to ensure no regressions:
```bash
cd backend && source .venv/bin/activate
pytest tests/mlx_server/ -v
pytest tests/ -v --ignore=tests/mlx_server/
```

Verify LogFire warnings are suppressed in test output (already configured in pyproject.toml filterwarnings).

Start the server and check logs for LogFire initialization:
```bash
cd backend && python -c "
from mlx_manager.mlx_server.main import app
from mlx_manager.main import app as manager_app
print('Both apps imported successfully with LogFire')
"
```
</verification>

<success_criteria>
- pyproject.toml has `logfire[fastapi,httpx,sqlalchemy]>=3.0.0`
- Both apps have observability modules with configure_logfire() functions
- MLX Server instruments FastAPI, HTTPX, and OpenAI/Anthropic
- MLX Manager instruments FastAPI, HTTPX, and SQLAlchemy
- LogFire works without token (offline mode for development)
- No test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/12-production-hardening/12-01-SUMMARY.md`
</output>
